
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0B1220" />
    <link rel="manifest" href="manifest.webmanifest" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Quiet Habits — Calm Habit System</title>
  <style>
    :root{
      --bg:#0B1220;
      --panel:#111B2E;
      --panel2:#0F1729;
      --card:#121E34;
      --text:#EAF0FF;
      --muted:#A9B6D6;
      --muted2:#7E8AA8;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.14);
      --good:#29D39A;
      --good-strong:#1fe2a4;
      --warn:#FFC247;
      --bad:#FF5A6A;
      --accent:#7AA7FF;
      --accent2:#B6C9FF;
      --celebrate:#6CFFB1;
      --celebrate-2:#7AA7FF;
      --celebrate-3:#FFE38A;
      --focus:rgba(122,167,255,.35);
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius: 16px;
      --radius2: 20px;
      --pad: 14px;
      --tap: 44px;
      --max: 960px;
      --today-offset: 96px;
      --safe-b: env(safe-area-inset-bottom, 0px);
      --safe-t: env(safe-area-inset-top, 0px);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);

      color:var(--text);
      line-height:1.5;
      overflow-x:hidden; /* hard stop for horizontal scroll */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

body::before{
  content:"";
  position: fixed;
  inset: 0;
  z-index: -1;
  pointer-events: none;
  background:
    radial-gradient(1200px 800px at 20% -10%, rgba(122,167,255,.18), transparent 55%),
    radial-gradient(900px 700px at 110% 10%, rgba(41,211,154,.10), transparent 60%),
    var(--bg);
  transform: translateZ(0);
}

body::after{
  content:"";
  position: fixed;
  inset: 0;
  z-index: -1;
  pointer-events: none;
  background:
    repeating-linear-gradient(
      0deg,
      rgba(255,255,255,.018),
      rgba(255,255,255,.018) 1px,
      rgba(0,0,0,0) 2px,
      rgba(0,0,0,0) 6px
    );
  opacity: .25;
}


    a{ color:var(--accent); text-decoration:none; }
    a:focus{ outline:2px solid var(--focus); outline-offset:2px; border-radius:12px; }

    .app{
      min-height:100%;
      display:flex;
      flex-direction:column;
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      background: linear-gradient(to bottom, rgba(11,18,32,.95), rgba(11,18,32,.70));
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--line);
    }

    .topbar{
      max-width:var(--max);
      margin:0 auto;
      padding: calc(12px + var(--safe-t)) var(--pad) 10px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }

    .brand{
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .brand .title{
      font-weight:800;
      letter-spacing:.2px;
      font-size:16px;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand .subtitle{
      font-size:12px;
      color:var(--muted);
      margin-top:3px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      border-radius:999px;
      padding:8px 10px;
      min-height:var(--tap);
      color:var(--text);
      font-size:13px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    .pill strong{ font-weight:800; }
    .pill .dot{
      width:8px; height:8px; border-radius:999px; background:var(--accent);
      box-shadow:0 0 0 3px rgba(122,167,255,.18);
      flex:0 0 auto;
    }

    main{
      flex:1;
      max-width:var(--max);
      width:100%;
      margin:0 auto;
      padding: 14px var(--pad) calc(90px + var(--safe-b)); /* bottom nav space */
    }

    .section{
      display:none;
      animation: fadeIn .14s ease-out;
    }
    .section.active{ display:block; }

    @keyframes fadeIn{
      from{ opacity:.55; transform: translateY(2px); }
      to{ opacity:1; transform: translateY(0); }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card + .card{ margin-top:12px; }

    .heroCard{
      background:
        radial-gradient(120% 140% at 0% 0%, rgba(122,167,255,.18), rgba(18,30,52,.10)),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-color: rgba(122,167,255,.35);
    }
    .guidedCard{
      background:
        radial-gradient(120% 140% at 0% 0%, rgba(122,167,255,.22), rgba(18,30,52,.22)),
        linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
    }

    .cardHeader{
      padding: 14px 14px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.00));
    }

    .cardHeader .left{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .cardHeader .right{
      display:flex;
      gap:8px;
      align-items:center;
      flex:0 0 auto;
    }

    .hTitle{
      font-weight:850;
      font-size:16px;
      line-height:1.2;
      margin:0;
      word-break:break-word;
    }
    .hMeta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      color:var(--muted);
      font-size:12px;
    }
    .hMetaWide .hSub{
      flex:1 1 240px;
      min-width:220px;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      font-weight:700;
      font-size:12px;
      white-space:nowrap;
    }
    .tag.good{ border-color: rgba(41,211,154,.35); background: rgba(41,211,154,.10); }
    .tag.bad{ border-color: rgba(255,90,106,.35); background: rgba(255,90,106,.10); }
    .tag.muted{ color: var(--muted); font-weight:650; }

    button{
      appearance:none;
      border:none;
      background:none;
      color:inherit;
      font:inherit;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding: 10px 12px;
      min-height: var(--tap);
      border-radius: 14px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight:800;
      font-size:14px;
      user-select:none;
      width:auto;
      max-width:100%;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(122,167,255,.45);
      background: linear-gradient(180deg, rgba(122,167,255,.26), rgba(122,167,255,.14));
    }
    .btn.danger{
      border-color: rgba(255,90,106,.50);
      background: linear-gradient(180deg, rgba(255,90,106,.22), rgba(255,90,106,.10));
    }
    .btn.ghost{
      border-color: var(--line);
      background: transparent;
    }
    .btn.small{
      min-height: var(--tap);
      padding: 8px 10px;
      font-size: 13px;
      border-radius: 12px;
    }
    .btn.iconButton{
      min-width: var(--tap);
      padding: 8px;
      font-size: 16px;
    }
    .btn.wide{ width:100%; }

    @keyframes btnPulse{
      0%{ transform: scale(1); }
      35%{ transform: scale(1.04); }
      100%{ transform: scale(1); }
    }
    .btn.pulse{
      animation: btnPulse .28s ease-out;
    }

    /* Insights range segmented control */
    .seg{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .segBtn{
      min-height: var(--tap);
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-weight: 900;
      font-size: 12px;
      letter-spacing: .2px;
    }
    .segBtn.active{
      background: rgba(122,167,255,.14);
      border-color: rgba(122,167,255,.34);
    }
    .segBtn:active{
      transform: translateY(1px);
    }
    .rangeHint{
      margin-top:6px;
    }


    /* Recent logs toggle header */
    .secHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:12px;
    }
    .secHead .sectionTitle{
      margin:0;
    }
    .recentBody{
      margin-top:10px;
    }

    .sectionTitle{
      font-weight:900;
      font-size:13px;
      letter-spacing:.2px;
    }


    .btn:focus{
      outline:2px solid var(--focus);
      outline-offset:2px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      min-width:0;
    }

    .grid{
      display:grid;
      gap:12px;
    }
    .grid.two{
      grid-template-columns: 1fr;
    }
    @media (min-width: 520px){
      .grid.two{
        grid-template-columns: 1fr 1fr;
      }
    }

    .content{
      padding: 14px;
    }

    .hr{
      height:1px;
      background: var(--line);
      margin: 12px 0;
    }

    .muted{ color: var(--muted); }
    .muted2{ color: var(--muted2); }
    .small{ font-size: 12px; }
    .tiny{ font-size: 11px; }
    .sr-only{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }

    /* Forms */
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    label{
      font-size:12px;
      font-weight:800;
      color:var(--accent2);
      letter-spacing:.2px;
    }
    .wizard label{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .infoIcon{
      width:18px;
      height:18px;
      border-radius:999px;
      border:1px solid rgba(122,167,255,.45);
      background: rgba(122,167,255,.12);
      color: var(--accent2);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      font-weight:800;
      line-height:1;
      position:relative;
      flex:0 0 auto;
    }
    .infoIcon::after{
      content: attr(data-info);
      position:absolute;
      bottom: calc(100% + 10px);
      left:50%;
      transform: translateX(-50%) translateY(4px);
      min-width:180px;
      max-width:260px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line2);
      background: rgba(11,18,32,.98);
      color: var(--text);
      font-size:12px;
      font-weight:600;
      line-height:1.35;
      text-align:left;
      box-shadow: var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: opacity .15s ease, transform .15s ease;
      z-index:20;
      white-space:normal;
    }
    .infoIcon::before{
      content:"";
      position:absolute;
      bottom: calc(100% + 4px);
      left:50%;
      transform: translateX(-50%) translateY(4px);
      width:10px;
      height:10px;
      background: rgba(11,18,32,.98);
      border-left:1px solid var(--line2);
      border-top:1px solid var(--line2);
      rotate:45deg;
      opacity:0;
      transition: opacity .15s ease, transform .15s ease;
      z-index:19;
    }
    .infoIcon:hover::after,
    .infoIcon:focus::after,
    .infoIcon:hover::before,
    .infoIcon:focus::before{
      opacity:1;
      transform: translateX(-50%) translateY(0);
    }
    input, textarea, select{
      width:100%;
      max-width:100%;
      min-height: var(--tap);
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line2);
      background: rgba(11,18,32,.45);
      color: var(--text);
      outline:none;
      font-size: 14px;
    }
    textarea{ min-height: 92px; resize: vertical; }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(122,167,255,.55);
      box-shadow: 0 0 0 4px rgba(122,167,255,.12);
    }
    input::placeholder, textarea::placeholder{ color: rgba(169,182,214,.65); }
    .help{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    .inline{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
      min-width:0;
    }
.inline > .field{ flex: 1 1 160px; min-width: 0; }
.inline > .field.compact{ flex: 1 1 150px; min-width: 0; }
.inline > .field.compact2{ flex: 1 1 170px; min-width: 0; }

    .error{
      border:1px solid rgba(255,90,106,.45);
      background: rgba(255,90,106,.10);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 13px;
      line-height:1.35;
    }
    .success{
      border:1px solid rgba(41,211,154,.45);
      background: rgba(41,211,154,.10);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 13px;
      line-height:1.35;
    }

    /* Habit list */
    .habitsHero{
      position:relative;
      overflow:hidden;
    }
    .todayCardHeader{
      gap:16px;
      align-items:center;
      flex-wrap:wrap;
    }
    .todayCardHeader #todayHeaderSummary{
      flex: 1 1 100%;
    }
    .todayCardHeader #todayHeaderSummary:empty{
      display:none;
    }
    .todayCardHeader .right{
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .todayCardHeader .btn{
      white-space:nowrap;
    }
    .habitList{
      padding: 8px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .habitItem{
      position:relative;
      border:1px solid var(--line);
      border-radius: 18px;
      background: rgba(255,255,255,.03);
      overflow:hidden;
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      cursor:pointer;
      transition: border-color .2s ease, box-shadow .2s ease, transform .2s ease;
      isolation:isolate;
    }
    .habitItem::before{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(120% 120% at 0% 0%, rgba(122,167,255,.12), transparent 60%);
      opacity:.6;
      z-index:-1;
    }
    .habitItem.completed{
      border-color: rgba(41,211,154,.65);
      background:
        linear-gradient(135deg, rgba(41,211,154,.18), rgba(122,167,255,.16)),
        rgba(15,23,41,.6);
      box-shadow: 0 16px 30px rgba(15,255,198,.12);
    }
    .habitItem.completed::before{
      background:
        radial-gradient(120% 120% at 0% 0%, rgba(108,255,177,.35), transparent 60%),
        radial-gradient(90% 120% at 100% 20%, rgba(122,167,255,.28), transparent 65%);
      opacity:.9;
    }
    .habitItem:hover{
      border-color: rgba(122,167,255,.35);
      box-shadow: 0 14px 28px rgba(0,0,0,.2);
      transform: translateY(-1px);
    }
    .habitItem:focus-visible{
      outline: 2px solid var(--focus);
      outline-offset: 2px;
    }
    .habitTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
    }
    .habitInfo{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .habitTitleRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .habitName{
      font-weight:950;
      font-size:16px;
      line-height:1.2;
      word-break:break-word;
    }
    .habitDesc{
      color: var(--muted);
      font-size:11px;
      line-height:1.4;
      display:-webkit-box;
      -webkit-box-orient: vertical;
      line-clamp:2;
      overflow:hidden;
    }
    .habitActions{
      flex:0 0 auto;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-end;
    }
    .habitStatusIcon{
      width:32px;
      height:32px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      font-size:16px;
      font-weight:900;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--muted2);
    }
    .habitItem.completed .habitStatusIcon{
      border-color: rgba(41,211,154,.6);
      background: rgba(41,211,154,.2);
      color: var(--celebrate);
      box-shadow: 0 0 18px rgba(41,211,154,.25);
    }
    .habitStatusPill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:900;
      letter-spacing:.2px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted2);
      text-transform: uppercase;
    }
    .habitStatusPill.done{
      border-color: rgba(41,211,154,.6);
      background: rgba(41,211,154,.2);
      color: #ddfff1;
    }
    .habitMetaRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-size:11px;
      color: var(--muted2);
      font-weight:800;
    }
    .habitMetaRow .chev{
      color: var(--accent2);
      font-weight:900;
    }
    .habitProgress{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .habitProgress .sumProgressStrip{
      flex:1 1 auto;
    }
    .habitProgressLabel{
      font-size:10px;
      font-weight:800;
      color: var(--muted2);
      white-space:nowrap;
    }
    .habitItem.completed .habitProgressLabel{
      color: #d9fff0;
    }

    /* Completion celebration */
    @keyframes habitCelebrate{
      0%{ transform: scale(1); box-shadow: 0 0 0 rgba(41,211,154,0); }
      35%{ transform: scale(1.015); box-shadow: 0 0 0 8px rgba(41,211,154,.25); }
      100%{ transform: scale(1); box-shadow: 0 0 0 rgba(41,211,154,0); }
    }
    @keyframes habitSheen{
      0%{ opacity:0; transform: translateX(-40%) skewX(-8deg); }
      35%{ opacity:.45; }
      100%{ opacity:0; transform: translateX(40%) skewX(-8deg); }
    }
    .habitItem.celebrate{
      animation: habitCelebrate .55s ease-out;
    }
    .habitItem.celebrate::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(110deg, transparent, rgba(122,167,255,.35), rgba(41,211,154,.35), transparent);
      mix-blend-mode: screen;
      animation: habitSheen .6s ease-out;
      pointer-events:none;
      z-index:1;
    }

    /* Dashboard bar: keep pill shape, but inset by summary padding (already) */
    .dashMini{
      width:100%;
      min-width:0;
    }
    .dashMini .bar{
      width:100%;
      height:14px;
      margin-top:0;
    }

    /* Full-width summary progress strip */
    .sumProgressStrip{
      width:100%;
      height:8px;
      background: rgba(255,255,255,.08);
      border-top: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }

    .sumProgressFill{
      height:100%;
      width: calc(var(--p, 0) * 100%);
      background: linear-gradient(90deg, rgba(41,211,154,.90), rgba(122,167,255,.80));
      transition: width .35s ease;
      position:relative;
    }

    .sumProgressFill::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,0));
     opacity:.45;
   
    }

    .habitItem.completed .sumProgressStrip{
      background: rgba(41,211,154,.16);
      border-top: 1px solid rgba(41,211,154,.3);
    }
    .habitItem.completed .sumProgressFill{
      background: linear-gradient(90deg, rgba(41,211,154,.95), rgba(108,255,177,.9), rgba(122,167,255,.8));
    }

    .detailsBody{
      padding: 16px;
      display:flex;
      flex-direction:column;
      gap:16px;
      border-top:1px solid var(--line);
      overflow-x:hidden;
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (min-width: 520px){
      .stats{
        grid-template-columns: repeat(4, 1fr);
      }
    }
    .stat{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 10px;
      min-width:0;
    }
    .stat .k{ font-size:11px; color: var(--muted2); font-weight:800; letter-spacing:.2px; }
    .stat .v{ font-size:14px; font-weight:900; margin-top:6px; line-height:1.15; word-break:break-word; }
    .stat .s{ font-size:11px; color: var(--muted); margin-top:4px; line-height:1.2; }

    /* Progress bar */
    .progressWrap{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 12px;
      overflow:hidden;
    }
    .progressTop{
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      align-items:baseline;
    }
    .progressTop .label{
      font-weight:900;
      letter-spacing:.2px;
      font-size:13px;
    }
    .progressTop .meta{
      font-size:12px;
      color: var(--muted);
      font-weight:700;
    }
    .bar{
      margin-top:10px;
      height:16px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > .fill{
      height:100%;
      width: calc(var(--p, 0) * 100%);
      border-radius:999px;
      background: linear-gradient(90deg,
        rgba(41,211,154,.85),
        rgba(122,167,255,.75)
      );
      box-shadow: 0 12px 24px rgba(41,211,154,.10);
      transition: width .35s ease;
      position:relative;
    }
    .bar > .fill::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,0));
      opacity:.55;
    }
    .progressMsg{
      margin-top:10px;
      font-size:12px;
      color: var(--muted);
      line-height:1.5;
    }

/* Dashboard quick-check row */
.dashRow{
  display:flex;
  gap:10px;
  align-items:center;
  margin-top:10px;
}
.dashMini{
  flex:1 1 auto;
  min-width:0;
}
.dashMiniTop{
  display:flex;
  justify-content:space-between;
  gap:10px;
  margin-bottom:6px;
}
.dashMini .bar{
  height:14px;
}
.dashBtn{
  flex:0 0 auto;
  white-space:nowrap;
}

.countControls{
  display:flex;
  align-items:center;
  gap:6px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.04);
  border-radius:999px;
  padding:4px 6px;
}
.countValue{
  min-width:42px;
  text-align:center;
  font-size:12px;
  font-weight:800;
  color: var(--text);
}

/* Satisfying completion pulse */
@keyframes dashPop{
  0%{ transform: scale(1); }
  40%{ transform: scale(1.02); }
  100%{ transform: scale(1); }
}
@keyframes dashShine{
  0%{ transform: translateX(-80px); opacity:0; }
  20%{ opacity:.55; }
  100%{ transform: translateX(380px); opacity:0; }
}
.dashMini.celebrate{
  animation: dashPop .35s ease-out;
}
.dashMini.celebrate .sumProgressFill::before{
  content:"";
  position:absolute;
  top:0; bottom:0;
  width:60px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent);
  opacity:0;
  animation: dashShine .75s ease-out;
}


    /* Tabs inside habit */
    .detailsBody{
      position:relative;
      --subtabs-sticky-top: 0px;
    }
    .subtabs{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:8px;
      border:1px solid var(--line);
      background: rgba(11,18,32,.92);
      padding:8px;
      border-radius: 16px;
      position:sticky;
      top: var(--subtabs-sticky-top);
      z-index:7;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 20px rgba(0,0,0,.22);
      width:100%;
    }
    .subtabsFooter{
      position:static;
      box-shadow:none;
      background: rgba(11,18,32,.88);
      border-radius: 18px;
    }
    .detailTitleBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(17,27,46,.7);
      margin: 12px 0 0;
      font-weight:900;
      letter-spacing:.2px;
    }
    .detailTitleBar span{
      font-size:13px;
    }
    .detailPanels{
      padding-top:12px;
    }
    .detailPanels .panel{
      background: rgba(17,27,46,.78);
      border-color: rgba(255,255,255,.16);
    }
    .tabBtn{
      min-height: 48px;
      padding: 6px 4px;
      border-radius: 14px;
      border:1px solid transparent;
      background: transparent;
      font-weight:800;
      font-size:11px;
      color: var(--muted);
      text-align:center;
      user-select:none;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      letter-spacing:.2px;
      transition: background .15s ease, color .15s ease, border-color .15s ease;
    }
    .tabBtn span{
      line-height:1.1;
    }
    .tabBtn .tabIcon{
      width:18px;
      height:18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .tabBtn svg{
      width:18px;
      height:18px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    .tabBtn.active{
      background: rgba(122,167,255,.16);
      border-color: rgba(122,167,255,.35);
      color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(122,167,255,.15);
    }
    .panel{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 18px;
      padding: 14px;
      min-width:0;
      overflow-wrap:anywhere;
    }
    .panel.hidden{ display:none; }

    .summaryCard{
      border:1px solid var(--line);
      background: rgba(17,27,46,.78);
      border-color: rgba(255,255,255,.16);
      border-radius: 18px;
      padding: 14px;
      min-width:0;
      overflow-wrap:anywhere;
      box-shadow: 0 12px 28px rgba(0,0,0,.25);
    }
    .summaryHeader{
      display:flex;
      flex-wrap:wrap;
      gap:10px 14px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .summaryHeader > *{
      min-width:0;
    }
    .summaryLabel{
      font-size:11px;
      color: var(--muted2);
      font-weight:800;
      letter-spacing:.2px;
      text-transform: uppercase;
    }
    .summaryValue{
      font-weight:800;
      font-size:14px;
      margin-top:6px;
      line-height:1.45;
    }
    .summaryMeta{
      font-size:12px;
      color: var(--muted);
      font-weight:700;
      line-height:1.4;
    }
    .summaryAction{
      margin-top:12px;
      padding:10px;
      border-radius:14px;
      background: rgba(122,167,255,.08);
      border:1px solid rgba(122,167,255,.18);
    }
    .summaryPills{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap:10px;
      margin-top:12px;
    }
    .pillStat{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding: 10px;
      min-width:0;
    }
    .pillStat .k{ font-size:11px; color: var(--muted2); font-weight:800; letter-spacing:.2px; }
    .pillStat .v{ font-size:14px; font-weight:900; margin-top:6px; line-height:1.15; }
    .pillStat .s{ font-size:11px; color: var(--muted); margin-top:4px; line-height:1.2; }

    .wizard{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .wizardHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .wizardHeader .step{
      font-size:12px;
      font-weight:800;
      color: var(--muted2);
      letter-spacing:.2px;
      text-transform: uppercase;
    }
    .wizardProgress{
      height:6px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
    }
    .wizardProgress .fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(122,167,255,.8), rgba(41,211,154,.8));
      transition: width .2s ease;
    }
    .wizardCard{
      border:1px solid var(--line);
      background: rgba(17,27,46,.72);
      border-color: rgba(255,255,255,.16);
      border-radius: 18px;
      padding: 12px;
    }
    .wizardRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .wizardRow .btn{ flex:1 1 120px; }
    .wizardHint{
      font-size:12px;
      color: var(--muted);
      line-height:1.4;
    }
    .wizardPreview{
      border:1px dashed rgba(255,255,255,.2);
      padding:12px;
      border-radius:14px;
      background: rgba(17,27,46,.6);
    }
    .wizardFooter{
      display:flex;
      gap:10px;
    }
    .wizardFooter .btn{ flex:1 1 auto; }
    .stepTags{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    /* Chart */
    .chartWrap{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 18px;
      padding: 12px;
      overflow:hidden;
    }
    .chartHead{
      display:flex;
      gap:10px;
      align-items:baseline;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .chartHead .t{
      font-weight:900;
      font-size:13px;
      letter-spacing:.2px;
    }
    .legend{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      color: var(--muted);
      font-size:11px;
      font-weight:800;
    }
    .leg{
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .swatch{
      width:12px; height:6px; border-radius:999px;
      background: rgba(255,255,255,.30);
      border:1px solid rgba(255,255,255,.20);
    }
    .swatch.actual{ background: rgba(41,211,154,.85); border-color: rgba(41,211,154,.35); }
    .swatch.plan{ background: rgba(122,167,255,.85); border-color: rgba(122,167,255,.35); }
    .swatch.dots{ background: rgba(255,255,255,.0); border-color: rgba(255,255,255,.35); }

    .barChart{
      display:grid;
      grid-template-columns: auto 1fr;
      gap:12px;
      align-items:stretch;
      margin-top:12px;
    }
    .barChartAxis{
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      font-size:11px;
      font-weight:800;
      color: var(--muted2);
      line-height:1.2;
    }
    .barChartPlot{
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:0;
    }
    .barChartCanvas{
      position:relative;
      height:140px;
      border-left:1px solid var(--line);
      border-bottom:1px solid var(--line);
      padding: 8px 6px 6px;
      display:grid;
      align-items:end;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap:10px;
      background: rgba(255,255,255,.02);
      border-radius: 12px;
      overflow:hidden;
    }
    .barChartBar{
      width:100%;
      border-radius: 10px 10px 6px 6px;
      background: linear-gradient(180deg, rgba(122,167,255,.85), rgba(41,211,154,.75));
      border:1px solid rgba(255,255,255,.16);
      min-height:6px;
      box-shadow: 0 10px 16px rgba(0,0,0,.12);
    }
    .barChartLabels{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap:10px;
      font-size:11px;
      font-weight:800;
      color: var(--muted2);
      text-align:center;
    }
    .barChartAxisLabel{
      margin-top:6px;
      font-size:11px;
      color: var(--muted);
      font-weight:800;
      text-align:center;
      letter-spacing:.2px;
    }

    .frictionCard{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 18px;
      padding: 14px;
    }
    .frictionHead{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .frictionHead .btn{
      min-width: 34px;
      padding: 6px 10px;
      font-weight: 900;
    }
    .frictionList{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }
    .frictionItem{
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .frictionItem .btn{
      flex:0 0 auto;
      min-width: 34px;
      padding: 6px 10px;
      font-weight: 900;
    }
    .frictionItem input{
      flex:1 1 auto;
      min-width:0;
    }

    /* Bottom nav */
    .nav{
      position:fixed;
      left:0; right:0; bottom:0;
      z-index:20;
      padding: 10px var(--pad) calc(10px + var(--safe-b));
      background: linear-gradient(to top, rgba(11,18,32,.92), rgba(11,18,32,.70));
      backdrop-filter: blur(12px);
      border-top: 1px solid var(--line);
    }
    .navInner{
      max-width:var(--max);
      margin:0 auto;
      display:flex;
      gap:10px;
    }
    .navBtn{
      flex:1 1 0;
      min-height: var(--tap);
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      padding: 8px 10px;
      color: var(--muted);
      font-weight:900;
      font-size:12px;
      user-select:none;
      text-align:center;
    }
    .navBtn.active{
      color: var(--text);
      border-color: rgba(122,167,255,.30);
      background: rgba(122,167,255,.12);
    }

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      z-index:50;
      background: rgba(0,0,0,.52);
      backdrop-filter: blur(6px);
      padding: 14px;
      padding-bottom: calc(14px + var(--safe-b));
    }
    .modal.active{ display:flex; align-items:flex-end; justify-content:center; }
    .modal.centered{ align-items:center; }
    .sheet{
      width:100%;
      max-width: 720px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--line2);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sheetHead{
      padding: 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .sheetHead .h{
      font-weight:950;
      font-size:15px;
      margin:0;
    }
    .sheetBody{
      padding: 14px;
      max-height: min(70vh, 560px);
      overflow:auto;
      overflow-x:hidden;
      position:relative;
    }
    .sheetBody textarea{
      min-height: 260px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height:1.35;
    }
    .sheetFoot{
      padding: 14px;
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: calc(88px + var(--safe-b));
      z-index:60;
      width: min(520px, calc(100% - 28px));
      display:none;
    }
    .toast.active{ display:block; }
    .toast .tcard{
      border-radius: 18px;
      border:1px solid var(--line2);
      background: rgba(17,27,46,.92);
      box-shadow: var(--shadow);
      padding: 12px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .toast .icon{
      width:36px;
      height:36px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      background: rgba(122,167,255,.14);
      border:1px solid rgba(122,167,255,.25);
      flex:0 0 auto;
    }
    .toast .msg{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .toast .msg .a{
      font-weight:950;
      font-size:13px;
      line-height:1.25;
    }
    .toast .msg .b{
      color: var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    .cardFooter{
      padding: 12px 14px 14px;
      border-top:1px solid var(--line);
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      background: rgba(255,255,255,.02);
    }

    /* Create Habit accordion */
    .createWrap{
      border-radius: var(--radius2);
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      overflow:hidden;
      margin-bottom: 12px;
    }
    .createHead{
      padding: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .createActions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .createTitle{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .createTitle .t{
      font-weight:950;
      font-size:15px;
      margin:0;
    }
    .createTitle .s{
      margin:0;
      color: var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .createBody{
      padding: 14px;
      border-top:1px solid var(--line);
      display:none;
    }
    .createWrap.open .createBody{ display:block; }

    .createInline{
      margin: 12px 14px 0;
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(255,255,255,.02);
      overflow:hidden;
    }
    .createInlineBody{
      padding: 12px;
      display:none;
    }
    .createInline.open .createInlineBody{ display:block; }

    .quickCreate{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .dashboardStack{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .todayCard{
      border-color: rgba(122,167,255,.28);
      box-shadow: 0 12px 24px rgba(0,0,0,.22);
      position: sticky;
      top: calc(var(--today-offset) + var(--safe-t));
      z-index: 8;
      background: linear-gradient(180deg, rgba(17,27,46,.92), rgba(11,18,32,.86));
      backdrop-filter: blur(14px);
    }
    .todayCard.done{
      border-color: rgba(41,211,154,.55);
      box-shadow: 0 14px 28px rgba(15,255,198,.18);
    }
    .todayCardBody{
      padding: 14px;
    }
    .todayProgressMeta{
      font-size:11px;
      font-weight:800;
      color: var(--muted2);
      white-space:nowrap;
    }

    .habitsHeader{
      padding-bottom:6px;
    }
    .habitsActions{
      display:grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
      gap:10px;
      padding: 10px 12px 12px;
      align-items:center;
    }
    .habitsActions .btn{
      min-height:36px;
      padding: 6px 12px;
      font-size:13px;
      width:100%;
      justify-content:center;
    }

    .todaySummary{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
    }
    .todaySummaryInfo{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .todaySummaryRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .todaySummaryTitle{
      font-weight:900;
      font-size:13px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .todaySummaryMeta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      font-size:11px;
    }
    .todaySummaryActions{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
    }
    .todaySummaryActions .btn{
      min-height:36px;
      padding: 6px 10px;
      font-size:13px;
    }
    .todayProgressRow{
      display:flex;
      align-items:center;
      gap:12px;
      width:100%;
    }
    .todayProgressRow .todayMeter{
      flex:1 1 auto;
      margin:0;
    }
    .todayMeter{
      width:100%;
      border-radius:999px;
      height:10px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      position:relative;
    }
    .todayMeterFill{
      height:100%;
      width: calc(var(--p, 0) * 100%);
      background: linear-gradient(90deg, rgba(41,211,154,.95), rgba(108,255,177,.9), rgba(122,167,255,.8));
      transition: width .4s ease;
    }
    .todayMeterLabel{
      font-size:11px;
      color: var(--muted2);
      font-weight:800;
      letter-spacing:.2px;
    }
    .todayCard.done .todayMeter{
      background: rgba(41,211,154,.18);
      border-color: rgba(41,211,154,.35);
    }
    @keyframes todayMeterGlow{
      0%{ box-shadow: 0 0 0 rgba(41,211,154,0); }
      45%{ box-shadow: 0 0 0 6px rgba(41,211,154,.3); }
      100%{ box-shadow: 0 0 0 rgba(41,211,154,0); }
    }
    .todayCard.done .todayMeter{
      animation: todayMeterGlow .6s ease-out;
    }
    @keyframes todayGlow{
      0%{ box-shadow: 0 0 0 rgba(41,211,154,0); }
      35%{ box-shadow: 0 0 0 6px rgba(41,211,154,.25); }
      100%{ box-shadow: 0 0 0 rgba(41,211,154,0); }
    }
    .todayCard.celebrate{
      animation: todayGlow .6s ease-out;
    }

    @keyframes iconSparkle{
      0%{ transform: scale(1); box-shadow: 0 0 0 rgba(122,167,255,0); }
      40%{ transform: scale(1.08); box-shadow: 0 0 0 6px rgba(122,167,255,.25); }
      100%{ transform: scale(1); box-shadow: 0 0 0 rgba(122,167,255,0); }
    }
    .habitStatusIcon.sparkle{
      animation: iconSparkle .6s ease-out;
    }

    .focusItem{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding: 10px;
      border-radius: 16px;
      background: rgba(17,27,46,.7);
      border-color: rgba(255,255,255,.14);
      position: relative;
      transition: border-color .2s ease, box-shadow .2s ease, background .2s ease, opacity .2s ease;
    }
    .focusItem.completed{
      opacity:1;
      border-color: rgba(41,211,154,.6);
      background:
        linear-gradient(135deg, rgba(41,211,154,.16), rgba(122,167,255,.14)),
        rgba(15,23,41,.6);
      box-shadow: 0 14px 26px rgba(15,255,198,.12);
    }
    .focusItem.completed::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius: inherit;
      background:
        radial-gradient(120% 120% at 0% 0%, rgba(108,255,177,.28), transparent 60%),
        radial-gradient(90% 120% at 100% 20%, rgba(122,167,255,.22), transparent 65%);
      opacity:.9;
      pointer-events:none;
    }
    .focusItem.completed .focusTitle{
      color: var(--text);
    }
    .focusItem.completed .focusMeta{
      color: var(--muted2);
    }
    .focusItem.completed .sumProgressStrip{
      background: rgba(41,211,154,.16);
      border-top: 1px solid rgba(41,211,154,.3);
    }
    .focusItem.completed .sumProgressFill{
      background: linear-gradient(90deg, rgba(41,211,154,.95), rgba(108,255,177,.9), rgba(122,167,255,.8));
    }
    .focusRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .focusMain{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:4px;
       flex:1 1 auto;
    }
    .focusTitle{
      font-weight:950;
      line-height:1.2;
      font-size:14px;
    }
    .focusMeta{
      font-size:11px;
      color: var(--muted2);
      font-weight:800;
    }
    .focusHint{
      font-size:11px;
      color: var(--muted);
    }
    .focusActions{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
      margin-left:auto;
    }
    .focusProgress{
      margin-top:-2px;
    }

    .celebrateCard{
      position:relative;
      border-color: rgba(41,211,154,.5);
      background:
        radial-gradient(120% 140% at 0% 0%, rgba(41,211,154,.22), rgba(18,30,52,.22)),
        rgba(255,255,255,.08);
    }
    .focusCelebrate{
      border-color: rgba(41,211,154,.6);
      background:
        radial-gradient(120% 140% at 0% 0%, rgba(41,211,154,.2), rgba(18,30,52,.2)),
        rgba(255,255,255,.06);
      box-shadow: 0 16px 30px rgba(15,255,198,.15);
      animation: focusCelebratePulse .6s ease-out;
    }
    .focusCelebrate .muted{
      color:#d9fff0;
    }
    @keyframes focusCelebratePulse{
      0%{ box-shadow: 0 0 0 rgba(41,211,154,0); transform: scale(1); }
      40%{ box-shadow: 0 0 0 6px rgba(41,211,154,.25); transform: scale(1.01); }
      100%{ box-shadow: 0 0 0 rgba(41,211,154,0); transform: scale(1); }
    }

    @keyframes celebrateGlowPulse{
      0%{ opacity:0; transform: scale(.98); }
      35%{ opacity:.85; }
      100%{ opacity:0; transform: scale(1.03); }
    }
    .celebrateOverlay{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 80;
      overflow: hidden;
      background:
        radial-gradient(circle at 18% 20%, rgba(122,167,255,.28), transparent 48%),
        radial-gradient(circle at 80% 15%, rgba(41,211,154,.22), transparent 46%),
        radial-gradient(circle at 50% 75%, rgba(255,227,138,.16), transparent 52%);
      animation: celebrateGlowPulse 1.4s ease-out forwards;
    }

    /* Review page */
    .reviewHero{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-bottom: 12px;
    }
    .reviewHero .big{
      font-weight:950;
      font-size: 16px;
      line-height:1.25;
      margin:0;
    }
    .reviewHero .smallp{
      margin:0;
      color: var(--muted);
      font-size: 12px;
      line-height:1.45;
    }

    /* Ensure no overflow issues in narrow screens */
    .nowrapEllip{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important; }
      .btn:active{ transform:none; }
    }


  </style>
<style id="mobile-safari-fixes">
/* =========================
   Mobile layout + Safari fixes
========================= */

/* Give date inputs enough room for the calendar affordance / native UI */
input[type="date"]{
  width: 100%;
  max-width: 100%;
  min-width: 0;
  flex: 1 1 auto;     /* iOS Safari: allow shrink inside flex */
  display: block;
}



/* Mobile-only fixes */
  @media (max-width: 520px){
  :root{
    --today-offset: 72px;
  }
  /* Keep Start date / Frequency unit / Target aligned on mobile */
  .freqRow{
    justify-content: center;
  }
  .freqRow > .field,
  .freqRow > .field.compact,
  .freqRow > .field.compact2{
    flex: 1 1 100%;
    min-width: 0;
  }
  /* iOS Safari date input overflow fix */
  input[type="date"]{
    -webkit-appearance: none;
    appearance: none;
    padding-right: 44px;
    min-width: 0;
  }


  /* 1) Hide scrollbar indicator on mobile (keeps scrolling enabled) */
  *{ scrollbar-width: none; }                 /* Firefox */
  *::-webkit-scrollbar{ width:0; height:0; }  /* iOS/Android WebKit */

  /* 2) Hard stop horizontal scroll (including post-zoom weirdness) */
  html, body{ overflow-x: hidden; }

  /* 3) Prevent iOS “tap-to-zoom” on inputs (font-size must be >= 16px) */
  input, textarea, select{ font-size: 16px; }

  /* Export/Import textarea: prevent zoom too */
  .sheetBody textarea{ font-size: 16px; }

  /* 4) On very small screens, stack inline fields so nothing collides */
  .inline > .field,
  .inline > .field.compact,
  .inline > .field.compact2{
    flex: 1 1 100%;
  }

  .focusRow{
    flex-direction:column;
    align-items:stretch;
    position: relative;
  }
  .focusMain{
    padding-right: 118px;
  }
  .focusActions{
    width:auto;
    position: absolute;
    top: 0;
    right: 0;
    flex-direction:column;
    justify-content:flex-start;
    align-items:flex-end;
  }
  .focusActions .btn{
    flex:0 0 auto;
  }
  .focusProgress{
    margin-top: 10px;
  }
  .focusHint{
    display:-webkit-box;
    -webkit-box-orient: vertical;
    line-clamp:1;
    overflow:hidden;
  }

  .todayCardHeader{
    flex-direction:column;
    align-items:stretch;
  }
  .todayCardHeader .right{
    width:100%;
    justify-content:flex-start;
  }
  .hMetaWide .hSub{
    flex-basis:100%;
    min-width:0;
  }
  .todaySummary{
    align-items:stretch;
  }
  .todaySummaryActions{
    width:auto;
    justify-content:flex-end;
  }
  .todaySummaryInsight{
    display:none;
  }
  .todayCard{
    top: calc(var(--today-offset) + var(--safe-t));
  }
  .habitDesc{
    line-clamp:1;
  }
  .habitMetaRow .chev{
    display:none;
  }
  .habitTitleRow .tag{
    font-size:10px;
    padding:4px 6px;
  }
}
</style>

</head>

<body>
  <div class="app">
    <header>
      <div class="topbar">
        <div class="brand">
          <div class="title">Quiet Habits — Calm Habit System</div>
          <div class="subtitle">Offline • Private • Daily check-ins • Weekly review</div>
        </div>
        <div class="pill" id="headerPill" aria-live="polite">
          <span class="dot"></span>
          <span><strong id="habitCount">0</strong> habits</span>
        </div>
      </div>
    </header>

    <main>
      <section class="section active" id="tab-dashboard" aria-label="Dashboard"></section>
      <section class="section" id="tab-review" aria-label="Weekly Review"></section>
      <section class="section" id="tab-settings" aria-label="Settings"></section>
    </main>

    <nav class="nav" aria-label="Primary">
      <div class="navInner">
        <button class="navBtn active" data-action="switchTab" data-tab="dashboard" aria-current="page">
          <div>Dashboard</div>
          <div class="tiny muted2">Habits & tracking</div>
        </button>
        <button class="navBtn" data-action="switchTab" data-tab="review">
          <div>Review</div>
          <div class="tiny muted2">Weekly reflection</div>
        </button>
        <button class="navBtn" data-action="switchTab" data-tab="settings">
          <div>Settings</div>
          <div class="tiny muted2">Export / import</div>
        </button>
      </div>
    </nav>

    <!-- Modal (Export/Import) -->
    <div class="modal" id="modal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="sheet" role="document">
        <div class="sheetHead">
          <h2 class="h" id="modalTitle">Modal</h2>
          <button class="btn small ghost" data-action="closeModal" aria-label="Close">Close</button>
        </div>
        <div class="sheetBody" id="modalBody"></div>
        <div class="sheetFoot" id="modalFoot"></div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast" aria-live="polite" aria-atomic="true">
      <div class="tcard">
        <div class="icon" id="toastIcon">✓</div>
        <div class="msg">
          <div class="a" id="toastA">Saved</div>
          <div class="b" id="toastB">Your changes are stored on this device.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (() => {
    'use strict';

    /* =========================
       Constants & Utilities
    ========================== */

    const STORAGE_KEY = 'appData_v1';
    const SCHEMA_VERSION = 2;
    const MAX_HABITS = 20;

    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const $ = (sel, root=document) => root.querySelector(sel);

    const clamp = (n, a, b) => Math.min(b, Math.max(a, n));

    function pad2(n){ return String(n).padStart(2, '0'); }

    function toISODate(d){
      // local date -> YYYY-MM-DD (local)
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }

    function parseISODate(s){
      // robust parse for YYYY-MM-DD -> local Date at noon (avoid DST edge)
      if (!s || typeof s !== 'string') return null;
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return null;
      const y = +m[1], mo = +m[2]-1, da = +m[3];
      const d = new Date(y, mo, da, 12, 0, 0, 0);
      if (Number.isNaN(d.getTime())) return null;
      // Validate round-trip
      if (d.getFullYear() !== y || d.getMonth() !== mo || d.getDate() !== da) return null;
      return d;
    }

    function todayISO(){
      return toISODate(new Date());
    }

    function uid(){
      // small but safe-ish for local app
      const c = (typeof window !== 'undefined') ? window.crypto : null;
      if (c && typeof c.randomUUID === 'function') return c.randomUUID();
      return 'h_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
    }

    function deepClone(obj){
      return JSON.parse(JSON.stringify(obj));
    }

    function safeObj(x){ return (x && typeof x === 'object') ? x : {}; }
    function safeArr(x){ return Array.isArray(x) ? x : []; }

    function setByPath(rootObj, path, value){
      if (!rootObj || typeof rootObj !== 'object') return;
      const parts = String(path || '').split('.').filter(Boolean);
      if (!parts.length) return;
      let cur = rootObj;
      for (let i=0;i<parts.length-1;i++){
        const k = parts[i];
        if (!cur[k] || typeof cur[k] !== 'object') cur[k] = {};
        cur = cur[k];
      }
      cur[parts[parts.length-1]] = value;
    }

    function getByPath(rootObj, path, fallback=''){
      const parts = String(path || '').split('.').filter(Boolean);
      let cur = rootObj;
      for (const p of parts){
        if (!cur || typeof cur !== 'object' || !(p in cur)) return fallback;
        cur = cur[p];
      }
      return (cur === undefined || cur === null) ? fallback : cur;
    }

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function cssEscape(s){
      if (window.CSS && typeof window.CSS.escape === 'function') return window.CSS.escape(s);
      return String(s ?? '').replace(/[^a-zA-Z0-9_-]/g, '_');
    }

    function formatUnit(unit, n){
      const u = unit === 'day' ? 'day' : unit === 'week' ? 'week' : 'month';
      return `${n} / ${u}`;
    }

    function startOfWeekMonday(d){
      const dd = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 12, 0, 0, 0);
      const day = (dd.getDay() + 6) % 7; // Monday=0
      dd.setDate(dd.getDate() - day);
      return dd;
    }

    function startOfMonth(d){
      return new Date(d.getFullYear(), d.getMonth(), 1, 12, 0, 0, 0);
    }

    function addDays(d, n){
      const x = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 12, 0, 0, 0);
      x.setDate(x.getDate() + n);
      return x;
    }

    function diffDays(a, b){
      // a,b local Date noon. return integer days b - a
      const ms = (b.getTime() - a.getTime());
      return Math.round(ms / 86400000);
    }

    function isValidStatusForType(type, status){
      const t = type === 'negative' ? 'negative' : 'positive';
      const s = String(status || '').toLowerCase();
      if (t === 'positive') return ['completed','missed'].includes(s);
      return ['resisted','relapsed'].includes(s);
    }

    function successStatusForType(type){
      return (type === 'negative') ? 'resisted' : 'completed';
    }

    function failStatusForType(type){
      return (type === 'negative') ? 'relapsed' : 'missed';
    }

    function lawLabelsForType(type){
      if (type === 'negative'){
        return {
          obvious: 'Make it invisible (reduce cues)',
          attractive: 'Make it unattractive (reframe craving)',
          easy: 'Make it difficult (add friction)',
          satisfying: 'Make it unsatisfying (add consequence)'
        };
      }
      return {
        obvious: 'Make it obvious (design cues)',
        attractive: 'Make it attractive (make it inviting)',
        easy: 'Make it easy (reduce friction)',
        satisfying: 'Make it satisfying (reward + track)'
      };
    }

    function frictionSeedItems(friction){
      const seeds = [];
      if (friction.removeCue) seeds.push('Remove a cue (make it less visible)');
      if (friction.addDelay) seeds.push('Add a delay (wait 5–10 minutes)');
      if (friction.addBarrier) seeds.push('Add a barrier (extra steps)');
      return seeds;
    }

    function getFrictionItems(h){
      const plan = safeObj(safeObj(h.design).plan);
      const friction = safeObj(plan.friction);
      const items = safeArr(friction.items).map(x => String(x || '').trim()).filter(Boolean);
      if (items.length) return items;
      return frictionSeedItems(friction);
    }

    function ensureFrictionItems(h){
      if (!h.design || typeof h.design !== 'object') h.design = {};
      if (!h.design.plan || typeof h.design.plan !== 'object') h.design.plan = {};
      if (!h.design.plan.friction || typeof h.design.plan.friction !== 'object') h.design.plan.friction = {};
      if (!Array.isArray(h.design.plan.friction.items)) h.design.plan.friction.items = [];
      if (!h.design.plan.friction.items.length){
        const seeds = frictionSeedItems(h.design.plan.friction);
        if (seeds.length) h.design.plan.friction.items = seeds;
      }
      return h.design.plan.friction.items;
    }

    function motivationalLine(h){
      const identity = (safeObj(h.motivator).identity || '').trim();
      if (!identity) return 'Small win. Same direction.';
      // avoid double punctuation
      const id = identity.replace(/\s+$/,'');
      return `Another calm vote for: “${id}”`;
    }

    const CELEBRATION_QUOTES = [
      'Small wins compound into big change.',
      'You showed up — that’s the win.',
      'Keep the promise, keep the momentum.',
      'Consistency beats intensity.',
      'Today you moved the needle.',
      'Tiny actions, lasting identity.',
      'Progress loves patience.',
      'You’re building trust with yourself.',
      'A calm win is still a win.',
      'Momentum grows from gentle starts.',
      'Show up again tomorrow.',
      'You did the hard part: begin.',
      'Small steps keep you close to the path.',
      'Your system is working.',
      'One check-in at a time.',
      'You’re creating a steadier future.',
      'Celebrate the follow-through.',
      'Keep it simple, keep it steady.',
      'That’s how streaks are born.',
      'You honored your plan.',
      'The identity is taking root.',
      'Great habits are quiet wins.',
      'You’re doing the work that counts.',
      'Focus on the next small action.',
      'Done is better than perfect.',
      'You built evidence today.',
      'Stay gentle, stay consistent.',
      'Your future self says thanks.',
      'Another brick in the foundation.',
      'This is how change feels.'
    ];

    function getCelebrateQuote(){
      const idx = Math.floor(Math.random() * CELEBRATION_QUOTES.length);
      return CELEBRATION_QUOTES[idx];
    }

    function normalizeData(raw){
      const base = {
        version: SCHEMA_VERSION,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        habits: [],
        reviews: {},
        ui: {
          activeTab: 'dashboard',
          createOpen: false,
          habitSubtabs: {},
          onboardingSeen: false,
          onboardingComplete: false,
          onboardingActive: false,
          wizard: { open:false, mode:'create', step:0, draft: blankWizardDraft() },
          lastCelebratedISO: '',
          soundEnabled: true,
          soundStyle: 'bright',
          streakBest: {}
        }
      };

      const d = safeObj(raw);
      const out = base;

      // Migrate / fill
      out.version = SCHEMA_VERSION;
      out.createdAt = (typeof d.createdAt === 'string') ? d.createdAt : out.createdAt;
      out.updatedAt = (typeof d.updatedAt === 'string') ? d.updatedAt : out.updatedAt;

      out.ui = safeObj(d.ui);
      if (!out.ui.activeTab) out.ui.activeTab = 'dashboard';
      if (typeof out.ui.createOpen !== 'boolean') out.ui.createOpen = false;
      if (!out.ui.habitSubtabs || typeof out.ui.habitSubtabs !== 'object') out.ui.habitSubtabs = {};
      if (typeof out.ui.onboardingSeen !== 'boolean') out.ui.onboardingSeen = false;
      if (!out.ui.insightsRange || typeof out.ui.insightsRange !== 'object') out.ui.insightsRange = {};
            if (typeof out.ui.onboardingComplete !== 'boolean') out.ui.onboardingComplete = false;
      if (typeof out.ui.onboardingActive !== 'boolean') out.ui.onboardingActive = false;
      if (typeof out.ui.hapticsEnabled !== 'boolean') out.ui.hapticsEnabled = true;
      if (typeof out.ui.soundEnabled !== 'boolean') out.ui.soundEnabled = true;
      if (!['bright','soft'].includes(out.ui.soundStyle)) out.ui.soundStyle = 'bright';
      if (!out.ui.streakBest || typeof out.ui.streakBest !== 'object') out.ui.streakBest = {};
      if (!out.ui.wizard || typeof out.ui.wizard !== 'object'){
        out.ui.wizard = { open:false, mode:'create', step:0, draft: blankWizardDraft() };
      } else {
        if (typeof out.ui.wizard.open !== 'boolean') out.ui.wizard.open = false;
        if (!out.ui.wizard.draft) out.ui.wizard.draft = blankWizardDraft();
      }
      if (typeof out.ui.lastCelebratedISO !== 'string') out.ui.lastCelebratedISO = '';
      if (!out.ui.recentOpen || typeof out.ui.recentOpen !== 'object') out.ui.recentOpen = {};
      if (!out.ui.reviewNudgeDismissed) out.ui.reviewNudgeDismissed = '';
      if (!out.ui.streakShield || typeof out.ui.streakShield !== 'object') out.ui.streakShield = {};
      if (typeof out.ui.storageWarning !== 'boolean') out.ui.storageWarning = false;


      out.reviews = safeObj(d.reviews);

      out.habits = safeArr(d.habits)
        .filter(h => h && typeof h === 'object')
        .slice(0, MAX_HABITS)
        .map(h => {
          const hh = safeObj(h);
          const type = (hh.type === 'negative') ? 'negative' : 'positive';
          const freq = safeObj(hh.frequency);
          const unit = (freq.unit === 'week' || freq.unit === 'month') ? freq.unit : 'day';
          let target = Number(freq.target);
          if (!Number.isFinite(target) || target <= 0) target = 1;
          target = Math.round(target);

          const motivator = safeObj(hh.motivator);
          const design = safeObj(hh.design);
          const loop = safeObj(design.loop);
          const laws = safeObj(design.laws);
          const plan = safeObj(design.plan);
          const friction = safeObj(plan.friction);
          const frictionItems = safeArr(friction.items)
            .map(x => String(x ?? '').trim())
            .filter(Boolean)
            .slice(0, 8)
            .map(x => x.slice(0, 160));
          const seededFrictionItems = frictionItems.length ? frictionItems : frictionSeedItems(friction);

          const logs = safeObj(hh.logs);

          // sanitize logs
          const cleanLogs = {};
          for (const k of Object.keys(logs)){
            if (!/^\d{4}-\d{2}-\d{2}$/.test(k)) continue;
            const entry = safeObj(logs[k]);
            const st = String(entry.status || '').toLowerCase();
            if (!isValidStatusForType(type, st)) continue;
            const succStatus = successStatusForType(type);
let c = Number(entry.count);
if (!Number.isFinite(c) || c < 0) c = (st === succStatus ? 1 : 0);
c = Math.round(c);

if (unit === 'day' && st === succStatus && c < target) c = target;

cleanLogs[k] = {
  date: k,
  status: st,
  note: String(entry.note ?? ''),
  count: c,
  auto: !!entry.auto,
  updatedAt: (typeof entry.updatedAt === 'string') ? entry.updatedAt : new Date().toISOString()
};

          }

          return {
            id: (typeof hh.id === 'string' && hh.id) ? hh.id : uid(),
            name: String(hh.name ?? '').slice(0, 120),
            type,
            description: String(hh.description ?? '').slice(0, 1200),
            startDate: /^\d{4}-\d{2}-\d{2}$/.test(hh.startDate) ? hh.startDate : todayISO(),
            frequency: { unit, target },
            motivator: {
              identity: String(motivator.identity ?? '').slice(0, 220),
              outcome: String(motivator.outcome ?? '').slice(0, 260),
              why: String(motivator.why ?? '').slice(0, 420)
            },
            design: {
              loop: {
                cue: String(loop.cue ?? '').slice(0, 800),
                craving: String(loop.craving ?? '').slice(0, 800),
                response: String(loop.response ?? '').slice(0, 800),
                reward: String(loop.reward ?? '').slice(0, 800)
              },
              laws: {
                obvious: String(laws.obvious ?? '').slice(0, 900),
                attractive: String(laws.attractive ?? '').slice(0, 900),
                easy: String(laws.easy ?? '').slice(0, 900),
                satisfying: String(laws.satisfying ?? '').slice(0, 900)
              },
              plan: {
                ifThen: String(plan.ifThen ?? '').slice(0, 400),
                cuePlan: String(plan.cuePlan ?? '').slice(0, 400),
                twoMinute: String(plan.twoMinute ?? '').slice(0, 240),
                friction: {
                  removeCue: !!friction.removeCue,
                  addDelay: !!friction.addDelay,
                  addBarrier: !!friction.addBarrier,
                  items: seededFrictionItems
                }
              }
            },
            logs: cleanLogs,
            createdAt: (typeof hh.createdAt === 'string') ? hh.createdAt : new Date().toISOString(),
            updatedAt: (typeof hh.updatedAt === 'string') ? hh.updatedAt : new Date().toISOString()
          };
        });

      // If no habits, keep array
      if (!Array.isArray(out.habits)) out.habits = [];

      return out;
    }

    function loadData(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return normalizeData(null);
        const parsed = JSON.parse(raw);
        return normalizeData(parsed);
      }catch(e){
        // defensive: corrupted storage
        return normalizeData(null);
      }
    }

    let appData = loadData();

    let saveTimer = null;
    function saveData({ toast=false, toastMsg=null } = {}){
      appData.updatedAt = new Date().toISOString();
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        appData.ui.storageWarning = false;
      }catch(e){
        // localStorage may fail (quota). Surface calm error.
        appData.ui.storageWarning = true;
        showToast('Couldn’t save', 'Storage is full or blocked. Backup now (Export), then consider clearing old logs if needed.', { icon: '!' });
        return;
      }
      if (toast){
        const msg = toastMsg || 'Your changes are stored on this device.';
        showToast('Saved', msg, { icon: '✓' });
      }
    }

    function scheduleSave(){
      // fast, near-immediate persistence while keeping typing smooth
      if (saveTimer) return;
      saveTimer = setTimeout(() => {
        saveTimer = null;
        saveData({ toast:false });
      }, 60);
    }

    function showToast(a, b, { icon='✓', ms=2400 } = {}){
      const el = $('#toast');
      $('#toastIcon').textContent = icon;
      $('#toastA').textContent = a;
      $('#toastB').textContent = b;
      el.classList.add('active');
      window.clearTimeout(showToast._t);
      showToast._t = window.setTimeout(() => el.classList.remove('active'), ms);
    }

    const HAPTIC_GUARD_MS = 140;
    const HAPTIC_PATTERNS = {
      nav: [6],
      primary: [10],
      confirm: [14],
      danger: [18]
    };
    let lastHapticAt = 0;

    function hapticsAvailable(){
      if (appData?.ui?.hapticsEnabled === false) return false;
      if (!navigator?.vibrate) return false;
      return true;
    }

    function triggerHaptic(kind = 'primary'){
      if (!hapticsAvailable()) return;
      const now = Date.now();
      if (now - lastHapticAt < HAPTIC_GUARD_MS) return;
      lastHapticAt = now;
      const pattern = HAPTIC_PATTERNS[kind] || HAPTIC_PATTERNS.primary;
      try{
        navigator.vibrate(pattern);
      }catch(e){}
    }

    let audioCtx = null;
    let audioUnlocked = false;
    function getAudioContext(){
      if (!appData?.ui?.soundEnabled) return null;
      if (!window.AudioContext && !window.webkitAudioContext) return null;
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') audioCtx.resume().catch(() => {});
      return audioCtx;
    }

    function unlockAudioContext(){
      const ctx = getAudioContext();
      if (!ctx) return;
      if (ctx.state === 'suspended'){
        ctx.resume().then(() => {
          audioUnlocked = ctx.state === 'running';
        }).catch(() => {});
        return;
      }
      audioUnlocked = ctx.state === 'running';
    }

    function initAudioUnlock(){
      const handler = () => {
        unlockAudioContext();
        if (!audioUnlocked) return;
        window.removeEventListener('pointerdown', handler);
        window.removeEventListener('touchstart', handler);
        window.removeEventListener('keydown', handler);
      };
      window.addEventListener('pointerdown', handler, { passive:true });
      window.addEventListener('touchstart', handler, { passive:true });
      window.addEventListener('keydown', handler);
    }

    // New: rewarding completion chime for habit check-ins.
    function playSuccessChime(){
      if (appData?.ui?.soundEnabled === false) return;
      const ctx = getAudioContext();
      if (!ctx) return;
      const style = appData?.ui?.soundStyle === 'soft' ? 'soft' : 'bright';
      const trigger = () => {
        try{
          const now = ctx.currentTime;
          const gain = ctx.createGain();
          gain.gain.setValueAtTime(0.0001, now);
          const peak = style === 'soft' ? 0.18 : 0.25;
          gain.gain.exponentialRampToValueAtTime(peak, now + 0.02);
          gain.gain.exponentialRampToValueAtTime(0.001, now + 0.55);
          gain.connect(ctx.destination);

          const osc1 = ctx.createOscillator();
          osc1.type = style === 'soft' ? 'sine' : 'triangle';
          osc1.frequency.setValueAtTime(style === 'soft' ? 392.00 : 523.25, now); // G4 or C5
          osc1.connect(gain);

          const osc2 = ctx.createOscillator();
          osc2.type = 'sine';
          osc2.frequency.setValueAtTime(style === 'soft' ? 493.88 : 659.25, now + 0.06); // B4 or E5
          osc2.connect(gain);

          osc1.start(now);
          osc1.stop(now + 0.28);
          osc2.start(now + 0.06);
          osc2.stop(now + 0.5);
        }catch(e){}
      };
      if (ctx.state === 'suspended'){
        ctx.resume().then(trigger).catch(() => {});
        return;
      }
      trigger();
    }

    function updateSoundUI(){
      const soundOn = appData.ui.soundEnabled !== false;
      const label = soundOn ? 'Sound on' : 'Sound off';
      document.querySelectorAll('[data-action="toggleSound"]').forEach((btn) => {
        const isIcon = btn.classList.contains('iconButton') || btn.getAttribute('data-sound-icon') === 'true';
        if (isIcon){
          btn.innerHTML = `
            <span aria-hidden="true">${soundOn ? '🔊' : '🔇'}</span>
            <span class="sr-only">${label}</span>
          `;
          btn.setAttribute('aria-label', label);
          btn.setAttribute('title', label);
        } else {
          btn.textContent = label;
        }
        btn.setAttribute('aria-pressed', soundOn ? 'true' : 'false');
      });
    }

    function updateSoundStyleUI(){
      const style = appData.ui.soundStyle === 'soft' ? 'soft' : 'bright';
      document.querySelectorAll('[data-action="setSoundStyle"]').forEach((btn) => {
        const btnStyle = btn.getAttribute('data-style');
        const active = btnStyle === style;
        btn.classList.toggle('active', active);
        btn.setAttribute('aria-pressed', active ? 'true' : 'false');
      });
    }

    const ACTION_HAPTICS = {
      switchTab: 'nav',
      openHabitDetail: 'nav',
      openTodayFocus: 'nav',
      jumpToPlan: 'nav'
    };

    function handleActionHaptic(action){
      const kind = ACTION_HAPTICS[action];
      if (!kind) return;
      triggerHaptic(kind);
    }

    function pulseEl(el){
      if (!el) return;
      el.classList.remove('pulse');
      void el.offsetWidth;
      el.classList.add('pulse');
      setTimeout(() => el.classList.remove('pulse'), 350);
    }

    let lastModalFocus = null;

    function setAppAriaHidden(hidden){
      const header = document.querySelector('header');
      const main = document.querySelector('main');
      const nav = document.querySelector('nav');
      [header, main, nav].forEach(el => {
        if (!el) return;
        if (hidden) el.setAttribute('aria-hidden','true');
        else el.removeAttribute('aria-hidden');
      });
    }

    function getModalFocusable(){
      const modal = $('#modal');
      const nodes = $$('textarea, input, button, select, [tabindex]:not([tabindex="-1"])', modal);
      return nodes.filter(el => !el.hasAttribute('disabled') && el.getAttribute('aria-hidden') !== 'true');
    }

    function getHabit(id){
      return appData.habits.find(h => h.id === id) || null;
    }

    function sortHabits(){
      // stable: by createdAt then name
      appData.habits.sort((a,b) => {
        const ta = Date.parse(a.createdAt || '') || 0;
        const tb = Date.parse(b.createdAt || '') || 0;
        if (ta !== tb) return ta - tb;
        return String(a.name).localeCompare(String(b.name));
      });
    }

    /* =========================
       Metrics
    ========================== */

    function plannedRatePerDay(h){
      const f = safeObj(h.frequency);
      const target = Math.max(1, Math.round(Number(f.target) || 1));
      const unit = f.unit === 'week' ? 'week' : f.unit === 'month' ? 'month' : 'day';
      if (unit === 'day') return target;
      if (unit === 'week') return target / 7;
      // month average days
      return target / 30.4375;
    }

    function currentPeriodRange(h){
      const now = new Date();
      const unit = safeObj(h.frequency).unit;
      if (unit === 'week'){
        const start = startOfWeekMonday(now);
        const end = addDays(start, 7);
        return { start, end, label:'This week' };
      }
      if (unit === 'month'){
        const start = startOfMonth(now);
        const end = new Date(start.getFullYear(), start.getMonth()+1, 1, 12,0,0,0);
        return { start, end, label:'This month' };
      }
      // day
      const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12,0,0,0);
      const end = addDays(start, 1);
      return { start, end, label:'Today' };
    }

    function countSuccessInRange(h, start, end){
      const logs = safeObj(h.logs);
      const succ = successStatusForType(h.type);
      let c = 0;
      for (const k of Object.keys(logs)){
        const d = parseISODate(k);
        if (!d) continue;
        if (d >= start && d < end){
          if ((logs[k]?.status) === succ) c++;
        }
      }
      return c;
    }

    function sumSuccessCountInRange(h, start, end){
      const logs = safeObj(h.logs);
      const succ = successStatusForType(h.type);
      let total = 0;
      for (const k of Object.keys(logs)){
        const d = parseISODate(k);
        if (!d) continue;
        if (d >= start && d < end){
          if ((logs[k]?.status) === succ){
            const raw = Number(logs[k]?.count);
            total += Number.isFinite(raw) ? raw : 1;
          }
        }
      }
      return total;
    }

function windowConsistencyPercent(h, days){
  const w = effectiveWindowForHabit(h, days);
  const succCount = countSuccessInRange(h, w.start, addDays(w.end, 1));

  const planned = plannedRatePerDay(h) * w.days; // <-- key change: only planned “so far”
  if (planned <= 0.0001) return 0;

  return clamp(Math.round((succCount / planned) * 100), 0, 100);
}


    function currentDailyStreak(h){
      // consecutive days ending today with success
      const logs = safeObj(h.logs);
      const succ = successStatusForType(h.type);
      let streak = 0;
      const today = parseISODate(todayISO());
      if (!today) return 0;
      for (let i=0; i<3650; i++){
        const d = addDays(today, -i);
        const iso = toISODate(d);
        const shield = (typeof getShield === 'function') ? getShield(h.id) : { used: {} };
        const shielded = !!safeObj(shield.used)[iso];
        const entry = logs[iso];
        if ((entry && entry.status === succ) || shielded){
          streak++;
        } else {
          break;
        }
      }
      return streak;
    }

    function bestDailyStreak(h){
      const logs = safeObj(h.logs);
      const succ = successStatusForType(h.type);
      const today = parseISODate(todayISO());
      if (!today) return 0;
      let streak = 0;
      let best = 0;
      const shield = (typeof getShield === 'function') ? getShield(h.id) : { used: {} };
      for (let i=0; i<3650; i++){
        const d = addDays(today, -i);
        const iso = toISODate(d);
        const shielded = !!safeObj(shield.used)[iso];
        const entry = logs[iso];
        if ((entry && entry.status === succ) || shielded){
          streak++;
          if (streak > best) best = streak;
        } else {
          streak = 0;
        }
      }
      return best;
    }

    function getBestStreak(h){
      appData.ui = safeObj(appData.ui);
      appData.ui.streakBest = safeObj(appData.ui.streakBest);
      if (!Number.isFinite(appData.ui.streakBest[h.id])){
        appData.ui.streakBest[h.id] = bestDailyStreak(h);
        scheduleSave();
      }
      return appData.ui.streakBest[h.id] || 0;
    }

    function setBestStreak(h, value){
      appData.ui = safeObj(appData.ui);
      appData.ui.streakBest = safeObj(appData.ui.streakBest);
      appData.ui.streakBest[h.id] = Math.max(0, Math.round(value || 0));
      scheduleSave();
    }

    function periodProgress(h){
  const f = safeObj(h.frequency);
  const target = Math.max(1, Math.round(Number(f.target) || 1));
  const unit = f.unit === 'week' ? 'week' : f.unit === 'month' ? 'month' : 'day';
  const succ = successStatusForType(h.type);

  // Day unit uses count for "today" progress
  if (unit === 'day'){
    const iso = todayISO();
    const e = safeObj(safeObj(h.logs)[iso]);
    let c = Number(e.count);
    if (!Number.isFinite(c) || c < 0) c = (String(e.status || '').toLowerCase() === succ) ? target : 0;
    c = clamp(Math.round(c), 0, target);
    const ratio = clamp(c / target, 0, 1);
    return { target, actual: c, ratio, label: 'Today', startISO: iso };
  }

  // Week/month count successful days
  const { start, end, label } = currentPeriodRange(h);
  const actual = countSuccessInRange(h, start, end);
  const ratio = clamp(actual / target, 0, 1);
  return { target, actual, ratio, label, startISO: toISODate(start) };
}


    function actualCountLast12Months(h){
      const succ = successStatusForType(h.type);
      const logs = safeObj(h.logs);
      const end = parseISODate(todayISO());
      if (!end) return 0;
      const start = addDays(end, -364);
      let c = 0;
      for (const k of Object.keys(logs)){
        const d = parseISODate(k);
        if (!d) continue;
        if (d >= start && d <= end){
          if ((logs[k]?.status) === succ) c++;
        }
      }
      return c;
    }

    function totalSuccessCount(h){
      const succ = successStatusForType(h.type);
      const logs = safeObj(h.logs);
      let c = 0;
      for (const k of Object.keys(logs)){
        if ((logs[k]?.status) === succ) c++;
      }
      return c;
    }

    function insightsSuggestions(h){
      const c7 = windowConsistencyPercent(h, 7);
      const c30 = windowConsistencyPercent(h, 30);
      const isNeg = (h.type === 'negative');
      const lines = [];
      if (c7 < 35){
        lines.push(isNeg
          ? 'Make the trigger harder to reach this week: remove cues or add a small speed bump.'
          : 'Make the first step tiny: aim for a “2-minute version” and let momentum do the rest.');
      } else if (c7 < 70){
        lines.push(isNeg
          ? 'Good trend. Keep your environment supportive: reduce exposure to cues during your weak spots.'
          : 'You’re building consistency. Reduce friction: prep the environment so starting is effortless.');
      } else {
        lines.push(isNeg
          ? 'Strong week. Protect the streak by planning for high-risk moments with a simple if-then plan.'
          : 'Strong week. Consider gently raising the bar only if it still feels calm and sustainable.');
      }

      if (c30 < 50){
        lines.push('Look for the “real obstacle”: time, energy, location, or a missing cue. Adjust the system, not your self-talk.');
      } else {
        lines.push('Keep it shame-free: the goal is trajectory. A miss is data, not a verdict.');
      }

      // tie to motivator
      const id = (safeObj(h.motivator).identity || '').trim();
      if (id){
        lines.push(`Identity reminder: ${id}`);
      } else {
        lines.push('Identity reminder: you’re the kind of person who returns to the path.');
      }
      return lines.slice(0, 4);
    }

function effectiveWindowForHabit(h, requestedDays){
  const end = new Date(); // now
  const endNoon = new Date(end.getFullYear(), end.getMonth(), end.getDate(), 12,0,0,0);

  const req = clamp(Math.round(Number(requestedDays) || 7), 1, 365);
  const requestedStart = addDays(endNoon, -(req - 1));

  const startD = parseISODate(h.startDate);
  const start = (startD && startD > requestedStart) ? startD : requestedStart;

  const days = clamp(diffDays(start, endNoon) + 1, 1, req); // “days so far” in this window
  return { start, end: endNoon, days };
}

    /* =========================
       Chart (12 months)
    ========================== */

function buildCumulativeSeries(h, days){
  const succ = successStatusForType(h.type);
  const logs = safeObj(h.logs);

  const w = effectiveWindowForHabit(h, days);
  const start = w.start;
  const end = w.end;
  const span = w.days;

  const plannedRate = plannedRatePerDay(h);

  // Precompute success set for quick lookup
  const successSet = new Set();
  for (const k of Object.keys(logs)){
    if ((logs[k]?.status) === succ) successSet.add(k);
  }

  let actualCum = 0;
  const points = [];
  for (let i = 0; i < span; i++){
    const d = addDays(start, i);
    const iso = toISODate(d);
    const hit = successSet.has(iso);
    if (hit) actualCum += 1;
    const plannedCum = plannedRate * (i + 1);
    points.push({ i, iso, actual: actualCum, planned: plannedCum, hit });
  }

  const last = points[points.length - 1];
  const yMax = Math.max(1, Math.ceil(Math.max(last.actual, last.planned)));
  return { startISO: toISODate(start), endISO: toISODate(end), points, yMax, days: span };
}

function buildWeeklyBarSeries(h, weeks=5){
  const endWeek = startOfWeekMonday(new Date());
  const bars = [];
  let maxVal = 0;

  for (let i = weeks - 1; i >= 0; i--){
    const start = addDays(endWeek, -7 * i);
    const end = addDays(start, 7);
    const value = sumSuccessCountInRange(h, start, end);
    maxVal = Math.max(maxVal, value);
    const label = start.toLocaleString(undefined, { month:'short', day:'numeric' });
    bars.push({
      label,
      value,
      startISO: toISODate(start),
      endISO: toISODate(addDays(end, -1))
    });
  }

  return { bars, yMax: Math.max(7, Math.ceil(maxVal)) };
}

function renderWeeklyBarChart(h){
  const series = buildWeeklyBarSeries(h, 5);
  const { bars, yMax } = series;
  const mid = Math.max(1, Math.round(yMax / 2));

  const axisLabels = [yMax, mid, 0];
  const axisHtml = axisLabels.map(v => `<div>${escapeHtml(String(v))}</div>`).join('');

  const barHtml = bars.map(b => `
    <div
      class="barChartBar"
      style="height:${((b.value / yMax) * 100).toFixed(1)}%;"
      title="Week of ${escapeHtml(b.label)}: ${escapeHtml(String(b.value))} completions"
      aria-label="Week of ${escapeHtml(b.startISO)} to ${escapeHtml(b.endISO)}: ${escapeHtml(String(b.value))} completions"
      role="img"
    ></div>
  `).join('');

  const labelHtml = bars.map(b => `<div>${escapeHtml(b.label)}</div>`).join('');

  return `
    <div class="chartWrap" style="margin-top:12px;">
      <div class="chartHead">
        <div class="t">Weekly completions</div>
        <div class="muted tiny">Y-axis: Completions</div>
      </div>
      <div class="barChart" role="img" aria-label="Bar chart showing completions per week">
        <div class="barChartAxis">${axisHtml}</div>
        <div class="barChartPlot">
          <div class="barChartCanvas">${barHtml}</div>
          <div class="barChartLabels">${labelHtml}</div>
          <div class="barChartAxisLabel">Weeks</div>
        </div>
      </div>
    </div>
  `;
}

function svgPathFrom(points, x0, y0, w, h, yMax, key){
  const n = points.length;
  if (n === 0) return '';
  if (n === 1){
    // Draw a tiny horizontal segment so SVG has something valid to render
    const val = points[0][key] || 0;
    const y = y0 + h - (val / yMax) * h;
    const xA = x0;
    const xB = x0 + Math.min(w, 1); // 1px-ish segment
    return `M${xA.toFixed(2)} ${y.toFixed(2)} L${xB.toFixed(2)} ${y.toFixed(2)}`;
  }

  let d = '';
  for (let i=0;i<n;i++){
    const x = x0 + (i / (n-1)) * w;
    const val = points[i][key] || 0;
    const y = y0 + h - (val / yMax) * h;
    d += (i===0 ? 'M' : 'L') + x.toFixed(2) + ' ' + y.toFixed(2) + ' ';
  }
  return d.trim();
}


const INSIGHT_RANGES = {
  '1w': { label: '1 week', days: 7 },
  '1m': { label: '1 month', days: 30 },
  '3m': { label: '3 months', days: 90 },
  '6m': { label: '6 months', days: 180 },
  '1y': { label: '1 year', days: 365 }
};

function getInsightRangeKey(hid){
  appData.ui = safeObj(appData.ui);
  appData.ui.insightsRange = safeObj(appData.ui.insightsRange);
  const v = String(appData.ui.insightsRange[hid] || '1y');
  return INSIGHT_RANGES[v] ? v : '1y';
}


function renderChartSVG(h, container, rangeKey){
  const rk = (rangeKey && INSIGHT_RANGES[rangeKey]) ? rangeKey : getInsightRangeKey(h.id);
  const range = INSIGHT_RANGES[rk] || INSIGHT_RANGES['1y'];

  const series = buildCumulativeSeries(h, range.days);
  if (!series){
    container.innerHTML = '<div class="muted small">Chart unavailable.</div>';
    return;
  }

  const { points, yMax, startISO, endISO, days } = series;
  const n = points.length;
  const denom = Math.max(1, n - 1);

  const vbW = 360, vbH = 130;
  const padL = 12, padR = 10, padT = 10, padB = 26;
  const plotW = vbW - padL - padR;
  const plotH = vbH - padT - padB;

  const planPath = svgPathFrom(points, padL, padT, plotW, plotH, yMax, 'planned');
  const actPath  = svgPathFrom(points, padL, padT, plotW, plotH, yMax, 'actual');

  // dots at actual hits
  const dotEls = [];
  for (let i=0;i<n;i++){
    if (!points[i].hit) continue;
    const x = padL + (i / denom) * plotW;
    const y = padT + plotH - (points[i].actual / yMax) * plotH;
    dotEls.push(`<circle cx="${x.toFixed(2)}" cy="${y.toFixed(2)}" r="1.7" fill="rgba(234,240,255,.85)" stroke="rgba(234,240,255,.35)" stroke-width="1" />`);
  }

  // Ticks + labels adapt to range
  const startD = parseISODate(startISO);
  const endD = parseISODate(endISO);
  const tickEls = [];
  const labelEls = [];

  function xForIndex(i){
    return padL + (i / denom) * plotW;
  }

  if (startD && endD){
    if (days <= 14){
      // Daily ticks, label every other day (weekday)
      for (let i=0;i<n;i++){
        const x = xForIndex(i);
        tickEls.push(`<line x1="${x.toFixed(2)}" y1="${(padT+plotH).toFixed(2)}" x2="${x.toFixed(2)}" y2="${(padT+plotH+5).toFixed(2)}" stroke="rgba(255,255,255,.18)" stroke-width="1" />`);
        if (i % 2 === 0){
          const d = addDays(startD, i);
          const lab = d.toLocaleString(undefined, { weekday:'short' });
          labelEls.push(`<text x="${x.toFixed(2)}" y="${(padT+plotH+18).toFixed(2)}" text-anchor="middle" font-size="9" fill="rgba(169,182,214,.90)" font-weight="700">${escapeHtml(lab)}</text>`);
        }
      }
    } else if (days <= 45){
      // Weekly ticks, label each tick (Mon date)
      for (let i=0;i<n;i+=7){
        const x = xForIndex(i);
        tickEls.push(`<line x1="${x.toFixed(2)}" y1="${(padT+plotH).toFixed(2)}" x2="${x.toFixed(2)}" y2="${(padT+plotH+5).toFixed(2)}" stroke="rgba(255,255,255,.18)" stroke-width="1" />`);
        const d = addDays(startD, i);
        const lab = d.toLocaleString(undefined, { month:'short', day:'numeric' });
        labelEls.push(`<text x="${x.toFixed(2)}" y="${(padT+plotH+18).toFixed(2)}" text-anchor="middle" font-size="9" fill="rgba(169,182,214,.90)" font-weight="700">${escapeHtml(lab)}</text>`);
      }
    } else {
      // Month ticks (first of month), label every month for <=6m, every other for 1y
      const cursor = new Date(startD.getFullYear(), startD.getMonth(), 1, 12,0,0,0);
      while (cursor < startD) cursor.setMonth(cursor.getMonth()+1);

      let tickCount = 0;
      const labelEvery = (days >= 300) ? 2 : 1;

      while (cursor <= endD){
        const idx = diffDays(startD, cursor);
        if (idx >= 0 && idx < n){
          const x = xForIndex(idx);
          tickEls.push(`<line x1="${x.toFixed(2)}" y1="${(padT+plotH).toFixed(2)}" x2="${x.toFixed(2)}" y2="${(padT+plotH+5).toFixed(2)}" stroke="rgba(255,255,255,.18)" stroke-width="1" />`);
          if (tickCount % labelEvery === 0){
            const m = cursor.toLocaleString(undefined, { month:'short' });
            labelEls.push(`<text x="${x.toFixed(2)}" y="${(padT+plotH+18).toFixed(2)}" text-anchor="middle" font-size="9" fill="rgba(169,182,214,.90)" font-weight="700">${escapeHtml(m)}</text>`);
          }
          tickCount++;
        }
        cursor.setMonth(cursor.getMonth()+1);
      }
    }
  }

  const aria = `${range.label} cumulative progress chart`;

  const svg = `
    <svg viewBox="0 0 ${vbW} ${vbH}" width="100%" height="130" role="img" aria-label="${escapeHtml(aria)}">
      <defs>
        <linearGradient id="gAct" x1="0" x2="1" y1="0" y2="0">
          <stop offset="0%" stop-color="rgba(41,211,154,.90)"></stop>
          <stop offset="100%" stop-color="rgba(122,167,255,.80)"></stop>
        </linearGradient>
        <filter id="glow" x="-30%" y="-30%" width="160%" height="160%">
          <feGaussianBlur stdDeviation="1.2" result="blur"></feGaussianBlur>
          <feMerge>
            <feMergeNode in="blur"></feMergeNode>
            <feMergeNode in="SourceGraphic"></feMergeNode>
          </feMerge>
        </filter>
      </defs>

      <rect x="${padL}" y="${padT}" width="${plotW}" height="${plotH}" rx="12" ry="12"
            fill="rgba(255,255,255,.02)" stroke="rgba(255,255,255,.10)" />

      <line x1="${padL}" y1="${(padT+plotH*0.33).toFixed(2)}" x2="${(padL+plotW)}" y2="${(padT+plotH*0.33).toFixed(2)}"
            stroke="rgba(255,255,255,.06)" stroke-width="1" />
      <line x1="${padL}" y1="${(padT+plotH*0.66).toFixed(2)}" x2="${(padL+plotW)}" y2="${(padT+plotH*0.66).toFixed(2)}"
            stroke="rgba(255,255,255,.06)" stroke-width="1" />

      <path d="${planPath}" fill="none" stroke="rgba(122,167,255,.75)" stroke-width="2" stroke-dasharray="5 4" />
      <path d="${actPath}" fill="none" stroke="url(#gAct)" stroke-width="2.6" filter="url(#glow)" />

      ${dotEls.join('')}
      ${tickEls.join('')}
      ${labelEls.join('')}
    </svg>
  `;
  container.innerHTML = svg;
}


    /* =========================
       Rendering
    ========================== */

    function render(){
      // normalize and sort
      appData = normalizeData(appData);
      sortHabits();
      $('#habitCount').textContent = String(appData.habits.length);

      renderNavActive();
      renderDashboard();
      renderReview();
      renderSettings();
      applyActiveTab();
      maybeTriggerOnboarding();
      updateSoundUI();
      updateSoundStyleUI();
    }

    function renderNavActive(){
      $$('.navBtn').forEach(btn => {
        const tab = btn.getAttribute('data-tab');
        const active = tab === appData.ui.activeTab;
        btn.classList.toggle('active', active);
        if (active) btn.setAttribute('aria-current','page');
        else btn.removeAttribute('aria-current');
      });
    }

    function getTodayInsightLine(){
      const habits = safeArr(appData.habits);
      if (!habits.length) return 'Small starts count. One calm win today is enough.';
      const lines = [];
      const iso = todayISO();
      const dSeed = iso.split('-').join('');
      const seed = Number(dSeed.slice(-3)) || 0;

      habits.forEach(h => {
        const id = (safeObj(h.motivator).identity || '').trim();
        if (id) lines.push(`Today’s vote: ${id}`);
      });

      const any = habits[seed % habits.length];
      if (any){
        const c7 = windowConsistencyPercent(any, 7);
        if (c7 < 50) lines.push('Make it easy today: 2 minutes still counts.');
        else lines.push('Consistency beats intensity. Keep the loop gentle.');
      }

      if (!lines.length) lines.push('Keep it shame-free. A miss is data, not a verdict.');
      return lines[seed % lines.length];
    }

    function renderOnboardingHero(){
      return `
        <div class="card heroCard guidedCard" style="margin-bottom:12px;">
          <div class="cardHeader">
            <div class="left">
              <p class="hTitle">Start Here</p>
              <div class="hMeta">
                <span class="muted2">A guided setup that teaches the system as you build it.</span>
              </div>
            </div>
          </div>
          <div class="content">
            <div class="muted small" style="margin-bottom:10px;">
              Create your first habit in about a minute. You’ll get a clear next action and a confident first check-in.
            </div>
            <button class="btn primary wide" data-action="startOnboarding">Begin guided setup</button>
            <div class="muted tiny" style="margin-top:10px;">Private, offline-first, and editable anytime.</div>
          </div>
        </div>
      `;
    }

    function blankWizardDraft(){
      return {
        type: 'positive',
        name: '',
        description: '',
        frequency: { unit: 'day', target: 1 },
        motivator: { identity: '', outcome: '', why: '' },
        design: {
          plan: { ifThen: '', cuePlan: '', twoMinute: '' },
          laws: { obvious: '', attractive: '', easy: '', satisfying: '' }
        }
      };
    }

    function openWizard(mode='create'){
      appData.ui = safeObj(appData.ui);
      appData.ui.wizard = {
        open: true,
        mode,
        step: 0,
        draft: blankWizardDraft()
      };
      saveData({ toast:false });
      renderWizardModal();
    }

    function closeWizard(){
      if (appData.ui?.wizard) appData.ui.wizard.open = false;
      appData.ui.onboardingActive = false;
      saveData({ toast:false });
      closeModal();
    }

    function wizardStepsTotal(){
      return 9;
    }

    function wizardProgress(step){
      return Math.round(((step + 1) / wizardStepsTotal()) * 100);
    }

    function renderWizardModal(){
      const wiz = safeObj(appData.ui?.wizard);
      if (!wiz.open) return;
      const step = Number(wiz.step || 0);
      const draft = safeObj(wiz.draft);
      const total = wizardStepsTotal();
      const title = (wiz.mode === 'onboarding') ? 'Start Here' : 'Create Habit';

      openModal(
        title,
        renderWizardStep(step, draft),
        renderWizardFoot(step, total)
      );
    }

    function renderWizardFoot(step, total){
      const back = step > 0 ? `<button class="btn ghost" data-action="wizardBack">Back</button>` : '';
      const nextLabel = (step === total - 1) ? 'Finish' : 'Next';
      const next = `<button class="btn primary" data-action="wizardNext">${nextLabel}</button>`;
      return `<div class="wizardFooter">${back}${next}</div>`;
    }

    function renderInfoIcon(text){
      return `<button type="button" class="infoIcon" data-info="${escapeHtml(text)}" aria-label="${escapeHtml(text)}">i</button>`;
    }

    function renderWizardStep(step, draft){
      const lawLabels = lawLabelsForType(draft.type);
      const twoMinuteLabel = draft.type === 'negative' ? '2-minute replacement (strongly suggested)' : '2-minute version (required)';
      const previewDesc = draft.description || draft.name || 'Your habit summary will appear here.';
      const previewNext = draft.design?.plan?.twoMinute || draft.design?.plan?.ifThen || draft.design?.plan?.cuePlan || 'A tiny start you can do today.';
      const freqLabel = formatUnit(draft.frequency?.unit || 'day', draft.frequency?.target || 1);
      const isNegative = draft.type === 'negative';
      const nameLabel = isNegative ? 'Name the behavior you want to reduce' : 'Give it a clear, action-based name';
      const nameInfo = isNegative
        ? 'Name the specific behavior and context you want to reduce, like “Scroll after midnight.”'
        : 'Use a verb plus a time or place, like “Walk after lunch.”';
      const namePlaceholder = isNegative ? 'e.g., Scroll after midnight' : 'e.g., Walk after lunch';
      const nameHelp = isNegative ? 'Specific behavior + context helps you notice it.' : 'Action + time/place beats abstract goals.';
      const periodLabel = isNegative ? 'Target period (for resisting)' : 'Target period';
      const periodInfo = isNegative
        ? 'Sets the time period your target count applies to (per day, week, or month).'
        : 'Sets the time period your target count applies to (per day, week, or month).';
      const targetInfo = isNegative
        ? 'How many times you want to resist or avoid the habit in that period.'
        : 'How many times you want to complete the habit in that period.';
      const targetHelp = isNegative ? 'Times resisted per period.' : 'Times completed per period.';
      const identityInfo = isNegative
        ? 'State the identity you want to reinforce by reducing this habit.'
        : 'State the identity you want to reinforce by building this habit.';
      const identityPlaceholder = isNegative
        ? 'I am the kind of person who protects my focus.'
        : 'I am the kind of person who…';
      const ifThenPlaceholder = isNegative
        ? 'If I feel the urge, then I will…'
        : 'If it’s 7pm, then I will…';
      const cuePlanPlaceholder = isNegative
        ? 'After I notice the cue, I will…'
        : 'After I make coffee, I will…';
      const doneLabel = isNegative ? 'What does success look like?' : 'What does “done” mean?';
      const doneInfo = isNegative
        ? 'Describe a clear win you can check off (e.g., “Zero cigarettes today”).'
        : 'Describe a clear win you can check off (e.g., “30 minutes of writing”).';
      const donePlaceholder = isNegative
        ? 'Define a clear win (e.g., Zero cigarettes today).'
        : 'Define a clear win (e.g., 30 minutes of writing).';
   

      return `
        <div class="wizard">
          <div class="wizardHeader">
            <div>
              <div class="step">Step ${step + 1} of ${wizardStepsTotal()}</div>
              <div class="hTitle" style="margin:6px 0 0;">${escapeHtml(wizardStepTitle(step, draft.type))}</div>
            </div>
            <div class="tiny muted2">${escapeHtml(wizardStepTag(step))}</div>
          </div>
          <div class="wizardProgress"><div class="fill" style="width:${wizardProgress(step)}%"></div></div>
          <div class="wizardCard">
            ${step === 0 ? `
              <div class="wizardHint" style="margin-bottom:10px;">Choose whether you want to build a habit or reduce one. This shapes the language and tracking.</div>
              <div class="wizardRow">
                <button class="btn ${draft.type === 'positive' ? 'primary' : 'ghost'}" data-action="wizardSetType" data-value="positive">Build a habit</button>
                <button class="btn ${draft.type === 'negative' ? 'primary' : 'ghost'}" data-action="wizardSetType" data-value="negative">Break a habit</button>
              </div>
            ` : ''}

            ${step === 1 ? `
              <div class="field">
                <label><span>${escapeHtml(nameLabel)}</span>${renderInfoIcon(nameInfo)}</label>
                <input type="text" data-action="wizardInput" data-field="name" value="${escapeHtml(draft.name || '')}" placeholder="${escapeHtml(namePlaceholder)}" maxlength="120" />
                <div class="help">${escapeHtml(nameHelp)}</div>
              </div>
            ` : ''}

            ${step === 2 ? `
              <div class="grid two">
                <div class="field">
                  <label><span>${escapeHtml(periodLabel)}</span>${renderInfoIcon(periodInfo)}</label>
                  <select data-action="wizardInput" data-field="frequency.unit">
                    <option value="day" ${draft.frequency?.unit === 'day' ? 'selected' : ''}>Daily</option>
                    <option value="week" ${draft.frequency?.unit === 'week' ? 'selected' : ''}>Weekly</option>
                    <option value="month" ${draft.frequency?.unit === 'month' ? 'selected' : ''}>Monthly</option>
                  </select>
                </div>
                <div class="field">
                  <label><span>Target count</span>${renderInfoIcon(targetInfo)}</label>
                  <input type="number" min="1" step="1" inputmode="numeric" data-action="wizardInput" data-field="frequency.target" value="${escapeHtml(String(draft.frequency?.target || 1))}" />
                  <div class="help">${escapeHtml(targetHelp)}</div>
                </div>
              </div>
              <div class="stepTags" style="margin-top:10px;">
                <button class="btn ghost small" data-action="wizardSuggestTarget" data-value="1">Start at 1</button>
                <button class="btn ghost small" data-action="wizardSuggestTarget" data-value="3">Try 3</button>
                <button class="btn ghost small" data-action="wizardSuggestTarget" data-value="5">Try 5</button>
              </div>
            ` : ''}

            ${step === 3 ? `
              <div class="field">
                <label><span>Identity statement (required)</span>${renderInfoIcon(identityInfo)}</label>
                <input type="text" data-action="wizardInput" data-field="motivator.identity" value="${escapeHtml(draft.motivator?.identity || '')}" placeholder="${escapeHtml(identityPlaceholder)}" maxlength="220" />
                <div class="help">Keep it believable today. It should align with this habit.</div>
              </div>
              <div class="field" style="margin-top:10px;">
                <label><span>Long-term outcome (optional)</span>${renderInfoIcon('Why: It connects today’s action to future you. How: Describe the longer-term benefit in one line.')}</label>
                <input type="text" data-action="wizardInput" data-field="motivator.outcome" value="${escapeHtml(draft.motivator?.outcome || '')}" placeholder="Over time, this enables…" maxlength="260" />
              </div>
              <div class="field" style="margin-top:10px;">
                <label><span>Why it matters (optional)</span>${renderInfoIcon('Why: Motivation fades without a personal reason. How: Note a calm, meaningful reason you can revisit.')}</label>
                <textarea data-action="wizardInput" data-field="motivator.why" maxlength="420" placeholder="A calm reason you can return to.">${escapeHtml(draft.motivator?.why || '')}</textarea>
              </div>
            ` : ''}

            ${step === 4 ? `
              <div class="field">
                <label><span>Implementation intention (If–Then)</span>${renderInfoIcon(isNegative ? 'Write “If [cue], then I will [replacement action].”' : 'Write “If [cue], then I will [action].”')}</label>
                <textarea data-action="wizardInput" data-field="design.plan.ifThen" placeholder="${escapeHtml(ifThenPlaceholder)}">${escapeHtml(draft.design?.plan?.ifThen || '')}</textarea>
              </div>
              <div class="field" style="margin-top:10px;">
                <label><span>Habit stacking (After I…, I will…)</span>${renderInfoIcon(isNegative ? 'Link the cue to a healthier response: “After I [cue], I will [replacement].”' : 'Link the cue to your habit: “After I [existing routine], I will [habit].”')}</label>
                <textarea data-action="wizardInput" data-field="design.plan.cuePlan" placeholder="${escapeHtml(cuePlanPlaceholder)}">${escapeHtml(draft.design?.plan?.cuePlan || '')}</textarea>
                <div class="help">Anchoring to a routine makes follow-through easier.</div>
              </div>
              <div class="help" style="margin-top:10px;">Not sure yet? You can skip these and refine them later in the Plan section.</div>
            ` : ''}

            ${step === 5 ? `
              <div class="field">
                <label><span>${escapeHtml(twoMinuteLabel)}</span>${renderInfoIcon('Why: Tiny versions remove resistance. How: Describe the smallest action you can do even on a busy day.')}</label>
                <input type="text" data-action="wizardInput" data-field="design.plan.twoMinute" value="${escapeHtml(draft.design?.plan?.twoMinute || '')}" placeholder="The smallest possible start" maxlength="240" />
                <div class="help">If you can do this version, you can keep the streak alive.</div>
              </div>
            ` : ''}

            ${step === 6 ? `
              <div class="wizardHint" style="margin-bottom:10px;">Optional: adjust the environment so the right action is easier.</div>
              <div class="grid two">
                <div class="field">
                  <label><span>${escapeHtml(lawLabels.obvious)}</span>${renderInfoIcon('Why: Clear cues prompt action. How: Add a visible reminder or remove the invisible ones.')}</label>
                  <textarea data-action="wizardInput" data-field="design.laws.obvious" placeholder="Place cues where you see them.">${escapeHtml(draft.design?.laws?.obvious || '')}</textarea>
                </div>
                <div class="field">
                  <label><span>${escapeHtml(lawLabels.attractive)}</span>${renderInfoIcon('Why: Attractive actions get repeated. How: Pair this habit with something you already enjoy.')}</label>
                  <textarea data-action="wizardInput" data-field="design.laws.attractive" placeholder="Pair it with something you enjoy.">${escapeHtml(draft.design?.laws?.attractive || '')}</textarea>
                </div>
                <div class="field">
                  <label><span>${escapeHtml(lawLabels.easy)}</span>${renderInfoIcon('Why: Lower friction makes it happen. How: Reduce steps, prep in advance, or make the bad habit harder.')}</label>
                  <textarea data-action="wizardInput" data-field="design.laws.easy" placeholder="Reduce friction (or add it).">${escapeHtml(draft.design?.laws?.easy || '')}</textarea>
                </div>
                <div class="field">
                  <label><span>${escapeHtml(lawLabels.satisfying)}</span>${renderInfoIcon('Why: Immediate rewards lock in behavior. How: Add a small, quick win right after the action.')}</label>
                  <textarea data-action="wizardInput" data-field="design.laws.satisfying" placeholder="Reward the action quickly.">${escapeHtml(draft.design?.laws?.satisfying || '')}</textarea>
                </div>
              </div>
              <div class="help" style="margin-top:10px;">These are optional and can be filled in later from the Plan section.</div>
            ` : ''}

            ${step === 7 ? `
              <div class="wizardPreview">
                <div class="summaryLabel">Preview</div>
                <div style="font-weight:900; margin-top:6px;">${escapeHtml(draft.name || 'Untitled habit')}</div>
                <div class="muted small" style="margin-top:4px;">${escapeHtml(previewDesc)}</div>
                <div class="stepTags" style="margin-top:10px;">
                  <span class="tag muted">${escapeHtml(freqLabel)}</span>
                  <span class="tag ${draft.type === 'negative' ? 'bad' : 'good'}">${draft.type === 'negative' ? 'Break' : 'Build'}</span>
                </div>
                <div class="summaryAction" style="margin-top:10px;">
                  <div class="summaryLabel">Next tiny action</div>
                  <div class="summaryValue">${escapeHtml(previewNext)}</div>
                </div>
              </div>
              <div class="field" style="margin-top:12px;">
                <label><span>${escapeHtml(doneLabel)}</span>${renderInfoIcon(doneInfo)}</label>
                <textarea data-action="wizardInput" data-field="description" maxlength="1200" placeholder="${escapeHtml(donePlaceholder)}">${escapeHtml(draft.description || '')}</textarea>
                <div class="help">This becomes the habit’s short description in your list.</div>
              </div>
              <div class="wizardHint" style="margin-top:10px;">Looks good? Next you’ll save and start tracking.</div>
            ` : ''}

            ${step === 8 ? `
              <div class="wizardHint" style="margin-bottom:10px;">You’re ready. Save the habit now, and log an action only if you already did it today.</div>
              <div class="panel" style="margin-bottom:10px;">
                <div style="font-weight:900; margin-bottom:6px;">You’re ready 🎉</div>
                <div class="muted small">Save your habit, then log a completed tiny action if it already happened today.</div>
              </div>
              <div class="wizardRow">
                <button class="btn primary" data-action="wizardFinish">Finish setup</button>
                <button class="btn ghost" data-action="wizardLogFirst">Log a completed tiny action</button>
              </div>
            ` : ''}

          </div>
        </div>
      `;
    }

    function wizardStepTitle(step, type){
      const titles = [
        'Choose your direction',
        'Name the habit',
        'Pick a frequency',
        'Identity statement',
        'Plan the cue',
        '2-minute version',
        'Make it easier',
        'Preview',
        'Finish setup'
      ];
      return titles[step] || 'Habit setup';
    }

    function wizardStepTag(step){
      const tags = [
        'Build or break',
        'Clear action',
        'Small target',
        'Believable',
        'If–Then / After I (optional)',
        'Make it easy',
        'Optional',
        'What “done” means',
        'Start tracking'
      ];
      return tags[step] || '';
    }

    function updateWizardDraft(path, rawValue){
      if (!appData.ui?.wizard) return;
      const draft = safeObj(appData.ui.wizard.draft);
      let value = rawValue;
      if (path === 'frequency.target'){
        const n = Math.max(1, Math.round(Number(rawValue || 1)));
        value = Number.isFinite(n) ? n : 1;
      }
      setByPath(draft, path, value);
      appData.ui.wizard.draft = draft;
      saveData({ toast:false });
    }

    function wizardValidateStep(step, draft){
      if (step === 1 && !String(draft.name || '').trim()){
        showToast('Name needed', 'Give your habit a clear, action-based name.', { icon:'!' });
        return false;
      }
      if (step === 2){
        const target = Number(draft.frequency?.target || 0);
        if (!Number.isFinite(target) || target <= 0){
          showToast('Pick a target', 'Choose a frequency target of at least 1.', { icon:'!' });
          return false;
        }
      }
      if (step === 3 && !String(draft.motivator?.identity || '').trim()){
        showToast('Identity needed', 'Add a believable identity statement.', { icon:'!' });
        return false;
      }
      if (step === 4){
        const ifThen = String(draft.design?.plan?.ifThen || '').trim();
        const cuePlan = String(draft.design?.plan?.cuePlan || '').trim();
        if (!ifThen && !cuePlan){
          showToast('Optional step', 'You can skip cue planning now and fill it later in the Plan section.', { icon:'✓', ms:2400 });
        }
      }
      if (step === 5){
        const twoMinute = String(draft.design?.plan?.twoMinute || '').trim();
        if (draft.type === 'positive' && !twoMinute){
          showToast('Tiny version needed', 'Add a 2-minute version to make it easy to start.', { icon:'!' });
          return false;
        }
        if (draft.type === 'negative' && !twoMinute){
          showToast('Suggestion', 'Consider adding a 2-minute replacement. You can also add it later.', { icon:'✓', ms:2600 });
        }
      }
      return true;
    }

    function wizardBack(){
      if (!appData.ui?.wizard) return;
      appData.ui.wizard.step = Math.max(0, Number(appData.ui.wizard.step || 0) - 1);
      saveData({ toast:false });
      renderWizardModal();
      triggerHaptic('nav');
    }

    function wizardNext(){
      if (!appData.ui?.wizard) return;
      const step = Number(appData.ui.wizard.step || 0);
      const draft = safeObj(appData.ui.wizard.draft);
      if (!wizardValidateStep(step, draft)) return;
      if (step >= wizardStepsTotal() - 1){
        wizardFinish(false);
        return;
      }
      appData.ui.wizard.step = step + 1;
      saveData({ toast:false });
      renderWizardModal();
      triggerHaptic('primary');
    }

    function wizardFinish(logFirst){
      const wiz = safeObj(appData.ui?.wizard);
      const draft = safeObj(wiz.draft);
      if (appData.habits.length >= MAX_HABITS){
        showToast('Limit reached', `You can have up to ${MAX_HABITS} habits.`, { icon:'!' });
        return;
      }
      const habit = createHabitFromDraft(draft, !!logFirst);
      if (!habit) return;
      if (wiz.mode === 'onboarding'){
        appData.ui.onboardingComplete = true;
      }
      appData.ui.wizard.open = false;
      appData.ui.onboardingActive = false;
      saveData({ toast:true, toastMsg:'Habit created and ready to track.' });
      render();
      triggerHaptic('confirm');

      requestAnimationFrame(() => {
        openHabitDetail(habit.id, 'track');
      });
      closeModal();
    }

    function createHabitFromDraft(draft, logFirst){
      const name = String(draft.name || '').trim();
      if (!name) return null;
      const type = (draft.type === 'negative') ? 'negative' : 'positive';
      const unit = (draft.frequency?.unit === 'week' || draft.frequency?.unit === 'month') ? draft.frequency.unit : 'day';
      const target = Math.max(1, Math.round(Number(draft.frequency?.target || 1)));
      const desc = String(draft.description || '').trim() || (type === 'negative'
        ? `Reduce or resist: ${name}.`
        : `Complete: ${name}.`);
      const iso = todayISO();
      const succ = successStatusForType(type);
      const fail = failStatusForType(type);

      const habit = {
        id: uid(),
        name,
        type,
        description: desc,
        startDate: iso,
        frequency: { unit, target },
        motivator: {
          identity: String(draft.motivator?.identity || '').trim(),
          outcome: String(draft.motivator?.outcome || '').trim(),
          why: String(draft.motivator?.why || '').trim()
        },
        design: {
          loop: { cue:'', craving:'', response:'', reward:'' },
          laws: {
            obvious: String(draft.design?.laws?.obvious || '').trim(),
            attractive: String(draft.design?.laws?.attractive || '').trim(),
            easy: String(draft.design?.laws?.easy || '').trim(),
            satisfying: String(draft.design?.laws?.satisfying || '').trim()
          },
          plan: {
            ifThen: String(draft.design?.plan?.ifThen || '').trim(),
            cuePlan: String(draft.design?.plan?.cuePlan || '').trim(),
            twoMinute: String(draft.design?.plan?.twoMinute || '').trim(),
            friction: { removeCue:false, addDelay:false, addBarrier:false, items: [] }
          }
        },
        logs: {},
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      if (logFirst){
        habit.logs[iso] = {
          date: iso,
          status: succ,
          note: '',
          count: (unit === 'day') ? target : 1,
          auto: false,
          updatedAt: new Date().toISOString()
        };
      } else {
        habit.logs[iso] = {
          date: iso,
          status: fail,
          note: '',
          count: 0,
          auto: true,
          updatedAt: new Date().toISOString()
        };
      }

      appData.habits.push(habit);
      return habit;
    }

    function createHabitFromTemplate(key){
      const t = {
        walk: {
          name: 'Walk after lunch',
          type: 'positive',
          unit: 'week',
          target: 4,
          desc: 'A short walk after lunch. The goal is to start—duration can grow later.',
          ident: 'I am the kind of person who moves daily.',
          outcome: 'More energy and better mood over time.',
          why: 'Because I want a calm, reliable body and mind.'
        },
        read: {
          name: 'Read 10 minutes',
          type: 'positive',
          unit: 'week',
          target: 5,
          desc: 'Read for 10 minutes. If low energy, read 2 minutes.',
          ident: 'I am the kind of person who learns consistently.',
          outcome: 'More clarity and skill over months.',
          why: 'Because I want to keep growing without pressure.'
        },
        no_sugar: {
          name: 'Reduce sugar',
          type: 'negative',
          unit: 'week',
          target: 5,
          desc: 'Track days you resisted added sugar snacks. Relapse is data, not shame.',
          ident: 'I am the kind of person who chooses what helps future-me.',
          outcome: 'More stable energy and fewer cravings.',
          why: 'Because I want steadier days and fewer spikes.'
        }
      }[key];

      if (!t) return;

      const habit = {
        id: uid(),
        name: t.name,
        type: t.type,
        description: t.desc,
        startDate: todayISO(),
        frequency: { unit: t.unit, target: t.target },
        motivator: { identity: t.ident, outcome: t.outcome, why: t.why },
        design: {
          loop: { cue:'', craving:'', response:'', reward:'' },
          laws: { obvious:'', attractive:'', easy:'', satisfying:'' },
          plan: {
            ifThen: '',
            cuePlan: '',
            twoMinute: '',
            friction: { removeCue:false, addDelay:false, addBarrier:false, items: [] }
          }
        },
        logs: {
          [todayISO()]: {
            date: todayISO(),
            status: failStatusForType(t.type),
            note: '',
            count: 0,
            auto: true,
            updatedAt: new Date().toISOString()
          }
        },
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      appData.habits.push(habit);
      appData.ui.createOpen = false;
      appData.ui.onboardingComplete = true;
      saveData({ toast:true, toastMsg:'Starter habit created. Tap “Done” for your first win.' });
      render();

      requestAnimationFrame(() => {
        openHabitDetail(habit.id, 'track');
      });
    }

    function getTodayCompletionState(habits){
      const list = safeArr(habits);
      const iso = todayISO();
      let doneCount = 0;

      list.forEach(h => {
        const e = safeObj(safeObj(h.logs)[iso]);
        const succ = successStatusForType(h.type);
        const unit = safeObj(h.frequency).unit;
        const target = Math.max(1, Math.round(Number(safeObj(h.frequency).target) || 1));
        const st = String(e.status || '').toLowerCase();
        const done = (unit === 'day')
          ? (st === succ && Number(e.count || 0) >= target)
          : (st === succ);
        if (done) doneCount += 1;
      });

      return {
        total: list.length,
        doneCount,
        remaining: Math.max(0, list.length - doneCount),
        allDone: list.length > 0 && doneCount === list.length
      };
    }

    function renderTodaySummary(){
      const habits = safeArr(appData.habits);
      const completion = getTodayCompletionState(habits);

      const allDone = completion.allDone && completion.total > 0;
      const focusLabel = allDone ? 'Celebrate' : 'Focus';
      const focusAction = allDone ? 'celebrateDay' : 'openTodayFocus';
      const completionLine = `${completion.doneCount}/${completion.total} complete`;
      const ratio = completion.total ? clamp(completion.doneCount / completion.total, 0, 1) : 0;
      const progressLeft = allDone ? 'All done' : `${completion.remaining} left`;

      return `
        <div class="todaySummary ${allDone ? 'done' : ''}">
          <div class="todaySummaryInfo">
            <div class="todaySummaryRow">
              <div class="todaySummaryTitle">
                <span>Today</span>
                <span class="tag ${allDone ? 'good' : 'muted'}">${completionLine}</span>
              </div>
              <div class="todaySummaryActions">
                <button class="btn small primary" data-action="${focusAction}">${focusLabel}</button>
              </div>
            </div>
          </div>
          <div class="todayProgressRow" aria-label="Today progress">
            <div class="todayProgressMeta">${completion.doneCount}/${completion.total}</div>
            <div class="todayMeter" aria-hidden="true">
              <div class="todayMeterFill" style="--p:${ratio.toFixed(3)}"></div>
            </div>
            <div class="todayProgressMeta">${progressLeft}</div>
          </div>
        </div>
      `;
    }

    function updateTodayCard({ animate=false } = {}){
      const slot = document.getElementById('todayHeaderSummary');
      if (!slot) return;
      const card = slot.closest('.todayCard');
      if (!appData.habits.length){
        slot.innerHTML = '';
        if (card){
          card.classList.remove('done', 'celebrate');
        }
        return;
      }
      const prevSummary = slot.querySelector('.todaySummary');
      const wasDone = !!prevSummary && prevSummary.classList.contains('done');
      slot.innerHTML = renderTodaySummary();
      const nextSummary = slot.querySelector('.todaySummary');
      const isDone = !!nextSummary && nextSummary.classList.contains('done');
      if (card){
        card.classList.toggle('done', isDone);
      }
      if (card && animate && !wasDone && isDone){
        card.classList.add('celebrate');
        setTimeout(() => card.classList.remove('celebrate'), 800);
      }
    }

    function renderTodayFocusBody(){
      const habits = safeArr(appData.habits);
      const completion = getTodayCompletionState(habits);

      const rows = habits.map(h => {
        const s = dashboardState(h);
        const isDone = (s.btnLabel === 'Reset' || s.btnLabel === 'Undo');
        const plan = safeObj(safeObj(h.design).plan);
        const twoMinute = String(plan.twoMinute || '').trim();
        const hint = twoMinute ? `2-minute: ${escapeHtml(twoMinute)}` : '';
        const unit = safeObj(h.frequency).unit;
        const target = Math.max(1, Math.round(Number(safeObj(h.frequency).target) || 1));
        const countControls = (unit === 'day' && target > 1) ? `
          <div class="countControls" role="group" aria-label="Adjust today count">
            <button class="btn ghost small" data-action="adjustCount" data-habit="${escapeHtml(h.id)}" data-delta="-1" aria-label="Decrease count">−</button>
            <div class="countValue">${escapeHtml(s.labelRight)}</div>
            <button class="btn ghost small" data-action="adjustCount" data-habit="${escapeHtml(h.id)}" data-delta="1" aria-label="Increase count">+</button>
          </div>
        ` : '';

        return `
          <div class="panel focusItem ${isDone ? 'completed' : ''}" style="margin-bottom:10px;">
            <div class="focusRow">
              <div class="focusMain">
                <div class="focusTitle nowrapEllip">${escapeHtml(h.name || 'Untitled habit')}</div>
                <div class="focusMeta">
                  ${escapeHtml(formatUnit(h.frequency.unit, h.frequency.target))} • ${escapeHtml(s.labelRight)}
                </div>
                ${hint ? `<div class="focusHint">${hint}</div>` : ''}
              </div>
              <div class="focusActions">
                ${countControls}
                <button
                  class="btn small ${escapeHtml(s.btnClass)}"
                  data-action="dashToggle"
                  data-habit="${escapeHtml(h.id)}"
                >${escapeHtml(s.btnLabel)}</button>
              </div>
            </div>
            <div class="sumProgressStrip focusProgress">
              <div class="sumProgressFill" style="--p:${clamp(s.ratio,0,1).toFixed(3)}"></div>
            </div>
          </div>
        `;
      }).join('');

      const doneCard = completion.allDone && completion.total > 0 ? `
        <div class="panel focusCelebrate" style="margin-top:12px;">
          <div style="font-weight:950; margin-bottom:6px;">You’re done for today</div>
          <div class="muted small">Nice work. Close the loop and enjoy the rest of your day.</div>
          <div style="margin-top:10px;">
            <button class="btn primary" data-action="celebrateDay">Celebrate</button>
          </div>
        </div>
      ` : '';

      return `
        <div class="muted small" style="margin-bottom:8px;">
          Quick check-in. No shame. If you miss, it’s data.
        </div>
        <div id="todayFocusList">${rows || '<div class="panel"><div class="muted small">No habits yet.</div></div>'}</div>
        ${doneCard}
      `;
    }

    function openTodayFocus(){
      openModal(
        'Today Focus',
        renderTodayFocusBody(),
        `<button class="btn primary" data-action="closeModal">Done</button>`
      );
    }

    function celebrateDay(){
      const completion = getTodayCompletionState(appData.habits);
      if (!completion.total) return;
      const quote = getCelebrateQuote();
      openModal(
        'All done today',
        `
          <div class="panel celebrateCard">
            <div style="font-weight:950; margin-bottom:6px;">You did it.</div>
            <div class="muted small" style="margin-bottom:8px;">
              ${completion.doneCount} of ${completion.total} habits completed today. Keep it gentle and sustainable.
            </div>
            <div class="summaryAction" style="margin-top:8px;">
              <div class="summaryLabel">Encouragement</div>
              <div class="summaryValue">${escapeHtml(quote)}</div>
            </div>
          </div>
        `,
        `<button class="btn primary" data-action="closeModal">Close</button>`
      );

      document.querySelectorAll('.celebrateOverlay').forEach(el => el.remove());
      const overlay = document.createElement('div');
      overlay.className = 'celebrateOverlay';
      document.body.appendChild(overlay);
      overlay.addEventListener('animationend', () => overlay.remove(), { once: true });
    }

    function maybeCelebrateDay(){
      const completion = getTodayCompletionState(appData.habits);
      if (!completion.allDone) return;
      const iso = todayISO();
      appData.ui = safeObj(appData.ui);
      if (appData.ui.lastCelebratedISO === iso) return;
      appData.ui.lastCelebratedISO = iso;
      saveData({ toast:false });
      showToast('All habits complete', 'You kept every promise today. Enjoy the calm momentum.', { icon:'🎉', ms:4500 });
    }

    function isReviewComplete(weekISO){
      const w = safeObj(appData.reviews?.[weekISO]?.global);
      const any = ['wins','learn','next','identity'].some(k => String(w[k] || '').trim().length > 0);
      return any;
    }

    function renderReviewNudge(){
      const weekISO = getReviewWeekISO();
      if (isReviewComplete(weekISO)) return '';

      appData.ui = safeObj(appData.ui);
      if (appData.ui.reviewNudgeDismissed === weekISO) return '';

      return `
        <div class="card heroCard">
          <div class="cardHeader">
            <div class="left">
              <p class="hTitle">Weekly review is ready</p>
              <div class="hMeta">
                <span class="muted2">One tweak can make next week easier.</span>
              </div>
            </div>
            <div class="right">
              <button class="btn small ghost" data-action="dismissReviewNudge" data-week="${escapeHtml(weekISO)}">Dismiss</button>
              <button class="btn small primary" data-action="switchTab" data-tab="review">Open</button>
            </div>
          </div>
        </div>
      `;
    }

    function applyActiveTab(){
      const tab = appData.ui.activeTab || 'dashboard';
      $$('.section').forEach(s => s.classList.remove('active'));
      const el = $(`#tab-${tab}`);
      if (el) el.classList.add('active');
    }

    function maybeTriggerOnboarding(){
      if (appData.habits.length > 0) return;
      if (appData.ui.onboardingComplete) return;
      if (appData.ui.onboardingSeen) return;
      if (appData.ui.onboardingActive) return;
      appData.ui.onboardingActive = true;
      appData.ui.onboardingSeen = true;
      saveData({ toast:false });
      openWizard('onboarding');
    }

    function renderDashboard(){
      const root = $('#tab-dashboard');
      const createOpen = !!appData.ui.createOpen;

      const habitCount = appData.habits.length;
      const canCreate = habitCount < MAX_HABITS;
      const completion = getTodayCompletionState(appData.habits);
      const soundOn = appData.ui.soundEnabled !== false;
      const soundLabel = soundOn ? 'Sound on' : 'Sound off';

      const onboarding = (habitCount === 0) ? renderOnboardingHero() : '';
      const todaySummary = (habitCount > 0) ? renderTodaySummary() : '';
      const todayDone = completion.allDone && completion.total > 0;
      const reviewNudge = (habitCount > 0) ? renderReviewNudge() : '';

      const createInline = `
        <div class="createInline ${createOpen ? 'open' : ''}" id="createWrap">
          <div class="createInlineBody" aria-label="Quick add habit form">
            ${canCreate ? renderCreateForm() : `
              <div class="error">
                You’ve reached the maximum of ${MAX_HABITS} habits. If you want, delete one first (you can export a backup before deleting).
              </div>
            `}
          </div>
        </div>
      `;

      const createHtml = `
        ${onboarding}
        <div class="dashboardStack">
          <div class="card heroCard todayCard ${todayDone ? 'done' : ''}">
            <div class="todayCardBody">
              <div id="todayHeaderSummary">${todaySummary}</div>
            </div>
          </div>

          <div class="card habitsHero">
            <div class="cardHeader habitsHeader">
              <div class="left">
                <p class="hTitle">Habits</p>
              </div>
              <div class="right">
                <button class="btn small ghost iconButton" data-action="toggleSound" data-sound-icon="true" aria-pressed="${soundOn ? 'true' : 'false'}" aria-label="${soundLabel}" title="${soundLabel}">
                  <span aria-hidden="true">${soundOn ? '🔊' : '🔇'}</span>
                  <span class="sr-only">${soundLabel}</span>
                </button>
              </div>
            </div>
            <div class="habitsActions">
              <button class="btn small primary" data-action="startCreateWizard">Guided setup</button>
              <button class="btn small ghost" data-action="toggleCreate" aria-expanded="${createOpen ? 'true':'false'}">
                ${createOpen ? 'Hide quick add' : 'Quick add'}
              </button>
            </div>
            ${createInline}
            ${renderHabitList()}
            <div class="cardFooter">
              <div class="muted small">${habitCount}/${MAX_HABITS} habits • Back up your habits to keep them safe offline.</div>
              <button class="btn small ghost" data-action="quickBackup" title="Backup (recommended)">Backup</button>
            </div>
          </div>

          ${reviewNudge}
        </div>
      `;

      root.innerHTML = createHtml;
      cleanupSubtabArtifacts();

      // After render, hydrate charts for any open habits (details open)
      hydrateVisibleCharts();
    }

    function cleanupSubtabArtifacts(){
      $$('.subtabs').forEach((subtabs) => {
        [...subtabs.childNodes].forEach((node) => {
          if (node.nodeType !== Node.TEXT_NODE) return;
          const text = node.textContent || '';
          if (text.includes('aria-selected') || text.includes('tabindex')){
            node.remove();
          }
        });
      });
    }

function renderCreateForm(){
  return `
        <div class="quickCreate">
          <div class="panel">
            <div style="font-weight:950; margin-bottom:8px;">Essentials</div>
            <div class="muted small" style="margin-bottom:10px;">
              Add the essential details now. You can refine cues, plans, and insights later.
            </div>
            <div class="grid two">
              <div class="field">
                <label>Habit name</label>
                <input id="c_name" type="text" placeholder="e.g., Walk after lunch" maxlength="120" />
              </div>
              <div class="field">
                <label>Habit type</label>
                <select id="c_type">
                  <option value="positive" selected>Build</option>
                  <option value="negative">Break</option>
                </select>
              </div>
              <div class="field">
                <label>Start date</label>
                <input id="c_start" type="date" value="${todayISO()}" />
              </div>
              <div class="field">
                <label>Identity statement</label>
                <input id="c_ident" type="text" placeholder="I am the kind of person who..." maxlength="220" />
                <div class="help">Required. Keep it kind and actionable.</div>
              </div>
              <div class="field" style="grid-column:1/-1;">
                <label>Definition of success</label>
                <textarea id="c_desc" placeholder="Define success in one sentence." maxlength="1200"></textarea>
              </div>
            </div>
            <div class="inline freqRow" style="margin-top:12px;">
              <div class="field compact">
                <label>Frequency unit</label>
                <select id="c_unit">
                  <option value="day" selected>Per day</option>
                  <option value="week">Per week</option>
                  <option value="month">Per month</option>
                </select>
              </div>
              <div class="field compact2">
                <label>Target</label>
                <input id="c_target" type="number" min="1" step="1" value="1" inputmode="numeric" />
              </div>
            </div>
          </div>

          <div class="panel">
            <div style="font-weight:900; margin-bottom:6px;">Motivation (optional)</div>
            <div class="grid two">
              <div class="field">
                <label>Long-term outcome</label>
                <input id="c_outcome" type="text" placeholder="Over time, this enables..." maxlength="260" />
              </div>
              <div class="field" style="grid-column:1/-1;">
                <label>Why this matters</label>
                <textarea id="c_why" placeholder="A calm reason you can return to." maxlength="420"></textarea>
              </div>
            </div>
          </div>

          <div id="createErr"></div>

          <div class="wizardFooter">
            <button class="btn ghost" data-action="cancelCreate">Cancel</button>
            <button class="btn primary" data-action="saveCreate">Create habit</button>
          </div>
        </div>
      `;
    }

function dashboardState(h){
  const iso = todayISO();
  const entry = safeObj(safeObj(h.logs)[iso]);

  const unit = safeObj(h.frequency).unit;
  const target = Math.max(1, Math.round(Number(safeObj(h.frequency).target) || 1));
  const succ = successStatusForType(h.type);
  const fail = failStatusForType(h.type);

  const st = String(entry.status || '').toLowerCase();
  const doneToday = (st === succ);

  // For day-unit habits, allow count-based progress (but dashboard button completes in one tap)
  if (unit === 'day'){
    let c = Number(entry.count);
    if (!Number.isFinite(c) || c < 0) c = doneToday ? target : 0;
    c = clamp(Math.round(c), 0, target);
    const ratio = clamp(c / target, 0, 1);

    const isDone = doneToday && c >= target;
    const btnLabel = isDone ? 'Reset' : (h.type === 'negative' ? 'Resist' : 'Done');
    const btnClass = isDone ? 'ghost' : 'primary';

    return { labelLeft:'Today', labelRight:`${c}/${target}`, ratio, btnLabel, btnClass, succ, fail };
  }

  // For week/month habits: dashboard shows TODAY only (binary)
  const ratio = doneToday ? 1 : 0;
  const btnLabel = doneToday ? 'Undo' : (h.type === 'negative' ? 'Resist' : 'Done');
  const btnClass = doneToday ? 'ghost' : 'primary';
  const labelRight = doneToday ? (h.type === 'negative' ? 'Resisted' : 'Done') : 'Not yet';

  return { labelLeft:'Today', labelRight, ratio, btnLabel, btnClass, succ, fail };
}


function renderDashboardQuick(h){
  const s = dashboardState(h);
  return `
    <div class="habitProgress dashMini" id="dash-${escapeHtml(h.id)}-mini">
      <div class="sumProgressStrip" aria-label="Today progress">
        <div class="sumProgressFill" style="--p:${clamp(s.ratio,0,1).toFixed(3)}"></div>
      </div>
      <div class="habitProgressLabel" data-sum="progress" data-habit="${escapeHtml(h.id)}">${escapeHtml(s.labelRight)}</div>
    </div>
  `;
}

function updateDashboardQuick(habitId){
  const h = getHabit(habitId);
  if (!h) return;

  const s = dashboardState(h);
  const isDone = clamp(s.ratio, 0, 1) >= 1;
  const statusLabel = isDone
    ? (h.type === 'negative' ? 'Resisted today' : 'Completed today')
    : 'In progress';

  // Update every dashboard toggle button for this habit (prevents mismatched labels)
  document
    .querySelectorAll(`button[data-action="dashToggle"][data-habit="${cssEscape(habitId)}"]`)
    .forEach((btn) => {
      btn.textContent = s.btnLabel;
      btn.classList.toggle('primary', s.btnClass === 'primary');
      btn.classList.toggle('ghost', s.btnClass === 'ghost');
    });

  document
    .querySelectorAll(`[data-sum="today"][data-habit="${cssEscape(habitId)}"]`)
    .forEach((el) => {
      el.textContent = `Today: ${s.labelRight}`;
    });

      document
    .querySelectorAll(`[data-sum="progress"][data-habit="${cssEscape(habitId)}"]`)
    .forEach((el) => {
      el.textContent = s.labelRight;
    });

  document
    .querySelectorAll(`[data-sum="status"][data-habit="${cssEscape(habitId)}"]`)
    .forEach((el) => {
      el.textContent = statusLabel;
      el.classList.toggle('done', isDone);
    });

  document
    .querySelectorAll(`.habitItem[data-habit="${cssEscape(habitId)}"]`)
    .forEach((el) => {
      el.classList.toggle('completed', isDone);
      const icon = el.querySelector('.habitStatusIcon');
      if (icon) icon.textContent = isDone ? '✓' : '○';
    });

  // Update the progress bar for this habit (supports either fill class name)
  const mini = document.getElementById(`dash-${habitId}-mini`);
  if (mini){
    const fill = mini.querySelector('.fill') || mini.querySelector('.sumProgressFill');
    if (fill) fill.style.setProperty('--p', clamp(s.ratio, 0, 1).toFixed(3));
  }
}


function pulseDashboardQuick(habitId){
  const mini = document.getElementById(`dash-${habitId}-mini`);
  if (!mini) return;
  mini.classList.add('celebrate');
  setTimeout(() => mini.classList.remove('celebrate'), 900);
}

// New: celebratory habit card burst when a habit is completed.
function celebrateHabitCard(habitId){
  const card = document.querySelector(`.habitItem[data-habit="${cssEscape(habitId)}"]`);
  if (!card) return;
  card.classList.remove('celebrate');
  void card.offsetWidth;
  card.classList.add('celebrate');
  setTimeout(() => card.classList.remove('celebrate'), 900);
}

// New: sparkle the status icon when a new streak record is reached.
function sparkleStatusIcon(habitId){
  const icon = document.querySelector(`.habitItem[data-habit="${cssEscape(habitId)}"] .habitStatusIcon`);
  if (!icon) return;
  icon.classList.remove('sparkle');
  void icon.offsetWidth;
  icon.classList.add('sparkle');
  setTimeout(() => icon.classList.remove('sparkle'), 900);
}

function dashToggle(habitId){
  const h = getHabit(habitId);
  if (!h) return;

  const iso = todayISO();
  if (!h.logs || typeof h.logs !== 'object') h.logs = {};

  const entry = h.logs[iso] ? safeObj(h.logs[iso]) : null;
  const succ = successStatusForType(h.type);
  const fail = failStatusForType(h.type);

  const unit = safeObj(h.frequency).unit;
  const target = Math.max(1, Math.round(Number(safeObj(h.frequency).target) || 1));

  // Ensure an entry exists (default is uncompleted)
  if (!h.logs[iso]){
    h.logs[iso] = { date: iso, status: fail, note:'', count:0, auto:true, updatedAt: new Date().toISOString() };
  }

  const e = h.logs[iso];
  e.auto = false; // user interacted

  if (unit === 'day'){
    let c = Number(e.count);
    if (!Number.isFinite(c) || c < 0) c = (String(e.status || '').toLowerCase() === succ) ? target : 0;
    c = Math.round(c);

    const isDone = (String(e.status || '').toLowerCase() === succ) && c >= target;

    if (unit === 'day'){
  const st = String(e.status || '').toLowerCase();
  let c = Number(e.count);
  if (!Number.isFinite(c) || c < 0) c = (st === succ) ? target : 0;
  c = Math.round(c);

  const isDone = (st === succ) && c >= target;

    if (isDone){
      // Reset
      e.status = fail;
      e.count = 0;
      e.updatedAt = new Date().toISOString();
      if (h.type === 'negative'){
        showToast('Relapse noted', 'No shame. Adjust the environment for the next cue.', { icon:'↺', ms:2400 });
      } else {
        showToast('Reset', 'Reset for today. You can log it again anytime.', { icon:'↺', ms:1800 });
      }
    } else {
      // One tap = complete the full daily target
      e.status = succ;
      e.count = target;
      e.updatedAt = new Date().toISOString();
      showToast('Done', motivationalLine(h), { icon:'✓', ms:5000 });
      playSuccessChime();
      triggerHaptic('confirm');
      pulseEl(document.querySelector(`button[data-action="dashToggle"][data-habit="${cssEscape(habitId)}"]`));
      celebrateHabitCard(habitId);
      const currentStreak = currentDailyStreak(h);
      const bestStreak = getBestStreak(h);
      if (currentStreak > bestStreak){
        setBestStreak(h, currentStreak);
        sparkleStatusIcon(habitId);
      }
    }
}

  } else {
    const st = String(e.status || '').toLowerCase();
    if (st === succ){
      e.status = fail;
      e.count = 0;
      e.updatedAt = new Date().toISOString();
      if (h.type === 'negative'){
        showToast('Relapse noted', 'No shame. Look for a cue you can remove or delay.', { icon:'↺', ms:2400 });
      } else {
        showToast('Undid for today', 'Your log was updated.', { icon:'↺', ms:1800 });
      }
    } else {
      e.status = succ;
      e.count = 1;
      e.updatedAt = new Date().toISOString();
      showToast('Done', motivationalLine(h), { icon:'✓', ms:2600 });
      playSuccessChime();
      triggerHaptic('confirm');
      pulseEl(document.querySelector(`button[data-action="dashToggle"][data-habit="${cssEscape(habitId)}"]`));
      celebrateHabitCard(habitId);
      const currentStreak = currentDailyStreak(h);
      const bestStreak = getBestStreak(h);
      if (currentStreak > bestStreak){
        setBestStreak(h, currentStreak);
        sparkleStatusIcon(habitId);
      }
    }
  }

  h.updatedAt = new Date().toISOString();
  saveData({ toast:false });

  updateHabitVisuals(habitId);
  updateDashboardQuick(habitId);
  hydrateVisibleCharts();
  pulseDashboardQuick(habitId);
  updateTodayCard({ animate:true });
  maybeCelebrateDay();

  const list = document.getElementById('todayFocusList');
  if (list && $('#modal').classList.contains('active')){
    $('#modalBody').innerHTML = renderTodayFocusBody();
  }
}

function adjustDailyCount(habitId, delta){
  const h = getHabit(habitId);
  if (!h) return;

  const unit = safeObj(h.frequency).unit;
  if (unit !== 'day') return;

  const iso = todayISO();
  if (!h.logs || typeof h.logs !== 'object') h.logs = {};
  if (!h.logs[iso]){
    h.logs[iso] = { date: iso, status: failStatusForType(h.type), note:'', count:0, auto:true, updatedAt: new Date().toISOString() };
  }
  const e = h.logs[iso];
  const succ = successStatusForType(h.type);
  const fail = failStatusForType(h.type);
  const target = Math.max(1, Math.round(Number(safeObj(h.frequency).target) || 1));
  let c = Number(e.count || 0);
  if (!Number.isFinite(c) || c < 0) c = 0;
  c = clamp(Math.round(c + delta), 0, target);
  e.count = c;
  e.status = c > 0 ? succ : fail;
  e.auto = false;
  e.updatedAt = new Date().toISOString();

  h.updatedAt = new Date().toISOString();
  saveData({ toast:false });
  updateHabitVisuals(habitId);
  updateDashboardQuick(habitId);
  hydrateVisibleCharts();
  updateTodayCard({ animate:true });
  maybeCelebrateDay();

  if ($('#modal').classList.contains('active')){
    $('#modalBody').innerHTML = renderTodayFocusBody();
  }
}

function renderTabIcon(name){
  const base = (paths) => `
    <span class="tabIcon" aria-hidden="true">
      <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
        ${paths.map(p => `<path d="${p}" />`).join('')}
      </svg>
    </span>
  `;

  switch (name){
    case 'track':
      return base(['M5 13l4 4L19 7']);
    case 'design':
      return base(['M4 6h16', 'M4 12h16', 'M4 18h10']);
    case 'insights':
      return base(['M4 18l6-6 4 4 6-8']);
    case 'motivation':
      return base(['M12 21s-6-4.35-8.5-7.5A5 5 0 0 1 12 6a5 5 0 0 1 8.5 7.5C18 16.65 12 21 12 21z']);
    case 'edit':
      return base(['M3 21h6', 'M14 4l6 6', 'M4 16l10-10 4 4-10 10H4v-4z']);
    default:
      return base(['M5 13l4 4L19 7']);
  }
}

function habitSubtabLabel(subtab){
  switch (subtab){
    case 'track':
      return 'Track';
    case 'design':
      return 'Plan';
    case 'insights':
      return 'Insights';
    case 'edit':
      return 'Edit';
    default:
      return 'Track';
  }
}

function renderHabitSubtabs(h, subtab, { footer = false } = {}){
  const wrapperClass = footer ? 'subtabs subtabsFooter' : 'subtabs';
  return `
    <div class="${wrapperClass}" role="tablist" aria-label="Habit sections">
      <button class="tabBtn ${subtab==='track'?'active':''}"
        id="tab-${escapeHtml(h.id)}-track"
        data-action="habitSubtab" data-habit="${escapeHtml(h.id)}" data-subtab="track"
        aria-selected="${subtab==='track'?'true':'false'}" tabindex="${subtab==='track'?'0':'-1'}">
        ${renderTabIcon('track')}
        <span>Track</span>
      </button>

      <button class="tabBtn ${subtab==='design'?'active':''}"
        id="tab-${escapeHtml(h.id)}-design"
        data-action="habitSubtab" data-habit="${escapeHtml(h.id)}" data-subtab="design"
        aria-selected="${subtab==='design'?'true':'false'}" tabindex="${subtab==='design'?'0':'-1'}">
        ${renderTabIcon('design')}
        <span>Plan</span>
      </button>

      <button class="tabBtn ${subtab==='insights'?'active':''}"
        id="tab-${escapeHtml(h.id)}-insights"
        data-action="habitSubtab" data-habit="${escapeHtml(h.id)}" data-subtab="insights"
        aria-selected="${subtab==='insights'?'true':'false'}" tabindex="${subtab==='insights'?'0':'-1'}">
        ${renderTabIcon('insights')}
        <span>Insights</span>
      </button>

      <button class="tabBtn ${subtab==='edit'?'active':''}"
        id="tab-${escapeHtml(h.id)}-edit"
        data-action="habitSubtab" data-habit="${escapeHtml(h.id)}" data-subtab="edit"
        aria-selected="${subtab==='edit'?'true':'false'}" tabindex="${subtab==='edit'?'0':'-1'}">
        ${renderTabIcon('edit')}
        <span>Edit</span>
      </button>
    </div>
  `;
}

function getHabitSubtab(habitId){
  appData.ui = safeObj(appData.ui);
  const rawSubtab = appData.ui.habitSubtabs?.[habitId] || 'track';
  const subtab = ['track','design','insights','edit'].includes(rawSubtab) ? rawSubtab : 'track';
  if (rawSubtab !== subtab){
    appData.ui = safeObj(appData.ui);
    appData.ui.habitSubtabs = safeObj(appData.ui.habitSubtabs);
    appData.ui.habitSubtabs[habitId] = subtab;
    scheduleSave();
  }
  return subtab;
}


function renderHabitList(){
  const habits = safeArr(appData.habits);
  if (!habits.length){
    return `
      <div class="content">
        <div class="panel">
          <div style="font-weight:950; margin-bottom:6px;">Start with one small habit</div>
          <div class="muted small">Create your first habit. Start small, make it obvious, and let the system carry you.</div>
        </div>
      </div>
    `;
  }

  const items = habits.map(h => {
    const isNeg = h.type === 'negative';
    const tagClass = isNeg ? 'bad' : 'good';
    const typeLabel = isNeg ? 'Negative' : 'Positive';
    const freqTxt = formatUnit(h.frequency.unit, h.frequency.target);
    const s = dashboardState(h);
    const isDone = clamp(s.ratio, 0, 1) >= 1;
    const statusLabel = isDone
      ? (isNeg ? 'Resisted today' : 'Completed today')
      : 'In progress';
    const statusIcon = isDone ? '✓' : '○';

    return `
      <div class="habitItem ${isDone ? 'completed' : ''}" id="habit-${escapeHtml(h.id)}" data-habit="${escapeHtml(h.id)}" data-action="openHabitDetail" role="button" tabindex="0" aria-label="Open ${escapeHtml(h.name || 'habit')} details">
        <div class="habitTop">
          <div class="habitInfo">
            <div class="habitTitleRow">
              <div class="habitName" data-sum="name" data-habit="${escapeHtml(h.id)}">${escapeHtml(h.name || 'Untitled habit')}</div>
              <span class="tag ${tagClass}">${typeLabel}</span>
              <span class="tag muted" data-sum="freq" data-habit="${escapeHtml(h.id)}">${escapeHtml(freqTxt)}</span>
              <span class="habitStatusPill ${isDone ? 'done' : ''}" data-sum="status" data-habit="${escapeHtml(h.id)}">${escapeHtml(statusLabel)}</span>
            </div>
            <div class="habitDesc" data-sum="desc" data-habit="${escapeHtml(h.id)}">${escapeHtml(h.description || '')}</div>
          </div>

          <div class="habitActions">
            <div class="habitStatusIcon" aria-hidden="true">${statusIcon}</div>
            <button
              class="btn small ${escapeHtml(s.btnClass)} dashBtn"
              data-action="dashToggle"
              data-habit="${escapeHtml(h.id)}"
              aria-label="Mark ${escapeHtml(h.name || 'habit')} for today"
            >${escapeHtml(s.btnLabel)}</button>
          </div>
        </div>

        <div class="habitMetaRow">
          <div class="chev">View details →</div>
        </div>

        ${renderDashboardQuick(h)}
      </div>
    `;
  }).join('');

  return `<div class="habitList">${items}</div>`;
}

function renderHabitDetailBody(h){
  const isNeg = h.type === 'negative';
  const tagClass = isNeg ? 'bad' : 'good';
  const typeLabel = isNeg ? 'Negative' : 'Positive';
  const freqTxt = formatUnit(h.frequency.unit, h.frequency.target);

  const prog = periodProgress(h);
  const c7 = windowConsistencyPercent(h, 7);
  const subtab = getHabitSubtab(h.id);

  const succStatus = successStatusForType(h.type);
  const failStatus = failStatusForType(h.type);
  const subtabLabel = habitSubtabLabel(subtab);

  return `
    <div id="habit-modal-${escapeHtml(h.id)}">
      <div class="panel" style="margin-bottom:12px;">
        <div class="summaryHeader">
          <div>
            <div class="summaryLabel">Habit</div>
            <div class="summaryValue" data-sum="name" data-habit="${escapeHtml(h.id)}">${escapeHtml(h.name || 'Untitled habit')}</div>
            <div class="summaryMeta" data-sum="desc" data-habit="${escapeHtml(h.id)}">${escapeHtml(h.description || '')}</div>
          </div>
          <div class="row">
            <span class="tag ${tagClass}">${typeLabel}</span>
            <span class="tag muted" data-sum="freq" data-habit="${escapeHtml(h.id)}">${escapeHtml(freqTxt)}</span>
          </div>
        </div>
      </div>

      <div class="detailsBody" style="border-top:none; padding:0;">
        <div id="habit-${escapeHtml(h.id)}-summary">
          ${renderHabitSummary(h, { prog, c7 })}
        </div>

        <div class="detailTitleBar" id="habit-${escapeHtml(h.id)}-titlebar">
          <span>${escapeHtml(subtabLabel)}</span>
        </div>

        <div class="detailPanels">
          <div class="panel ${subtab==='track'?'':'hidden'}" id="panel-${escapeHtml(h.id)}-track" role="tabpanel" aria-labelledby="tab-${escapeHtml(h.id)}-track">
            ${renderHabitTrackPanel(h, { succStatus, failStatus })}
          </div>

          <div class="panel ${subtab==='design'?'':'hidden'}" id="panel-${escapeHtml(h.id)}-design" role="tabpanel" aria-labelledby="tab-${escapeHtml(h.id)}-design">
            ${renderHabitDesignPanel(h)}
          </div>

          <div class="panel ${subtab==='insights'?'':'hidden'}" id="panel-${escapeHtml(h.id)}-insights" role="tabpanel" aria-labelledby="tab-${escapeHtml(h.id)}-insights">
            ${renderHabitInsightsPanel(h)}
          </div>

          <div class="panel ${subtab==='edit'?'':'hidden'}" id="panel-${escapeHtml(h.id)}-edit" role="tabpanel" aria-labelledby="tab-${escapeHtml(h.id)}-edit">
            ${renderHabitEditPanel(h)}
          </div>
      </div>
    </div>
  `;
}

function openHabitDetail(habitId, subtab){
  const h = getHabit(habitId);
  if (!h) return;

  if (!appData.ui.habitSubtabs) appData.ui.habitSubtabs = {};
  if (subtab) appData.ui.habitSubtabs[habitId] = subtab;

  appData.ui.activeHabitId = habitId;
  saveData({ toast:false });
  const activeSubtab = getHabitSubtab(habitId);

  openModal(
    h.name || 'Habit details',
    renderHabitDetailBody(h),
    renderHabitSubtabs(h, activeSubtab, { footer: true }),
    { centered:true }
  );
  setTimeout(hydrateVisibleCharts, 0);
}


    function renderHabitSummary(h, pre){
      const isNeg = h.type === 'negative';
      const prog = pre?.prog || periodProgress(h);
      const c7 = pre?.c7 ?? windowConsistencyPercent(h, 7);
      const freqTxt = formatUnit(h.frequency.unit, h.frequency.target);

      const ratio = clamp(prog.ratio, 0, 1);

      const identity = (safeObj(h.motivator).identity || '').trim();
      const plan = safeObj(safeObj(h.design).plan);
      const ifThen = String(plan.ifThen || '').trim();
      const cuePlan = String(plan.cuePlan || '').trim();
      const twoMinute = String(plan.twoMinute || '').trim();

      const nextAction = twoMinute || ifThen || cuePlan || (isNeg
        ? 'Pause, name the cue, and choose your replacement.'
        : 'Start with a 2‑minute version to get moving.');
      const nextLabel = isNeg ? 'Next replacement action' : 'Next tiny action';
      const desc = String(h.description || '').trim() || (isNeg
        ? 'Reduce or avoid this habit with a kinder, easier alternative.'
        : 'A clear action you can complete in one sitting.');

      const msgA = isNeg
        ? 'Every resisted urge strengthens your system.'
        : 'Every completion strengthens your identity.';
      const msgB = identity
        ? `Identity: “${identity}”`
        : 'Identity: “I return to the path.”';
      const msg = `${msgA} ${msgB}`;

      const y = canUseShieldForYesterday(h);
      const shieldUI = y ? `
        <div class="panel" style="margin-top:12px;">
          <div style="font-weight:950; margin-bottom:6px;">Streak recovery</div>
          <div class="muted small" style="margin-bottom:10px;">
            Yesterday didn’t go to plan. Want to protect your streak once this week?
          </div>
          <button class="btn small primary" data-action="useShield" data-habit="${escapeHtml(h.id)}" data-date="${escapeHtml(y)}">
            Use streak shield for ${escapeHtml(y)}
          </button>
        </div>
      ` : '';

      return `
        <div class="summaryCard" aria-label="Progress summary">
          <div class="summaryHeader">
            <div>
              <div class="summaryLabel">What this habit is</div>
              <div class="summaryValue">${escapeHtml(desc)}</div>
            </div>
            <div class="summaryMeta">${escapeHtml(freqTxt)} • ${isNeg ? 'Break' : 'Build'}</div>
          </div>

          <div class="summaryAction">
            <div class="summaryLabel">${escapeHtml(nextLabel)}</div>
            <div class="summaryValue">${escapeHtml(nextAction)}</div>
          </div>

          <div class="summaryPills">
            <div class="pillStat">
              <div class="k">Progress</div>
              <div class="v">${escapeHtml(String(prog.actual))} / ${escapeHtml(String(prog.target))}</div>
              <div class="s">${escapeHtml(prog.label)}</div>
            </div>
            <div class="pillStat">
              <div class="k">Consistency</div>
              <div class="v">${escapeHtml(String(c7))}%</div>
              <div class="s">Last 7 days</div>
            </div>
          </div>

        <div class="progressWrap" id="habit-${escapeHtml(h.id)}-progress" style="margin-top:12px;">
          <div class="progressTop">
            <div class="label">${escapeHtml(prog.label)} progress</div>
            <div class="meta">${escapeHtml(String(prog.actual))} / ${escapeHtml(String(prog.target))}</div>
          </div>
          <div class="bar" aria-label="Progress bar">
            <div class="fill" style="--p:${ratio.toFixed(3)}"></div>
          </div>
          <div class="progressMsg">${escapeHtml(msg)}</div>
        </div>
        </div>
        ${shieldUI}
      `;
    }

function renderHabitEditPanel(h){
  const f = safeObj(h.frequency);
  const unit = (f.unit === 'week' || f.unit === 'month') ? f.unit : 'day';
  const target = Math.max(1, Math.round(Number(f.target) || 1));
  const m = safeObj(h.motivator);

  return `
    <div class="panel" style="border:none; background:transparent; padding:0;">
      <div style="font-weight:950; margin-bottom:8px;">Edit habit</div>

      <div class="grid two">
        <div class="field">
          <label>Habit name</label>
          <input
            type="text"
            data-bind="name"
            data-habit="${escapeHtml(h.id)}"
            value="${escapeHtml(h.name || '')}"
            maxlength="120"
            placeholder="e.g., Walk after lunch" />
          <div class="help">Keep it concrete and action-based.</div>
        </div>

        <div class="field">
          <label>Start date</label>
          <input
            type="date"
            data-bind="startDate"
            data-habit="${escapeHtml(h.id)}"
            value="${escapeHtml(h.startDate || todayISO())}" />
          <div class="help">This doesn’t delete logs. It’s just the habit’s reference start date.</div>
        </div>
      </div>

      <div class="field" style="margin-top:12px;">
        <label>What does “done” mean?</label>
        <textarea
          data-bind="description"
          data-habit="${escapeHtml(h.id)}"
          maxlength="1200"
          placeholder="Define success in one sentence. Keep it kind.">${escapeHtml(h.description || '')}</textarea>
      </div>

      <div class="inline freqRow" style="margin-top:12px;">
        <div class="field compact">
          <label>Frequency unit</label>
          <select data-bind="frequency.unit" data-habit="${escapeHtml(h.id)}">
            <option value="day" ${unit==='day'?'selected':''}>Day</option>
            <option value="week" ${unit==='week'?'selected':''}>Week</option>
            <option value="month" ${unit==='month'?'selected':''}>Month</option>
          </select>
        </div>

        <div class="field compact">
          <label>Target #</label>
          <input
            type="number"
            min="1"
            step="1"
            inputmode="numeric"
            data-bind="frequency.target"
            data-habit="${escapeHtml(h.id)}"
            value="${escapeHtml(String(target))}" />
        </div>
      </div>

      <div class="panel" style="margin-top:14px;">
        <div class="sectionTitle">Motivator details</div>
        <div class="grid two" style="margin-top:10px;">
          <div class="field">
            <label>Identity (one sentence)</label>
            <input type="text"
              data-bind="motivator.identity"
              data-habit="${escapeHtml(h.id)}"
              value="${escapeHtml(m.identity || '')}"
              maxlength="220"
              placeholder="I am the kind of person who…" />
            <div class="help">This should feel true even on hard days.</div>
          </div>
          <div class="field">
            <label>Long-term outcome</label>
            <input type="text"
              data-bind="motivator.outcome"
              data-habit="${escapeHtml(h.id)}"
              value="${escapeHtml(m.outcome || '')}"
              maxlength="260"
              placeholder="Over time, this enables…" />
          </div>
        </div>
        <div class="field" style="margin-top:12px;">
          <label>Why this matters</label>
          <textarea
            data-bind="motivator.why"
            data-habit="${escapeHtml(h.id)}"
            maxlength="420"
            placeholder="A reason worth returning to.">${escapeHtml(m.why || '')}</textarea>
        </div>
        <div class="muted tiny" style="margin-top:10px;">
          These lines show up in tracking feedback, weekly review prompts, and encouragement.
        </div>
      </div>

      <div class="success" style="margin-top:12px;">
        <strong>Note:</strong>
        <div class="small muted" style="margin-top:6px;">
          Changing frequency updates how progress is calculated. Your existing logs are kept.
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn small ghost" data-action="saveHabit" data-habit="${escapeHtml(h.id)}">Save</button>
        <button class="btn small danger" data-action="deleteHabit" data-habit="${escapeHtml(h.id)}">Delete</button>
      </div>

      <div class="muted tiny" style="margin-top:8px;">Inputs save instantly. “Save” simply confirms and refreshes visuals.</div>
    </div>
  `;
}

function normalizeLogCountsForFrequency(h){
  const f = safeObj(h.frequency);
  const unit = (f.unit === 'week' || f.unit === 'month') ? f.unit : 'day';
  const target = Math.max(1, Math.round(Number(f.target) || 1));
  const succ = successStatusForType(h.type);

  if (!h.logs || typeof h.logs !== 'object') return;

  for (const k of Object.keys(h.logs)){
    if (!/^\d{4}-\d{2}-\d{2}$/.test(k)) continue;
    const e = safeObj(h.logs[k]);
    const st = String(e.status || '').toLowerCase();

    // Keep note/updatedAt/auto as-is, just normalize count
    h.logs[k].count = (st === succ) ? ((unit === 'day') ? target : 1) : 0;
  }
}

function rerenderHabitDesignPanel(habitId){
  const h = getHabit(habitId);
  if (!h) return;
  const panel = document.getElementById(`panel-${habitId}-design`);
  if (panel) panel.innerHTML = renderHabitDesignPanel(h);
}

function addFrictionItem(habitId){
  const h = getHabit(habitId);
  if (!h) return;
  const items = ensureFrictionItems(h);
  items.push('');
  h.updatedAt = new Date().toISOString();
  saveData({ toast:false });
  rerenderHabitDesignPanel(habitId);
  const panel = document.getElementById(`panel-${habitId}-design`);
  const inputs = panel?.querySelectorAll(`[data-friction-index]`);
  const last = inputs?.[inputs.length - 1];
  if (last instanceof HTMLElement) last.focus();
}

function removeFrictionItem(habitId, index){
  const h = getHabit(habitId);
  if (!h) return;
  const items = ensureFrictionItems(h);
  if (!Number.isFinite(index) || index < 0 || index >= items.length) return;
  items.splice(index, 1);
  if (!items.length) items.push('');
  h.updatedAt = new Date().toISOString();
  saveData({ toast:false });
  rerenderHabitDesignPanel(habitId);
}

function handleFrictionInput(el){
  const habitId = el.getAttribute('data-habit');
  const idx = Number(el.getAttribute('data-friction-index'));
  if (!habitId || Number.isNaN(idx)) return;
  const h = getHabit(habitId);
  if (!h) return;
  const items = ensureFrictionItems(h);
  const val = String(el.value ?? '').slice(0, 160);
  items[idx] = val;
  h.updatedAt = new Date().toISOString();
  scheduleSave();
}

function updateHabitHeader(habitId){
  const h = getHabit(habitId);
  if (!h) return;

  const nameEls = document.querySelectorAll(`[data-sum="name"][data-habit="${cssEscape(habitId)}"]`);
  nameEls.forEach(el => { el.textContent = h.name || 'Untitled habit'; });

  const descEls = document.querySelectorAll(`[data-sum="desc"][data-habit="${cssEscape(habitId)}"]`);
  descEls.forEach(el => { el.textContent = h.description || ''; });

  const freqEls = document.querySelectorAll(`[data-sum="freq"][data-habit="${cssEscape(habitId)}"]`);
  freqEls.forEach(el => { el.textContent = formatUnit(h.frequency.unit, h.frequency.target); });

  const dashBtn = document.querySelector(`button[data-action="dashToggle"][data-habit="${cssEscape(habitId)}"]`);
  if (dashBtn) dashBtn.setAttribute('aria-label', `Mark ${h.name || 'habit'} for today`);

  if (appData.ui?.activeHabitId === habitId){
    const title = h.name || 'Habit details';
    const modalTitle = document.getElementById('modalTitle');
    if (modalTitle) modalTitle.textContent = title;
  }
}

    function renderHabitDesignPanel(h){
      const loop = safeObj(safeObj(h.design).loop);
      const laws = safeObj(safeObj(h.design).laws);
      const plan = safeObj(safeObj(h.design).plan);
      const labels = lawLabelsForType(h.type);
      const frictionItems = getFrictionItems(h);
      const frictionList = (frictionItems.length ? frictionItems : ['']).map((item, idx) => `
        <div class="frictionItem">
          <input
            type="text"
            maxlength="160"
            data-habit="${escapeHtml(h.id)}"
            data-friction-index="${idx}"
            value="${escapeHtml(item)}"
            placeholder="e.g., Put snacks in a high cabinet" />
          <button class="btn small ghost" type="button" data-action="removeFrictionItem" data-habit="${escapeHtml(h.id)}" data-index="${idx}" aria-label="Remove speed bump">−</button>
        </div>
      `).join('');

      return `
        <div class="panel" style="border:none; background:transparent; padding:0;">
          <div style="font-weight:950; margin-bottom:8px;">Plan</div>
          <div class="grid two">
            <div class="field">
              <label>If–Then plan</label>
              <textarea data-habit="${escapeHtml(h.id)}" data-bind="design.plan.ifThen" placeholder="If X happens, then I will Y.">${escapeHtml(plan.ifThen || '')}</textarea>
              <div class="help">Example: “If it’s 7pm, then I’ll read for 10 minutes.”</div>
            </div>
            <div class="field">
              <label>After I do ___, I will ___</label>
              <textarea data-habit="${escapeHtml(h.id)}" data-bind="design.plan.cuePlan" placeholder="After I make coffee, I will journal for 2 minutes.">${escapeHtml(plan.cuePlan || '')}</textarea>
              <div class="help">Anchor your habit to an existing routine.</div>
            </div>
            <div class="field">
              <label>2-minute version</label>
              <input type="text" data-habit="${escapeHtml(h.id)}" data-bind="design.plan.twoMinute" placeholder="The smallest possible start." value="${escapeHtml(plan.twoMinute || '')}" maxlength="240" />
              <div class="help">Low-energy option for consistency.</div>
            </div>
          </div>

          ${h.type === 'negative' ? `
            <div class="frictionCard" style="margin-top:12px;">
              <div class="frictionHead">
                <div class="sectionTitle">Friction (speed bumps)</div>
                <button class="btn small ghost" type="button" data-action="addFrictionItem" data-habit="${escapeHtml(h.id)}" aria-label="Add speed bump">+</button>
              </div>
              <div class="muted small" style="margin-top:6px;">
                Add obstacles that make the unwanted habit harder to start.
              </div>
              <div class="frictionList">
                ${frictionList}
              </div>
            </div>
          ` : ''}

          <details class="panel" style="margin-top:12px;">
            <summary style="font-weight:900; cursor:pointer;">More behavior design (optional)</summary>
            <div class="hr"></div>

            <div style="font-weight:950; margin-bottom:8px;">Habit loop</div>
            <div class="grid two">
              <div class="field">
                <label>Cue</label>
                <textarea data-habit="${escapeHtml(h.id)}" data-bind="design.loop.cue" placeholder="What triggers it?">${escapeHtml(loop.cue || '')}</textarea>
              </div>
              <div class="field">
                <label>Craving</label>
                <textarea data-habit="${escapeHtml(h.id)}" data-bind="design.loop.craving" placeholder="What feeling/want does it promise?">${escapeHtml(loop.craving || '')}</textarea>
              </div>
              <div class="field">
                <label>Response</label>
                <textarea data-habit="${escapeHtml(h.id)}" data-bind="design.loop.response" placeholder="What do you actually do?">${escapeHtml(loop.response || '')}</textarea>
              </div>
              <div class="field">
                <label>Reward</label>
                <textarea data-habit="${escapeHtml(h.id)}" data-bind="design.loop.reward" placeholder="What immediate payoff happens?">${escapeHtml(loop.reward || '')}</textarea>
              </div>
            </div>

            <div class="hr"></div>

            <div style="font-weight:950; margin-bottom:8px;">Four laws of behavior change</div>
            <div class="grid two">
              <div class="field">
                <label>${escapeHtml(labels.obvious)}</label>
                <textarea data-habit="${escapeHtml(h.id)}" data-bind="design.laws.obvious" placeholder="Environment & cues...">${escapeHtml(laws.obvious || '')}</textarea>
              </div>
              <div class="field">
                <label>${escapeHtml(labels.attractive)}</label>
                <textarea data-habit="${escapeHtml(h.id)}" data-bind="design.laws.attractive" placeholder="Make it appealing (or not)...">${escapeHtml(laws.attractive || '')}</textarea>
              </div>
              <div class="field">
                <label>${escapeHtml(labels.easy)}</label>
                <textarea data-habit="${escapeHtml(h.id)}" data-bind="design.laws.easy" placeholder="Reduce friction (or add it)...">${escapeHtml(laws.easy || '')}</textarea>
              </div>
              <div class="field">
                <label>${escapeHtml(labels.satisfying)}</label>
                <textarea data-habit="${escapeHtml(h.id)}" data-bind="design.laws.satisfying" placeholder="Reward & tracking (or consequence)...">${escapeHtml(laws.satisfying || '')}</textarea>
              </div>
            </div>

            <div class="success" style="margin-top:12px;">
              <strong>System > willpower.</strong>
              <div class="small muted" style="margin-top:6px;">
                If it’s hard to follow through, adjust the environment. Make the “right thing” the easy thing.
              </div>
            </div>
          </details>
        </div>
      `;
    }

function renderHabitInsightsPanel(h){
const rk = getInsightRangeKey(h.id);
const range = INSIGHT_RANGES[rk] || INSIGHT_RANGES['1y'];

const plannedRate = plannedRatePerDay(h);

const w = effectiveWindowForHabit(h, range.days);
const actualInRange = countSuccessInRange(h, w.start, addDays(w.end, 1));
const plannedInRange = Math.round(plannedRate * w.days);


  const s = insightsSuggestions(h);
  const weeklyChart = renderWeeklyBarChart(h);

  return `
    <div class="seg" role="group" aria-label="Insights time range">
      <button type="button" class="segBtn ${rk==='1w'?'active':''}" data-action="setInsightRange" data-habit="${escapeHtml(h.id)}" data-range="1w">1W</button>
      <button type="button" class="segBtn ${rk==='1m'?'active':''}" data-action="setInsightRange" data-habit="${escapeHtml(h.id)}" data-range="1m">1M</button>
      <button type="button" class="segBtn ${rk==='3m'?'active':''}" data-action="setInsightRange" data-habit="${escapeHtml(h.id)}" data-range="3m">3M</button>
      <button type="button" class="segBtn ${rk==='6m'?'active':''}" data-action="setInsightRange" data-habit="${escapeHtml(h.id)}" data-range="6m">6M</button>
      <button type="button" class="segBtn ${rk==='1y'?'active':''}" data-action="setInsightRange" data-habit="${escapeHtml(h.id)}" data-range="1y">1Y</button>
    </div>
    <div class="tiny muted rangeHint">
  Showing ${escapeHtml(range.label)} (${escapeHtml(toISODate(w.start))} → ${escapeHtml(toISODate(w.end))})
</div>


    <div class="chartWrap" style="margin-top:10px;">
      <div class="chartHead">
        <div class="t">${escapeHtml(range.label)} frequency graph</div>
        <div class="legend" aria-label="Chart legend">
          <span class="leg"><span class="swatch plan"></span> Planned</span>
          <span class="leg"><span class="swatch actual"></span> Actual</span>
          <span class="leg"><span class="swatch dots"></span> Execution dates</span>
        </div>
      </div>
      <div id="habit-${escapeHtml(h.id)}-chart" class="chart" data-chart="${escapeHtml(h.id)}">
        <div class="muted small">Chart will render here.</div>
      </div>
      <div class="muted tiny" style="margin-top:8px;">
        Cumulative actual vs planned for the selected window. Executions are marked along the line.
      </div>
    </div>

    ${weeklyChart}

    <div class="stats" style="margin-top:12px;">
      <div class="stat">
        <div class="k">${escapeHtml(range.label)} planned</div>
        <div class="v">${escapeHtml(String(plannedInRange))}</div>
        <div class="s">Based on your frequency</div>
      </div>
      <div class="stat">
        <div class="k">${escapeHtml(range.label)} actual</div>
        <div class="v">${escapeHtml(String(actualInRange))}</div>
        <div class="s">Successes logged</div>
      </div>
      <div class="stat">
        <div class="k">7 / 30 / 90</div>
        <div class="v">${escapeHtml(String(windowConsistencyPercent(h,7)))}% / ${escapeHtml(String(windowConsistencyPercent(h,30)))}% / ${escapeHtml(String(windowConsistencyPercent(h,90)))}%</div>
        <div class="s">Consistency vs plan</div>
      </div>
      <div class="stat">
        <div class="k">Streak</div>
        <div class="v">${escapeHtml(String(currentDailyStreak(h)))}d</div>
        <div class="s">Consecutive success days</div>
      </div>
    </div>

    <div class="panel" style="margin-top:12px;">
      <div style="font-weight:950; margin-bottom:8px;">Suggestions (calm + data-informed)</div>
      <ul class="small muted" style="margin:0; padding-left:18px; line-height:1.5;">
        ${s.map(x => `<li>${escapeHtml(x)}</li>`).join('')}
      </ul>
      <div class="row" style="margin-top:12px;">
        <button class="btn ghost wide" data-action="jumpToPlan" data-habit="${escapeHtml(h.id)}">Make it easier</button>
      </div>
    </div>
  `;
}


    function renderHabitTrackPanel(h, { succStatus, failStatus }){
      const today = todayISO();
      const existing = safeObj(h.logs)[today];
      const defaultStatus = (existing && existing.status) ? existing.status : failStatus;

      const noteVal = String(existing?.note ?? '');
      const statusLabelA = (h.type === 'negative') ? 'Resisted' : 'Completed';
      const statusLabelB = (h.type === 'negative') ? 'Relapsed' : 'Missed';

      const plan = safeObj(safeObj(h.design).plan);
      const ifThen = String(plan.ifThen || '').trim();
      const cuePlan = String(plan.cuePlan || '').trim();
      const twoMinute = String(plan.twoMinute || '').trim();

      const planHtml = (ifThen || cuePlan || twoMinute) ? `
        <div class="panel" style="margin-bottom:12px;">
          <div style="font-weight:900; margin-bottom:6px;">Today plan</div>
          ${ifThen ? `<div class="muted small">If–Then: ${escapeHtml(ifThen)}</div>` : ''}
          ${cuePlan ? `<div class="muted small" style="margin-top:6px;">After I do: ${escapeHtml(cuePlan)}</div>` : ''}
          ${twoMinute ? `<div class="muted small" style="margin-top:6px;">2-minute version: ${escapeHtml(twoMinute)}</div>` : ''}
        </div>
      ` : '';

      const recentHtml = renderRecentLogs(h);

      return `
        <div class="panel" style="border:none; background:transparent; padding:0;">
          <div style="font-weight:950; margin-bottom:8px;">Daily logging</div>

         ${planHtml}

          <div class="inline">
            <div class="field compact2">
              <label>Date</label>
              <input type="date" value="${escapeHtml(today)}" data-habit="${escapeHtml(h.id)}" data-track="date" />
            </div>
            <div class="field compact2">
              <label>Status</label>
              <select data-habit="${escapeHtml(h.id)}" data-track="status">
                <option value="${escapeHtml(succStatus)}" ${defaultStatus===succStatus ? 'selected':''}>${escapeHtml(statusLabelA)}</option>
                <option value="${escapeHtml(failStatus)}" ${defaultStatus===failStatus ? 'selected':''}>${escapeHtml(statusLabelB)}</option>
              </select>
            </div>
          </div>

          <div class="field" style="margin-top:10px;">
            <label>Note (optional)</label>
            <textarea data-habit="${escapeHtml(h.id)}" data-track="note" placeholder="What helped? What got in the way?">${escapeHtml(noteVal)}</textarea>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="btn primary wide" data-action="saveLog" data-habit="${escapeHtml(h.id)}">Save log</button>
            <button class="btn ghost wide" data-action="clearLogInputs" data-habit="${escapeHtml(h.id)}">Clear fields</button>
          </div>

          <div class="hr"></div>

          <div id="habit-${escapeHtml(h.id)}-logslist">
            ${recentHtml}
          </div>
        </div>
      `;
    }

function renderRecentLogs(h){
  const logs = safeObj(h.logs);
  const fail = failStatusForType(h.type);
  const keys = Object.keys(logs).filter(k => {
    if (!/^\d{4}-\d{2}-\d{2}$/.test(k)) return false;
    const e = safeObj(logs[k]);
    const st = String(e.status || '').toLowerCase();
    const note = String(e.note || '').trim();
    const isAutoFailEmpty = !!e.auto && st === fail && !note;
    return !isAutoFailEmpty;
  });
  keys.sort((a,b) => (a < b ? 1 : -1));

  // Persisted open/closed state per habit
  appData.ui = safeObj(appData.ui);
  appData.ui.recentOpen = safeObj(appData.ui.recentOpen);
  const open = !!appData.ui.recentOpen[h.id];

  // Build inner rows
  let inner = '';
  if (!keys.length){
    inner = `<div class="panel"><div class="muted small">No entries yet. Start with today—one calm check-in.</div></div>`;
  } else {
    const show = keys.slice(0, 30);
    const isNeg = h.type === 'negative';
    const succ = successStatusForType(h.type);
    const fail = failStatusForType(h.type);
    const aLabel = isNeg ? 'Resisted' : 'Completed';
    const bLabel = isNeg ? 'Relapsed' : 'Missed';

    inner = show.map(k => {
      const e = logs[k] || {};
      const st = String(e.status || fail); // default to fail, not success
      const note = String(e.note ?? '');
      return `
        <div class="panel" style="margin-bottom:10px;">
          <div class="inline">
            <div class="field compact2">
              <label>Date</label>
              <input type="date" value="${escapeHtml(k)}" disabled />
            </div>
            <div class="field compact2">
              <label>Status</label>
              <select data-habit="${escapeHtml(h.id)}" data-logdate="${escapeHtml(k)}" data-logfield="status">
                <option value="${escapeHtml(succ)}" ${st===succ?'selected':''}>${escapeHtml(aLabel)}</option>
                <option value="${escapeHtml(fail)}" ${st===fail?'selected':''}>${escapeHtml(bLabel)}</option>
              </select>
            </div>
          </div>

          <div class="field" style="margin-top:10px;">
            <label>Note</label>
            <textarea data-habit="${escapeHtml(h.id)}" data-logdate="${escapeHtml(k)}" data-logfield="note" placeholder="Optional…">${escapeHtml(note)}</textarea>
          </div>

          <div class="row" style="margin-top:10px; justify-content:flex-end;">
            <button type="button" class="btn small danger" data-action="deleteLog" data-habit="${escapeHtml(h.id)}" data-date="${escapeHtml(k)}">Delete</button>
          </div>
        </div>
      `;
    }).join('');
  }

  // Wrap inner content in a toggleable section with a button
  return `
    <div class="secHead">
      <div class="sectionTitle">Recent logs</div>
      <button
        type="button"
        class="btn small ghost"
        id="recentBtn-${escapeHtml(h.id)}"
        data-action="toggleRecentLogs"
        data-habit="${escapeHtml(h.id)}"
        aria-expanded="${open ? 'true' : 'false'}"
      >${open ? 'Hide' : 'Show'}</button>
    </div>
    <div class="muted small" style="margin-top:6px;">Edit notes anytime. Status changes update your graph and progress immediately.</div>

    <div class="recentBody" id="recent-${escapeHtml(h.id)}" ${open ? '' : 'hidden'}>
      ${inner}
    </div>
  `;
}

    function renderReview(){
      const root = $('#tab-review');
      const habits = safeArr(appData.habits);

      const weekStartISO = getReviewWeekISO();
      const weekStart = parseISODate(weekStartISO) || startOfWeekMonday(new Date());
      const weekEnd = addDays(weekStart, 7);

      const global = safeObj(appData.reviews?.[weekStartISO]?.global);
      const notes = safeObj(appData.reviews?.[weekStartISO]?.notes);
      const tweak = String(global.next || '').trim();
      const tweakLine = tweak ? `
        <div class="panel" style="margin-bottom:12px;">
          <div style="font-weight:900; margin-bottom:6px;">One tweak locked in</div>
          <div class="muted small">${escapeHtml(tweak)}</div>
        </div>
      ` : '';

      const habitBlocks = habits.length ? habits.map(h => {
        const n = safeObj(notes?.[h.id]);
        const identity = (safeObj(h.motivator).identity || '').trim();
        const c7 = windowConsistencyPercent(h, 7);
        const prog = periodProgress(h);

        const promptA = identity ? `How did this week support: “${identity}”?` : 'How did this week support your identity?';

        return `
          <div class="card" style="margin-top:12px;">
            <div class="cardHeader">
              <div class="left">
                <div class="hTitle">${escapeHtml(h.name || 'Untitled habit')}</div>
                <div class="hMeta">
                  <span class="tag ${h.type==='negative'?'bad':'good'}">${h.type==='negative'?'Negative':'Positive'}</span>
                  <span class="tag muted">${escapeHtml(formatUnit(h.frequency.unit, h.frequency.target))}</span>
                  <span class="muted2">7d ${escapeHtml(String(c7))}% • ${escapeHtml(prog.label)} ${escapeHtml(String(prog.actual))}/${escapeHtml(String(prog.target))}</span>
                </div>
              </div>
            </div>
            <div class="content">
              <div class="grid two">
                <div class="field">
                  <label>What worked?</label>
                  <textarea data-review-week="${escapeHtml(weekStartISO)}" data-review-habit="${escapeHtml(h.id)}" data-review-bind="worked"
                    placeholder="What made it easier?">${escapeHtml(String(n.worked ?? ''))}</textarea>
                </div>
                <div class="field">
                  <label>What got in the way?</label>
                  <textarea data-review-week="${escapeHtml(weekStartISO)}" data-review-habit="${escapeHtml(h.id)}" data-review-bind="blocked"
                    placeholder="What friction/cue showed up?">${escapeHtml(String(n.blocked ?? ''))}</textarea>
                </div>
                <div class="field">
                  <label>One tweak for next week</label>
                  <textarea data-review-week="${escapeHtml(weekStartISO)}" data-review-habit="${escapeHtml(h.id)}" data-review-bind="tweak"
                    placeholder="Environment change, cue, or smaller step.">${escapeHtml(String(n.tweak ?? ''))}</textarea>
                </div>
                <div class="field">
                  <label>${escapeHtml(promptA)}</label>
                  <textarea data-review-week="${escapeHtml(weekStartISO)}" data-review-habit="${escapeHtml(h.id)}" data-review-bind="identity"
                    placeholder="A sentence you’ll believe on hard days.">${escapeHtml(String(n.identity ?? ''))}</textarea>
                </div>
              </div>

              <div class="success" style="margin-top:12px;">
                <strong>Data-informed nudge:</strong>
                <div class="small muted" style="margin-top:6px;">
                  ${escapeHtml(insightsSuggestions(h)[0] || 'Keep the system gentle and consistent.')}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('') : `
        <div class="panel">
          <div style="font-weight:950; margin-bottom:6px;">No habits yet</div>
          <div class="muted small">Create a habit on the Dashboard, then reflect here weekly.</div>
        </div>
      `;

      root.innerHTML = `
        <div class="reviewHero">
          <p class="big">Weekly review</p>
          <p class="smallp">
            A calm check-in. Use what happened to make next week easier.
          </p>
        </div>

        ${tweakLine}

        <div class="card">
          <div class="cardHeader">
            <div class="left">
              <div class="hTitle">Week of ${escapeHtml(weekStartISO)}</div>
              <div class="hMeta">
                <span class="muted2">${escapeHtml(toISODate(weekStart))} → ${escapeHtml(toISODate(addDays(weekEnd,-1)))}</span>
              </div>
            </div>
            <div class="right">
              <button class="btn small ghost" data-action="shiftWeek" data-dir="-1" aria-label="Previous week">←</button>
              <button class="btn small ghost" data-action="shiftWeek" data-dir="1" aria-label="Next week">→</button>
            </div>
          </div>
          <div class="content">
            <div class="grid two">
              <div class="field">
                <label>Wins (any size)</label>
                <textarea data-review-week="${escapeHtml(weekStartISO)}" data-review-global="wins" placeholder="What went well?">${escapeHtml(String(global.wins ?? ''))}</textarea>
              </div>
              <div class="field">
                <label>What did you learn?</label>
                <textarea data-review-week="${escapeHtml(weekStartISO)}" data-review-global="learn" placeholder="What did the week teach you about cues/fatigue/time?">${escapeHtml(String(global.learn ?? ''))}</textarea>
              </div>
              <div class="field">
                <label>Next week — one system change</label>
                <textarea data-review-week="${escapeHtml(weekStartISO)}" data-review-global="next" placeholder="Make the right action easier (or the wrong one harder).">${escapeHtml(String(global.next ?? ''))}</textarea>
              </div>
              <div class="field">
                <label>Identity reinforcement</label>
                <textarea data-review-week="${escapeHtml(weekStartISO)}" data-review-global="identity" placeholder="Who are you becoming?">${escapeHtml(String(global.identity ?? ''))}</textarea>
              </div>
            </div>

            <div class="row" style="margin-top:12px;">
              <button class="btn primary wide" data-action="saveReview" data-week="${escapeHtml(weekStartISO)}">Save review</button>
              <button class="btn ghost wide" data-action="copyReviewPrompt">Copy prompts (share or journal)</button>
            </div>

            <div class="muted tiny" style="margin-top:10px;">
              Everything saves instantly, but “Save review” saves a clear weekly checkpoint.
            </div>
          </div>
        </div>

        ${habitBlocks}
      `;
    }

    function renderSettings(){
      const root = $('#tab-settings');
      const updated = appData.updatedAt ? new Date(appData.updatedAt).toLocaleString() : '—';
      const soundOn = appData.ui.soundEnabled !== false;
      const soundLabel = soundOn ? 'Sound on' : 'Sound off';
      const soundStyle = appData.ui.soundStyle === 'soft' ? 'soft' : 'bright';

      const diag = runDiagnostics();
      const storageWarn = appData.ui.storageWarning ? `
        <div class="error" style="margin-bottom:12px;">
          <strong>Storage warning</strong>
          <div class="small muted" style="margin-top:6px;">
            This browser may be blocking or full. Backup now (Export), then consider clearing old logs.
          </div>
        </div>
      ` : '';

      root.innerHTML = `
        <div class="card">
          <div class="cardHeader">
            <div class="left">
              <div class="hTitle">Settings</div>
              <div class="hMeta">
                <span class="tag muted">Offline • localStorage</span>
                <span class="muted2">Last saved: ${escapeHtml(updated)}</span>
              </div>
            </div>
          </div>

          <div class="content">
            ${storageWarn}
            <div class="panel">
              <div style="font-weight:950; margin-bottom:8px;">Feedback</div>
              <div class="row">
                <button class="btn ghost wide" data-action="toggleSound" aria-pressed="${soundOn ? 'true' : 'false'}">
                  ${soundLabel}
                </button>
              </div>
              <div class="seg" style="margin-top:10px;">
                <button class="segBtn ${soundStyle === 'bright' ? 'active' : ''}" data-action="setSoundStyle" data-style="bright" aria-pressed="${soundStyle === 'bright' ? 'true' : 'false'}">Bright chime</button>
                <button class="segBtn ${soundStyle === 'soft' ? 'active' : ''}" data-action="setSoundStyle" data-style="soft" aria-pressed="${soundStyle === 'soft' ? 'true' : 'false'}">Soft chime</button>
              </div>
              <div class="muted small" style="margin-top:10px;">
                Plays a gentle chime when you complete a habit.
              </div>
            </div>

            <div class="panel">
              <div style="font-weight:950; margin-bottom:8px;">Backup & restore</div>
              <div class="row">
                <button class="btn primary wide" data-action="openExport">Export JSON</button>
                <button class="btn ghost wide" data-action="openImport">Import JSON</button>
              </div>
              <div class="muted small" style="margin-top:10px;">
                Backup regularly if this matters to you. Import supports merge or replace (with validation).
              </div>
            </div>

            <div class="panel" style="margin-top:12px;">
              <div style="font-weight:950; margin-bottom:8px;">Danger zone</div>
              <button class="btn danger wide" data-action="clearAll">Clear all data</button>
              <div class="muted small" style="margin-top:10px;">
                This deletes all habits, logs, and reviews from this device.
              </div>
            </div>

            <div class="panel" style="margin-top:12px;">
              <div style="font-weight:950; margin-bottom:8px;">Diagnostics</div>
              <div class="${diag.ok ? 'success':'error'}">
                <strong>${diag.ok ? 'All checks passed' : 'Some checks need attention'}</strong>
                <div class="small muted" style="margin-top:6px;">
                  ${escapeHtml(diag.summary)}
                </div>
              </div>
              <div class="muted tiny" style="margin-top:10px;">
                These checks help prevent common failure modes: missing renders, broken persistence, invalid state.
              </div>
            </div>

            <div class="panel" style="margin-top:12px;">
              <div style="font-weight:950; margin-bottom:8px;">About</div>
              <div class="muted small">
                Quiet Habits is a private, offline-first habit builder and breaker.
                Inspired by Atomic Habits principles. Not affiliated with or endorsed by James Clear.
              </div>
            </div>

            <div class="panel" style="margin-top:12px;">
              <div style="font-weight:950; margin-bottom:8px;">How this works</div>
              <ul class="small muted" style="margin:0; padding-left:18px; line-height:1.5;">
                <li>Make habits identity-based: each check-in is a vote for who you want to be.</li>
                <li>Use cues and tiny starts to lower friction and make consistency easier.</li>
                <li>Misses are data, not verdicts. Adjust the environment instead of blaming yourself.</li>
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    function hydrateVisibleCharts(){
      const modal = $('#modal');
      if (!modal.classList.contains('active')) return;
      const hid = appData.ui?.activeHabitId;
      if (!hid) return;
      const sub = appData.ui.habitSubtabs?.[hid] || 'track';
      if (sub !== 'insights') return;
      const chartEl = $(`#habit-${cssEscape(hid)}-chart`);
      const h = getHabit(hid);
      if (chartEl && h){
        renderChartSVG(h, chartEl, getInsightRangeKey(hid));
      }
    }

    function updateHabitVisuals(habitId){
      const h = getHabit(habitId);
      if (!h) return;

      const sumWrap = $(`#habit-${cssEscape(habitId)}-summary`);
      if (sumWrap){
        const prog = periodProgress(h);
        const c7 = windowConsistencyPercent(h, 7);
        sumWrap.innerHTML = renderHabitSummary(h, { prog, c7 });
      }

      // If insights panel visible, update chart
      const sub = appData.ui.habitSubtabs?.[habitId] || 'track';
      if (sub === 'insights'){
        const panel = document.getElementById(`panel-${habitId}-insights`);
        if (panel){
          panel.innerHTML = renderHabitInsightsPanel(h);
          const chartEl = document.getElementById(`habit-${habitId}-chart`);
          if (chartEl) renderChartSVG(h, chartEl, getInsightRangeKey(habitId));
        }
      }
    }

    /* =========================
       Streak shield (gentle recovery)
    ========================== */

    function getShield(habitId){
      appData.ui = safeObj(appData.ui);
      appData.ui.streakShield = safeObj(appData.ui.streakShield);

      const wk = toISODate(startOfWeekMonday(new Date()));
      const s = safeObj(appData.ui.streakShield[habitId]);

      if (s.weekISO !== wk){
        appData.ui.streakShield[habitId] = { weekISO: wk, credits: 1, used: {} };
        saveData({ toast:false });
      }
      return safeObj(appData.ui.streakShield[habitId]);
    }

    function canUseShieldForYesterday(h){
      const hid = h.id;
      const shield = getShield(hid);
      if ((shield.credits || 0) <= 0) return null;

      const y = toISODate(addDays(parseISODate(todayISO()), -1));
      const logs = safeObj(h.logs);
      const succ = successStatusForType(h.type);
      const already = !!safeObj(shield.used)[y];

      const e = safeObj(logs[y]);
      const isSuccess = (String(e.status || '').toLowerCase() === succ);
      if (already || isSuccess) return null;

      return y;
    }

    function useShield(habitId, dateISO){
      const h = getHabit(habitId);
      if (!h) return;
      const shield = getShield(habitId);
      if ((shield.credits || 0) <= 0) return;

      shield.used = safeObj(shield.used);
      if (shield.used[dateISO]) return;

      shield.used[dateISO] = true;
      shield.credits = Math.max(0, (Number(shield.credits) || 0) - 1);

      saveData({ toast:false });
      showToast('Streak protected', 'One gentle shield used. Keep going—trajectory matters.', { icon:'🛡', ms:2600 });

      updateHabitVisuals(habitId);
      renderDashboard();
    }

    /* =========================
       Review week helpers
    ========================== */

    function getReviewWeekISO(){
      // store in ui, fallback to current week start
      const ui = safeObj(appData.ui);
      const existing = ui.reviewWeekISO;
      if (existing && /^\d{4}-\d{2}-\d{2}$/.test(existing)) return existing;
      const wk = startOfWeekMonday(new Date());
      const iso = toISODate(wk);
      appData.ui.reviewWeekISO = iso;
      scheduleSave();
      return iso;
    }

    function shiftReviewWeek(dir){
      const cur = parseISODate(getReviewWeekISO()) || startOfWeekMonday(new Date());
      const next = addDays(cur, dir * 7);
      const iso = toISODate(next);
      appData.ui.reviewWeekISO = iso;
      saveData({ toast:false });
      render();
      appData.ui.activeTab = 'review';
      saveData({ toast:false });
      applyActiveTab();
      renderNavActive();
    }

    function ensureReviewWeek(weekISO){
      if (!appData.reviews) appData.reviews = {};
      if (!appData.reviews[weekISO]) appData.reviews[weekISO] = { global:{}, notes:{} };
      if (!appData.reviews[weekISO].global) appData.reviews[weekISO].global = {};
      if (!appData.reviews[weekISO].notes) appData.reviews[weekISO].notes = {};
    }

function ensureDefaultLogsUpToToday(){
  const ui = appData.ui = safeObj(appData.ui);
  const todayD = parseISODate(todayISO());
  if (!todayD) return;

  const last = parseISODate(ui.lastOpenISO || '');
  let startD = last ? addDays(last, 1) : todayD;
  if (startD > todayD) startD = todayD;

  const days = diffDays(startD, todayD);
  let changed = false;

  for (let i = 0; i <= days; i++){
    const d = addDays(startD, i);
    const iso = toISODate(d);

    for (const h of appData.habits){
      if (!h.logs || typeof h.logs !== 'object') { h.logs = {}; changed = true; }

      const succ = successStatusForType(h.type);
      const fail = failStatusForType(h.type);
      const target = Math.max(1, Math.round(Number(safeObj(h.frequency).target) || 1));
      const unit = safeObj(h.frequency).unit;

      if (!h.logs[iso]){
        h.logs[iso] = {
          date: iso,
          status: fail,
          note: '',
          count: 0,
          auto: true,
          updatedAt: new Date().toISOString()
        };
        h.updatedAt = new Date().toISOString();
        changed = true;
      } else {
        const e = safeObj(h.logs[iso]);
        let c = Number(e.count);
        if (!Number.isFinite(c) || c < 0) c = (String(e.status || '').toLowerCase() === succ) ? 1 : 0;
        c = Math.round(c);

        // For day-unit, a success implies full target
        if (unit === 'day' && String(e.status || '').toLowerCase() === succ && c < target) c = target;

        if (e.count !== c) { h.logs[iso].count = c; changed = true; }
        if (typeof e.auto !== 'boolean') { h.logs[iso].auto = false; changed = true; }
      }
    }
  }

  const newLast = toISODate(todayD);
  if (ui.lastOpenISO !== newLast){
    ui.lastOpenISO = newLast;
    changed = true;
  }

  if (changed) saveData({ toast:false });
}


    /* =========================
       Actions
    ========================== */

    function toggleCreate(open){
      const next = (typeof open === 'boolean') ? open : !appData.ui.createOpen;
      appData.ui.createOpen = next;
      saveData({ toast:false });
      renderDashboard(); // re-render only dashboard for smoothness
      appData.ui.activeTab = 'dashboard';
      applyActiveTab();
      renderNavActive();
    }

    function toggleSound(){
      const enabled = appData.ui.soundEnabled !== false;
      appData.ui.soundEnabled = !enabled;
      saveData({ toast:false });
      updateSoundUI();
      showToast(appData.ui.soundEnabled ? 'Sound on' : 'Sound off', 'Completion chime updated.', { icon:'♪', ms:1800 });
      if (appData.ui.soundEnabled){
        unlockAudioContext();
        playSuccessChime();
      }
    }

    function setSoundStyle(style){
      const next = style === 'soft' ? 'soft' : 'bright';
      appData.ui.soundStyle = next;
      saveData({ toast:false });
      updateSoundStyleUI();
      showToast(`Sound: ${next}`, 'Completion chime style updated.', { icon:'♪', ms:1800 });
      if (appData.ui.soundEnabled) playSuccessChime();
    }

    function clearCreateFields(){
      // If create form exists, clear DOM fields only (state not used yet)
      const ids = ['c_name','c_type','c_desc','c_start','c_unit','c_target','c_ident','c_outcome','c_why'];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.tagName === 'SELECT') {
          if (id === 'c_type') el.value = 'positive';
          if (id === 'c_unit') el.value = 'day';
        } else if (el.type === 'date') {
          el.value = todayISO();
        } else if (el.type === 'number') {
          el.value = '1';
        } else {
          el.value = '';
        }
      });
      const err = $('#createErr');
      if (err) err.innerHTML = '';
    }

    function defaultCreateCopy(name, type, ident){
      const safeName = name || 'this habit';
      const isNeg = type === 'negative';
      const desc = `Show up for ${safeName}. Small is good.`;
      const outcome = isNeg
        ? 'More freedom and fewer impulse loops over time.'
        : 'More consistency and energy over time.';
      const why = ident
        ? `Because ${ident.replace(/^I am the kind of person who/i, 'I want to be the kind of person who').trim()}`
        : 'Because future-me deserves a calm, reliable system.';
      return { desc, outcome, why };
    }

    function validateCreate(){
      const name = ($('#c_name')?.value || '').trim();
      const type = ($('#c_type')?.value || 'positive').trim();
      const desc = ($('#c_desc')?.value || '').trim();
      const start = ($('#c_start')?.value || todayISO()).trim();
      const unit = ($('#c_unit')?.value || 'week').trim();
      const targetRaw = ($('#c_target')?.value || '1').trim();

      const ident = ($('#c_ident')?.value || '').trim();
      const outcome = ($('#c_outcome')?.value || '').trim();
      const why = ($('#c_why')?.value || '').trim();

      const errors = [];

      if (!name) errors.push('Habit name is required.');
      if (!parseISODate(start)) errors.push('Start date is invalid.');
      const target = Number(targetRaw);
      if (!Number.isFinite(target) || target <= 0) errors.push('Frequency target must be a positive number.');
      if (!['day','week','month'].includes(unit)) errors.push('Frequency unit is invalid.');
      if (!['positive','negative'].includes(type)) errors.push('Habit type is invalid.');

      if (!ident) errors.push('Identity is required.');

      return { ok: errors.length === 0, errors, value: { name, type, desc, start, unit, target: Math.round(target), ident, outcome, why } };
    }

    function createHabitFromForm(){
      if (appData.habits.length >= MAX_HABITS){
        showToast('Limit reached', `You can have up to ${MAX_HABITS} habits.`, { icon: '!' });
        return;
      }

      const v = validateCreate();
      const errBox = $('#createErr');

      if (!v.ok){
        if (errBox){
          errBox.innerHTML = `<div class="error"><strong>Please fix:</strong><ul style="margin:8px 0 0; padding-left:18px;">${v.errors.map(e => `<li>${escapeHtml(e)}</li>`).join('')}</ul></div>`;
        }
        showToast('Not saved', 'Some required fields are missing or invalid.', { icon:'!' });
        return;
      }

      const x = v.value;
      const defaults = defaultCreateCopy(x.name, x.type, x.ident);
      if (!x.desc) x.desc = defaults.desc;
      if (!x.outcome) x.outcome = defaults.outcome;
      if (!x.why) x.why = defaults.why;
      const habit = {
        id: uid(),
        name: x.name,
        type: x.type,
        description: x.desc,
        startDate: x.start,
        frequency: { unit: x.unit, target: x.target },
        motivator: { identity: x.ident, outcome: x.outcome, why: x.why },
        design: {
          loop: { cue:'', craving:'', response:'', reward:'' },
          laws: { obvious:'', attractive:'', easy:'', satisfying:'' },
          plan: {
            ifThen: '',
            cuePlan: '',
            twoMinute: '',
            friction: { removeCue:false, addDelay:false, addBarrier:false }
          }
        },
        logs: {
  [todayISO()]: {
    date: todayISO(),
    status: failStatusForType(x.type),
    note: '',
    count: 0,
    auto: true,
    updatedAt: new Date().toISOString()
  }
},

        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      appData.habits.push(habit);
      appData.ui.createOpen = false;
      saveData({ toast:true, toastMsg:'Habit created and ready to track.' });
      triggerHaptic('confirm');
      render(); // ensures habit appears immediately

      // Open the newly created habit for convenience
      requestAnimationFrame(() => {
        const det = document.getElementById(`habit-${habit.id}`);
        if (det && det.tagName === 'DETAILS'){
          det.open = true;
          appData.ui.habitSubtabs[habit.id] = 'track';
          saveData({ toast:false });
        }
      });
    }

    function deleteHabit(habitId){
      const h = getHabit(habitId);
      if (!h) return;

      const name = h.name || 'this habit';
      const msg = `Delete “${name}”?\n\nThis removes its logs and design notes from this device. Consider Export first.`;
      if (!confirm(msg)) return;

      triggerHaptic('danger');
      appData.habits = appData.habits.filter(x => x.id !== habitId);
      if (appData.ui.habitSubtabs) delete appData.ui.habitSubtabs[habitId];
      if (appData.ui?.activeHabitId === habitId){
        closeModal();
      }

      // remove review notes for this habit (optional hygiene)
      const rev = safeObj(appData.reviews);
      for (const wk of Object.keys(rev)){
        if (rev[wk]?.notes && rev[wk].notes[habitId]) delete rev[wk].notes[habitId];
      }

      saveData({ toast:true, toastMsg:'Habit deleted.' });
      render();
    }

    function saveHabit(habitId){
      const h = getHabit(habitId);
      if (!h) return;

      // enforce required motivator fields (since editable)
      const m = safeObj(h.motivator);
      const missing = [];
      if (!(String(m.identity||'').trim())) missing.push('Identity statement');
      if (!(String(m.outcome||'').trim())) missing.push('Long-term outcome');
      if (!(String(m.why||'').trim())) missing.push('Why this matters');

      if (missing.length){
        showToast('Not saved', `Missing required motivator: ${missing.join(', ')}`, { icon:'!' });
        // focus first missing
        const first = missing[0];
        const selector = first.startsWith('Identity') ? 'motivator.identity' : first.startsWith('Long') ? 'motivator.outcome' : 'motivator.why';
        const input = document.querySelector(`[data-habit="${cssEscape(habitId)}"][data-bind="${selector}"]`);
        if (input) input.focus();
        return;
      }

      h.updatedAt = new Date().toISOString();
      saveData({ toast:true, toastMsg:'Habit saved.' });
      triggerHaptic('confirm');
      updateHabitVisuals(habitId);
      hydrateVisibleCharts();
    }

    function setHabitSubtab(habitId, subtab){
      appData.ui = safeObj(appData.ui);
      if (!appData.ui.habitSubtabs) appData.ui.habitSubtabs = {};
      appData.ui.habitSubtabs[habitId] = subtab;
      saveData({ toast:false });

      // buttons
      $$(`[data-action="habitSubtab"][data-habit="${cssEscape(habitId)}"]`).forEach(btn => {
        const isActive = btn.getAttribute('data-subtab') === subtab;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        btn.setAttribute('tabindex', isActive ? '0' : '-1');
      });

      const titleBar = document.getElementById(`habit-${habitId}-titlebar`);
      if (titleBar){
        const label = habitSubtabLabel(subtab);
        const labelEl = titleBar.querySelector('span');
        if (labelEl) labelEl.textContent = label;
      }

      // panels
      ['track','design','insights','edit'].forEach(t => {
        const p = document.getElementById(`panel-${habitId}-${t}`);
        if (p) p.classList.toggle('hidden', t !== subtab);
      });

      if (subtab === 'insights'){
        const h = getHabit(habitId);
        const panel = document.getElementById(`panel-${habitId}-insights`);
        if (h && panel){
          panel.innerHTML = renderHabitInsightsPanel(h);
          const chartEl = document.getElementById(`habit-${habitId}-chart`);
          if (chartEl) renderChartSVG(h, chartEl, getInsightRangeKey(habitId));
        }
      }

      scrollHabitSectionToTop(habitId, subtab);
    }

    function scrollHabitSectionToTop(habitId, subtab){
      const panel = document.getElementById(`panel-${habitId}-${subtab}`);
      const body = document.getElementById('modalBody');
      const titleBar = document.getElementById(`habit-${habitId}-titlebar`);
      if (!body || (!panel && !titleBar)) return;
      const target = titleBar || panel;
      requestAnimationFrame(() => {
        const bodyRect = body.getBoundingClientRect();
        const targetRect = target.getBoundingClientRect();
        const bodyStyles = getComputedStyle(body);
        const targetStyles = getComputedStyle(target);
        const paddingTop = parseFloat(bodyStyles.paddingTop) || 0;
        const marginTop = parseFloat(targetStyles.marginTop) || 0;
        const targetTop = targetRect.top - bodyRect.top + body.scrollTop - marginTop;
        const nextScrollTop = Math.max(0, targetTop - paddingTop);
        body.scrollTo({ top: nextScrollTop, behavior: 'smooth' });
      });
    }

    function saveLog(habitId){
      const h = getHabit(habitId);
      if (!h) return;

      const det = document.getElementById(`habit-modal-${habitId}`) || document;
      const dateEl = det?.querySelector(`[data-track="date"][data-habit="${cssEscape(habitId)}"]`);
      const statusEl = det?.querySelector(`[data-track="status"][data-habit="${cssEscape(habitId)}"]`);
      const noteEl = det?.querySelector(`[data-track="note"][data-habit="${cssEscape(habitId)}"]`);

      const date = (dateEl?.value || '').trim();
      const status = (statusEl?.value || '').trim().toLowerCase();
      const note = String(noteEl?.value ?? '');

      if (!parseISODate(date)){
        showToast('Not saved', 'Please choose a valid date.', { icon:'!' });
        if (dateEl) dateEl.focus();
        return;
      }

      if (!isValidStatusForType(h.type, status)){
        showToast('Not saved', 'Please choose a valid status.', { icon:'!' });
        if (statusEl) statusEl.focus();
        return;
      }

      if (!h.logs || typeof h.logs !== 'object') h.logs = {};
      let count = 0;
const target = Math.max(1, Math.round(Number(safeObj(h.frequency).target) || 1));
if (safeObj(h.frequency).unit === 'day'){
  count = (status === successStatusForType(h.type)) ? target : 0;
} else {
  count = (status === successStatusForType(h.type)) ? 1 : 0;
}

h.logs[date] = { date, status, note, count, auto:false, updatedAt: new Date().toISOString() };

      h.updatedAt = new Date().toISOString();

      saveData({ toast:false });
      updateHabitVisuals(habitId);
      updateDashboardQuick(habitId);
      updateTodayCard({ animate:true });

      // update recent logs list without re-rendering whole app
      const list = document.getElementById(`habit-${habitId}-logslist`);
      if (list) list.innerHTML = renderRecentLogs(h);

      // also update chart if visible
      hydrateVisibleCharts();

      const succ = successStatusForType(h.type);
      if (status === succ){
        showToast('Done', motivationalLine(h), { icon:'✓', ms:5000 });
        triggerHaptic('confirm');
        pulseEl(document.querySelector(`button[data-action="dashToggle"][data-habit="${cssEscape(habitId)}"]`));
      } else {
        showToast('Logged', 'No shame. This is just data to improve the system.', { icon:'•', ms:2600 });
      }

      const focusList = document.getElementById('todayFocusList');
      if (list && $('#modal').classList.contains('active')){
        $('#modalBody').innerHTML = renderTodayFocusBody();
      }
    }

    function deleteLog(habitId, date){
      const h = getHabit(habitId);
      if (!h) return;
      if (!h.logs || typeof h.logs !== 'object' || !h.logs[date]) return;

      if (!confirm(`Delete log for ${date}?`)) return;

      triggerHaptic('danger');
      delete h.logs[date];
      h.updatedAt = new Date().toISOString();
      saveData({ toast:true, toastMsg:'Log deleted.' });
      updateHabitVisuals(habitId);
      updateTodayCard({ animate:true });

      const list = document.getElementById(`habit-${habitId}-logslist`);
      if (list) list.innerHTML = renderRecentLogs(h);

      hydrateVisibleCharts();
    }

    function clearLogInputs(habitId){
      const det = document.getElementById(`habit-modal-${habitId}`) || document;
      if (!det) return;
      const dateEl = det.querySelector(`[data-track="date"][data-habit="${cssEscape(habitId)}"]`);
      const statusEl = det.querySelector(`[data-track="status"][data-habit="${cssEscape(habitId)}"]`);
      const noteEl = det.querySelector(`[data-track="note"][data-habit="${cssEscape(habitId)}"]`);
      if (dateEl) dateEl.value = todayISO();
      if (statusEl){
        const h = getHabit(habitId);
        if (h) statusEl.value = failStatusForType(h.type);
      }
      if (noteEl) noteEl.value = '';
      showToast('Cleared', 'Fields cleared (no saved data changed).', { icon:'↺', ms:1800 });
    }

    function openModal(title, bodyHtml, footHtml='', options={}){
      const modal = $('#modal');
      lastModalFocus = document.activeElement;
      $('#modalTitle').textContent = title;
      $('#modalBody').innerHTML = bodyHtml;
      $('#modalFoot').innerHTML = footHtml;
      modal.classList.add('active');
      modal.classList.toggle('centered', !!options.centered);
      modal.setAttribute('aria-hidden','false');
      setAppAriaHidden(true);
      // focus first focusable
      setTimeout(() => {
        const focusable = getModalFocusable()[0];
        if (focusable) focusable.focus();
      }, 0);
    }

    function closeModal(){
      const modal = $('#modal');
      modal.classList.remove('active');
      modal.classList.remove('centered');
      modal.setAttribute('aria-hidden','true');
      setAppAriaHidden(false);
      if (appData.ui) appData.ui.activeHabitId = null;
      if (appData.ui?.wizard?.open){
        appData.ui.wizard.open = false;
        appData.ui.onboardingActive = false;
        saveData({ toast:false });
      }
    }

    function openExport(){
      const json = JSON.stringify(appData, null, 2);
      const body = `
        <div class="muted small" style="margin-bottom:10px;">
          Backup (recommended). This app runs offline; backups are your safety net.
        </div>
        <textarea id="exportText" readonly>${escapeHtml(json)}</textarea>
      `;
      const foot = `
        <button class="btn ghost" data-action="copyExport">Copy</button>
        <button class="btn primary" data-action="downloadExport">Download</button>
        <button class="btn ghost" data-action="closeModal">Done</button>
      `;
      openModal('Export JSON', body, foot);
    }

    function openImport(){
      const body = `
        <div class="muted small" style="margin-bottom:10px;">
          Paste exported JSON here. Import is validated. You can merge (keep existing) or replace.
        </div>
        <textarea id="importText" placeholder="Paste JSON…"></textarea>
        <div id="importErr" style="margin-top:10px;"></div>
      `;
      const foot = `
        <button class="btn ghost" data-action="closeModal">Cancel</button>
        <button class="btn ghost" data-action="importMerge">Merge</button>
        <button class="btn primary" data-action="importReplace">Replace</button>
      `;
      openModal('Import JSON', body, foot);
    }

    function validateImported(rawText){
      let parsed;
      try{
        parsed = JSON.parse(rawText);
      }catch(e){
        return { ok:false, error:'That isn’t valid JSON.' };
      }
      const normalized = normalizeData(parsed);


      // required: identity must be present (per habit)
      for (const h of normalized.habits){
        const m = safeObj(h.motivator);
        if (!String(m.identity||'').trim()){
          return { ok:false, error:`This import is missing an identity statement for habit “${h.name || 'Untitled'}”. Add one and try again.` };
        }
      }

      if (normalized.habits.length > MAX_HABITS){
        return { ok:false, error:`Import has ${normalized.habits.length} habits. Max is ${MAX_HABITS}.` };
      }

      return { ok:true, data: normalized };
    }

    function importData(mode){
      const text = $('#importText')?.value || '';
      const box = $('#importErr');
      const v = validateImported(text);
      if (!v.ok){
        if (box) box.innerHTML = `<div class="error">${escapeHtml(v.error)}</div>`;
        showToast('Import failed', v.error, { icon:'!' });
        return;
      }

      const incoming = v.data;

      if (mode === 'replace'){
        if (!confirm('Replace all existing data with this import?')) return;
        appData = incoming;
        // keep current tab
        appData.ui = appData.ui || {};
        appData.ui.activeTab = 'settings';
        saveData({ toast:true, toastMsg:'Import complete (replaced).' });
        triggerHaptic('confirm');
        closeModal();
        render();
        return;
      }

      // merge
      const byId = new Map(appData.habits.map(h => [h.id, h]));
      const byName = new Map(appData.habits.map(h => [String(h.name||'').toLowerCase(), h]));

      for (const h of incoming.habits){
        if (byId.has(h.id)){
          // merge fields, logs union (import wins)
          const cur = byId.get(h.id);
          cur.name = h.name;
          cur.type = h.type;
          cur.description = h.description;
          cur.startDate = h.startDate;
          cur.frequency = deepClone(h.frequency);
          cur.motivator = deepClone(h.motivator);
          cur.design = deepClone(h.design);
          cur.logs = Object.assign({}, safeObj(cur.logs), safeObj(h.logs));
          cur.updatedAt = new Date().toISOString();
        } else {
          // if same name exists, avoid duplicates by appending
          const key = String(h.name||'').toLowerCase();
          if (key && byName.has(key)){
            h.name = (h.name || 'Habit') + ' (imported)';
          }
          appData.habits.push(h);
          byId.set(h.id, h);
        }
      }

      // merge reviews (import wins)
      appData.reviews = Object.assign({}, safeObj(appData.reviews), safeObj(incoming.reviews));

      // enforce max
      if (appData.habits.length > MAX_HABITS){
        appData.habits = appData.habits.slice(0, MAX_HABITS);
      }

      saveData({ toast:true, toastMsg:'Import complete (merged).' });
      triggerHaptic('confirm');
      closeModal();
      render();
    }

    function clearAll(){
      const phrase = 'CLEAR';
      const ok = prompt(`Type ${phrase} to delete all data from this device:`);
      if (ok !== phrase) {
        showToast('Cancelled', 'Nothing was deleted.', { icon:'↺', ms:1800 });
        return;
      }
      triggerHaptic('danger');
      appData = normalizeData(null);
      saveData({ toast:true, toastMsg:'All data cleared.' });
      render();
    }

    function quickBackup(){
      openExport();
    }

    function copyToClipboard(text){
      // best effort
      if (navigator.clipboard && navigator.clipboard.writeText){
        return navigator.clipboard.writeText(text);
      }
      // fallback
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position='fixed';
      ta.style.left='-9999px';
      document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand('copy'); }catch(e){}
      document.body.removeChild(ta);
      return Promise.resolve();
    }

    function downloadText(filename, text){
      const blob = new Blob([text], { type:'application/json;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 2000);
    }

    function saveReview(weekISO){
      ensureReviewWeek(weekISO);
      saveData({ toast:false });
      showToast('Checkpoint saved', 'Weekly review saved. A calm checkpoint for the week.', { icon:'✓', ms:2600 });
      triggerHaptic('confirm');
    }

    function copyReviewPrompt(){
      const prompts =
`Weekly review prompts:
- Wins (any size)
- What did you learn (cues, friction, timing)?
- Next week: one system change
- Identity reinforcement

Per habit:
- What worked?
- What got in the way?
- One tweak for next week
- How did this support your identity?`;
      copyToClipboard(prompts).then(() => {
        showToast('Copied', 'Prompts copied to clipboard.', { icon:'⧉', ms:2000 });
      });
    }

    /* =========================
       Input Handling (Immediate Save)
    ========================== */

    function handleBoundInput(el){
      const habitId = el.getAttribute('data-habit');
      const path = el.getAttribute('data-bind');
      if (!habitId || !path) return;
      const h = getHabit(habitId);
      if (!h) return;

      let val = (el.type === 'checkbox') ? el.checked : el.value;

if (path === 'name'){
  const trimmed = String(val || '').trim();
  if (!trimmed){
    el.value = h.name || '';
    return;
  }
  val = trimmed;
}

if (path === 'description'){
  const trimmed = String(val || '').trim();
  if (!trimmed){
    el.value = h.description || '';
    return;
  }
  val = trimmed;
}

if (path === 'startDate'){
  const s = String(val || '').trim();
  if (!parseISODate(s)){
    el.value = h.startDate || todayISO();
    return;
  }
  val = s;
}


      // special cases: frequency target numeric
      if (path === 'frequency.target'){
        const n = Number(val);
        val = (Number.isFinite(n) && n > 0) ? Math.round(n) : 1;
        el.value = String(val);
      }

      if (path === 'frequency.unit'){
        const u = String(val);
        if (!['day','week','month'].includes(u)) return;
      }

      if (path === 'type'){
        const t = String(val);
        if (!['positive','negative'].includes(t)) return;
      }

      setByPath(h, path, val);
h.updatedAt = new Date().toISOString();
scheduleSave();

// If frequency changes, keep counts consistent with new unit/target
if (path === 'frequency.target' || path === 'frequency.unit'){
  normalizeLogCountsForFrequency(h);
  h.updatedAt = new Date().toISOString();
  scheduleSave();
  updateDashboardQuick(habitId);
}

// Refresh the expanded visuals when core settings change
if (path === 'frequency.target' || path === 'frequency.unit' || path === 'type'){
  updateHabitVisuals(habitId);
  hydrateVisibleCharts();
  updateTodayCard();
}

// Keep the collapsed summary header in sync (name/desc/freq)
if (path === 'name' || path === 'description' || path === 'frequency.target' || path === 'frequency.unit'){
  updateHabitHeader(habitId);
}

    }

function handleLogEdit(el){
  const habitId = el.getAttribute('data-habit');
  const date = el.getAttribute('data-logdate');
  const field = el.getAttribute('data-logfield');
  if (!habitId || !date || !field) return;

  const h = getHabit(habitId);
  if (!h) return;

  const succ = successStatusForType(h.type);
  const fail = failStatusForType(h.type);

  const unit = safeObj(h.frequency).unit;
  const target = Math.max(1, Math.round(Number(safeObj(h.frequency).target) || 1));

  if (!h.logs) h.logs = {};
  if (!h.logs[date]){
    h.logs[date] = {
      date,
      status: fail,
      note: '',
      count: 0,
      auto: true,
      updatedAt: new Date().toISOString()
    };
  }

  if (field === 'status'){
    const st = String(el.value || '').toLowerCase();
    if (!isValidStatusForType(h.type, st)) return;

    h.logs[date].status = st;
    h.logs[date].auto = false;
    h.logs[date].updatedAt = new Date().toISOString();

    // keep count consistent with unit + status
    if (unit === 'day'){
      h.logs[date].count = (st === succ) ? target : 0;
    } else {
      h.logs[date].count = (st === succ) ? 1 : 0;
    }

    h.updatedAt = new Date().toISOString();
    scheduleSave();

    updateHabitVisuals(habitId);
    updateDashboardQuick(habitId); // keeps the collapsed "Done/Undo/Reset" button correct if date is today
    updateTodayCard({ animate:true });
    hydrateVisibleCharts();
    const list = document.getElementById('todayFocusList');
    if (list && $('#modal').classList.contains('active')){
      $('#modalBody').innerHTML = renderTodayFocusBody();
    }
    return;
  }

  if (field === 'note'){
    h.logs[date].note = String(el.value ?? '');
    h.logs[date].auto = false;
    h.logs[date].updatedAt = new Date().toISOString();
    h.updatedAt = new Date().toISOString();
    scheduleSave();
    return;
  }
}


    function handleReviewInput(el){
      const weekISO = el.getAttribute('data-review-week');
      if (!weekISO || !/^\d{4}-\d{2}-\d{2}$/.test(weekISO)) return;

      ensureReviewWeek(weekISO);

      const globalKey = el.getAttribute('data-review-global');
      const habitId = el.getAttribute('data-review-habit');
      const bind = el.getAttribute('data-review-bind');

      if (globalKey){
        appData.reviews[weekISO].global[globalKey] = String(el.value ?? '');
        scheduleSave();
        return;
      }
      if (habitId && bind){
        if (!appData.reviews[weekISO].notes[habitId]) appData.reviews[weekISO].notes[habitId] = {};
        appData.reviews[weekISO].notes[habitId][bind] = String(el.value ?? '');
        scheduleSave();
      }
    }

    /* =========================
       Diagnostics / Self-checks
    ========================== */

    function runDiagnostics(){
      try{
        // Invariants
        const d = normalizeData(appData);
        if (d.version !== SCHEMA_VERSION) return { ok:false, summary:'Schema version mismatch.' };
        if (!Array.isArray(d.habits)) return { ok:false, summary:'Habits array missing.' };
        if (d.habits.length > MAX_HABITS) return { ok:false, summary:'Habit count exceeds limit.' };

        // Validate habits
        for (const h of d.habits){
          if (!h.id || !h.name) return { ok:false, summary:'A habit is missing id or name.' };
          if (!['positive','negative'].includes(h.type)) return { ok:false, summary:`Habit “${h.name}” has invalid type.` };
          const f = safeObj(h.frequency);
          if (!['day','week','month'].includes(f.unit)) return { ok:false, summary:`Habit “${h.name}” has invalid frequency unit.` };
          if (!Number.isFinite(Number(f.target)) || Number(f.target) <= 0) return { ok:false, summary:`Habit “${h.name}” has invalid target.` };
          const m = safeObj(h.motivator);
          if (!String(m.identity||'').trim()){
            return { ok:false, summary:`Habit “${h.name}” is missing an identity statement.` };
          }
          // logs validity
          const logs = safeObj(h.logs);
          for (const k of Object.keys(logs)){
            if (!/^\d{4}-\d{2}-\d{2}$/.test(k)) return { ok:false, summary:`Habit “${h.name}” has a malformed log date.` };
            const st = String(logs[k]?.status || '').toLowerCase();
            if (!isValidStatusForType(h.type, st)) return { ok:false, summary:`Habit “${h.name}” has an invalid log status.` };
          }
        }

        // Storage write/read check (non-destructive)
        const probeKey = STORAGE_KEY + '_probe';
        localStorage.setItem(probeKey, JSON.stringify({ t: Date.now() }));
        localStorage.removeItem(probeKey);

        return { ok:true, summary:'State shape, motivators, logs, and storage access look good.' };
      }catch(e){
        return { ok:false, summary:'Diagnostics failed due to an unexpected error.' };
      }
    }

    /* =========================
       Event Wiring
    ========================== */

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-action]');
      if (!btn) return;

      const action = btn.getAttribute('data-action');

      handleActionHaptic(action);
      unlockAudioContext();

      if (action === 'startOnboarding'){
        e.preventDefault();
        appData.ui.onboardingActive = true;
        openWizard('onboarding');
        return;
      }

      if (action === 'startCreateWizard'){
        e.preventDefault();
        openWizard('create');
        return;
      }

      if (action === 'wizardSetType'){
        const value = btn.getAttribute('data-value') || 'positive';
        updateWizardDraft('type', value);
        renderWizardModal();
        return;
      }

      if (action === 'wizardSuggestTarget'){
        const value = Number(btn.getAttribute('data-value') || 1);
        updateWizardDraft('frequency.target', value);
        renderWizardModal();
        return;
      }

      if (action === 'wizardBack'){
        wizardBack();
        return;
      }

      if (action === 'wizardNext'){
        wizardNext();
        return;
      }

      if (action === 'wizardFinish'){
        wizardFinish(false);
        return;
      }

      if (action === 'wizardLogFirst'){
        wizardFinish(true);
        return;
      }

if (action === 'openHabitDetail'){
  e.preventDefault();
  const hid = btn.getAttribute('data-habit');
  if (!hid) return;
  openHabitDetail(hid);
  return;
}

if (action === 'dashToggle'){
  e.preventDefault();
  e.stopPropagation();
  const hid = btn.getAttribute('data-habit');
  if (!hid) return;
  dashToggle(hid);
  return;
}

if (action === 'adjustCount'){
  e.preventDefault();
  e.stopPropagation();
  const hid = btn.getAttribute('data-habit');
  const delta = Number(btn.getAttribute('data-delta') || 0);
  if (!hid || !delta) return;
  adjustDailyCount(hid, delta);
  return;
}

if (action === 'openTodayFocus'){
  e.preventDefault();
  openTodayFocus();
  return;
}

if (action === 'celebrateDay'){
  e.preventDefault();
  celebrateDay();
  return;
}

if (action === 'createTemplate'){
  e.preventDefault();
  const key = btn.getAttribute('data-template');
  createHabitFromTemplate(key);
  return;
}

if (action === 'dismissReviewNudge'){
  const wk = btn.getAttribute('data-week');
  appData.ui.reviewNudgeDismissed = wk;
  saveData({ toast:false });
  renderDashboard();
  return;
}

if (action === 'jumpToPlan'){
  const hid = btn.getAttribute('data-habit');
  if (!hid) return;
  openHabitDetail(hid, 'design');
  if (det && det.tagName === 'DETAILS') det.open = true;
  setHabitSubtab(hid, 'design');
  return;
}

if (action === 'useShield'){
  const hid = btn.getAttribute('data-habit');
  const date = btn.getAttribute('data-date');
  if (hid && date) useShield(hid, date);
  return;
}

if (action === 'toggleRecentLogs'){
  e.preventDefault();
  e.stopPropagation();

  const hid = btn.getAttribute('data-habit');
  if (!hid) return;

  appData.ui = safeObj(appData.ui);
  appData.ui.recentOpen = safeObj(appData.ui.recentOpen);

  const next = !appData.ui.recentOpen[hid];
  appData.ui.recentOpen[hid] = next;
  saveData({ toast:false });

  const body = document.getElementById(`recent-${hid}`);
  const b = document.getElementById(`recentBtn-${hid}`);
  if (body) body.hidden = !next;
  if (b){
    b.setAttribute('aria-expanded', next ? 'true' : 'false');
    b.textContent = next ? 'Hide' : 'Show';
  }
  return;
}

if (action === 'setInsightRange'){
  e.preventDefault();
  e.stopPropagation();

  const hid = btn.getAttribute('data-habit');
  const rk = btn.getAttribute('data-range');
  if (!hid || !INSIGHT_RANGES[rk]) return;

  appData.ui = safeObj(appData.ui);
  appData.ui.insightsRange = safeObj(appData.ui.insightsRange);
  appData.ui.insightsRange[hid] = rk;
  saveData({ toast:false });

  const h = getHabit(hid);
  const panel = document.getElementById(`panel-${hid}-insights`);
  if (h && panel){
    panel.innerHTML = renderHabitInsightsPanel(h);
    const chartEl = document.getElementById(`habit-${hid}-chart`);
    if (chartEl) renderChartSVG(h, chartEl, rk);
  }
  return;
}

if (action === 'addFrictionItem'){
  e.preventDefault();
  const hid = btn.getAttribute('data-habit');
  if (!hid) return;
  addFrictionItem(hid);
  return;
}

if (action === 'removeFrictionItem'){
  e.preventDefault();
  const hid = btn.getAttribute('data-habit');
  const idx = Number(btn.getAttribute('data-index'));
  if (!hid) return;
  removeFrictionItem(hid, idx);
  return;
}

      if (action === 'switchTab'){
        const tab = btn.getAttribute('data-tab');
        if (!tab) return;
        appData.ui.activeTab = tab;
        saveData({ toast:false });
        applyActiveTab();
        renderNavActive();
        // If switching to dashboard, ensure charts can render after any open details
        if (tab === 'dashboard') setTimeout(hydrateVisibleCharts, 0);
        return;
      }

      if (action === 'toggleCreate'){
        toggleCreate();
        return;
      }

      if (action === 'toggleSound'){
        toggleSound();
        return;
      }

      if (action === 'setSoundStyle'){
        const style = btn.getAttribute('data-style');
        setSoundStyle(style);
        return;
      }

      if (action === 'cancelCreate'){
        toggleCreate(false);
        clearCreateFields();
        showToast('Cancelled', 'Nothing was saved.', { icon:'↺', ms:1800 });
        return;
      }

      if (action === 'saveCreate'){
        createHabitFromForm();
        return;
      }

      if (action === 'habitSubtab'){
        const hid = btn.getAttribute('data-habit');
        const sub = btn.getAttribute('data-subtab');
        if (!hid || !sub) return;
        setHabitSubtab(hid, sub);
        return;
      }

      if (action === 'saveHabit'){
        const hid = btn.getAttribute('data-habit');
        if (!hid) return;
        saveHabit(hid);
        return;
      }

      if (action === 'deleteHabit'){
        const hid = btn.getAttribute('data-habit');
        if (!hid) return;
        deleteHabit(hid);
        return;
      }

      if (action === 'saveLog'){
        const hid = btn.getAttribute('data-habit');
        if (!hid) return;
        saveLog(hid);
        return;
      }

      if (action === 'deleteLog'){
        const hid = btn.getAttribute('data-habit');
        const date = btn.getAttribute('data-date');
        if (!hid || !date) return;
        deleteLog(hid, date);
        return;
      }

      if (action === 'clearLogInputs'){
        const hid = btn.getAttribute('data-habit');
        if (!hid) return;
        clearLogInputs(hid);
        return;
      }

      if (action === 'openExport'){
        openExport();
        return;
      }

      if (action === 'openImport'){
        openImport();
        return;
      }

      if (action === 'closeModal'){
        closeModal();
        return;
      }

      if (action === 'importMerge'){
        importData('merge');
        return;
      }

      if (action === 'importReplace'){
        importData('replace');
        return;
      }

      if (action === 'copyExport'){
        const text = $('#exportText')?.value || '';
        copyToClipboard(text).then(() => showToast('Copied', 'JSON copied to clipboard.', { icon:'⧉', ms:2000 }));
        return;
      }

      if (action === 'downloadExport'){
        const text = $('#exportText')?.value || '';
        const filename = `quiet-habits-backup-${todayISO()}.json`;
        downloadText(filename, text);
        showToast('Downloaded', 'Backup saved as a file.', { icon:'↓', ms:2000 });
        return;
      }

      if (action === 'clearAll'){
        clearAll();
        return;
      }

      if (action === 'quickBackup'){
        quickBackup();
        return;
      }

      if (action === 'saveReview'){
        const wk = btn.getAttribute('data-week');
        if (!wk) return;
        saveReview(wk);
        return;
      }

      if (action === 'copyReviewPrompt'){
        copyReviewPrompt();
        return;
      }

      if (action === 'shiftWeek'){
        const dir = Number(btn.getAttribute('data-dir') || '0');
        if (!dir) return;
        shiftReviewWeek(dir);
        return;
      }
    });

    // Click outside modal to close
    $('#modal').addEventListener('click', (e) => {
      if (e.target === $('#modal')) closeModal();
    });

    // Input auto-save delegation
    document.addEventListener('input', (e) => {
      const el = e.target;
      if (!(el instanceof HTMLElement)) return;

      if (el.getAttribute('data-action') === 'wizardInput'){
        const field = el.getAttribute('data-field');
        if (!field) return;
        updateWizardDraft(field, el.value);
        return;
      }

      if (el.hasAttribute('data-friction-index') && el.hasAttribute('data-habit')){
        handleFrictionInput(el);
        return;
      }

      if (el.hasAttribute('data-bind')){
        handleBoundInput(el);
        return;
      }

      if (el.hasAttribute('data-logdate') && el.hasAttribute('data-logfield') && el.hasAttribute('data-habit')){
        handleLogEdit(el);
        return;
      }

      if (el.hasAttribute('data-review-week')){
        handleReviewInput(el);
        return;
      }
    });

    // When a habit opens, render chart if insights active (lazy)
    document.addEventListener('change', (e) => {
      const el = e.target;
      if (!(el instanceof HTMLElement)) return;
      if (el.getAttribute('data-action') === 'wizardInput'){
        const field = el.getAttribute('data-field');
        if (!field) return;
        updateWizardDraft(field, el.value);
      }
    });

    // ESC closes modal
    document.addEventListener('keydown', (e) => {
      if (!$('#modal').classList.contains('active')){
        if (e.key === 'Enter' || e.key === ' '){
          const card = e.target.closest?.('.habitItem[data-action="openHabitDetail"]');
          if (card){
            e.preventDefault();
            const hid = card.getAttribute('data-habit');
            if (hid) openHabitDetail(hid);
        return;
      }

      if (e.key === 'Escape'){
        closeModal();
        return;
      }
      if (e.key === 'Tab'){
        const focusable = getModalFocusable();
        if (!focusable.length) return;
        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        if (e.shiftKey && document.activeElement === first){
          e.preventDefault();
          last.focus();
        } else if (!e.shiftKey && document.activeElement === last){
          e.preventDefault();
          first.focus();
        }
          }
        }
      }
    });

    /* =========================
       Initial render & sanity
    ========================== */

    function initialSelfSanity(){
      // Non-destructive sanity checks to avoid common failures.
      // 1) Ensure we can save & reload shape
      const before = JSON.stringify(appData);
      saveData({ toast:false });
      const re = loadData();
      if (!re || re.version !== SCHEMA_VERSION) {
        showToast('Warning', 'Storage may be blocked; persistence could fail.', { icon:'!' });
        appData.ui.storageWarning = true;
      }
      // restore appData (in memory) from before to avoid unexpected mutation
      try{ appData = normalizeData(JSON.parse(before)); }catch(e){ appData = normalizeData(null); }
    }

    function initPWA(){
      if (!('serviceWorker' in navigator)) return;
      if (!window.isSecureContext) return;
      navigator.serviceWorker.register('./sw.js').catch(() => {});
    }

    initialSelfSanity();
    initPWA();
    initAudioUnlock();
    ensureDefaultLogsUpToToday();
    render();

    // Ensure active tab in UI is applied, and charts can load for any open details.
    setTimeout(() => {
      applyActiveTab();
      renderNavActive();
      hydrateVisibleCharts();
    }, 0);
    
  })();
  </script>
</body>
